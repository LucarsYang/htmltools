<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>班級學員分數管理</title>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- CSS 直接寫在 <style> 中 -->
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f4f4f4;
            margin: 0; padding: 0;
        }
        h2 { margin-top:20px; margin-bottom:10px; }

        .toolbar {
            display: flex; flex-wrap: wrap; justify-content: center; gap:10px;
            margin-bottom:10px; align-items:center;
        }
        button {
            margin:5px; padding:8px; cursor:pointer; border:none; border-radius:5px;
            background-color:#4caf50; color:white;
        }
        button:hover { opacity:0.9; }
        #login-btn { background:#4caf50; }
        #logout-btn { background:#ff4d4d; }
        #btn-add-student { background:#2196f3; }
        #btn-export-csv  { background:#ff9800; }
        #btn-manage-classes { background:#9c27b0; }
        #btn-manual-sync { background:#d32f2f; } /* 手動同步按鈕 */

        #classSelect {
            margin:5px; padding:5px; border-radius:5px;
        }

        /* 三狀態: 有異動/更新中/已同步 */
        #syncStatusBar {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 5px 10px;
            border-radius: 5px;
            background: #f5f5f5;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #syncStatusBar:hover {
            background: #e0e0e0;
        }
        #syncStatusBar.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .red    { color:red;    }
        .yellow { color:#FFC107;}
        .green  { color:green;  }
        .grey   { color:#aaa;   }

        .container {
            display:flex; flex-wrap:wrap; justify-content:center; gap:20px;
            margin-top:20px; padding-bottom:30px;
        }
        .student-card {
            width:180px; border:1px solid #ccc; background:white;
            padding:10px; text-align:center; border-radius:10px;
            box-shadow:2px 2px 10px rgba(0,0,0,0.1);
        }
        .student-card img { width:80px; height:80px; cursor:pointer; }
        .btn-score {
            background:#8bc34a; color:#fff; border-radius:3px; margin:2px;
        }
        .btn-edit {
            background:#ffa500; color:white; margin:5px 2px;
        }
        .btn-delete {
            background:#ff4d4d; color:white; margin:5px 2px;
        }
        .quickAdjust { margin-top:5px; }
        .quickAdjust select, .quickAdjust input { margin-right:5px; }

        /* 登入 or 離線 遮罩 & 彈窗 */
        .login-overlay, .overlay, .class-overlay, .login-processing-overlay,
        .sync-overlay {
            display:none;
            position:fixed; top:0; left:0;
            width:100%; height:100%;
            background:rgba(0,0,0,0.5);
            z-index:10;
        }
        .login-overlay.show, .overlay.show, .class-overlay.show,
        .login-processing-overlay.show, .sync-overlay.show {
            display:block;
        }
        .login-popup, .popup, .class-popup, .login-processing-popup, .sync-popup {
            display:none;
            position:fixed; top:50%; left:50%;
            transform:translate(-50%,-50%);
            background:white; padding:20px; border-radius:10px; text-align:center; width:320px;
            box-shadow:2px 2px 10px rgba(0,0,0,0.3); z-index:20; opacity:0; transition:opacity 0.3s;
        }
        .login-popup.show, .popup.show, .class-popup.show,
        .login-processing-popup.show, .sync-popup.show {
            display:block; opacity:1;
        }
        .popup input, .popup select,
        .class-popup button, .login-popup button, .login-processing-popup button {
            margin-top:10px; padding:8px;
        }
        .popup button, .class-popup button, .login-processing-popup button {
            margin-top:10px; padding:8px 12px;
        }
        .image-preview {
            display:flex; justify-content:center; gap:10px; margin-top:10px; flex-wrap:wrap;
        }
        .image-preview img {
            width:50px; height:50px; cursor:pointer; border:2px solid transparent; border-radius:5px; box-sizing:border-box;
        }
        .image-preview img.selected { border:2px solid #2196f3; }

        .login-popup .warn {
            margin-top:10px; font-size:14px; color:#f44336;
        }

        .class-list { text-align:left; margin-top:10px; }
        .class-item {
            display:flex; align-items:center; justify-content:space-between;
            margin:5px 0; padding:5px; background:#f9f9f9; border-radius:5px;
        }
        .class-name { font-weight:bold; margin-right:10px; }
        .class-item button {
            margin:5px; font-size:14px;
        }
        .btn-rename { background:#ff9800; }
        .btn-delete-class { background:#f44336; }
    </style>
</head>
<body>
<h2>多班級管理 - 國小學員分數管理 (三狀態 + 手動同步 + 單檔 + 僅更新中阻擋)</h2>

<div class="toolbar">
    <button id="login-btn"  style="display:none;">登入 Google</button>
    <button id="logout-btn" style="display:none;">登出</button>
    <select id="classSelect" style="display:none;"></select>
    <button id="btn-manage-classes" style="display:none;">班級管理</button>
    <button id="btn-add-student" style="display:none;">新增學生</button>
    <button id="btn-export-csv"  style="display:none;">匯出 CSV</button>
    <input type="file" id="importCSV" accept=".csv" style="display:none;" />

    <!-- 三個狀態指示 -->
    <div id="syncStatusBar">
        <span id="statusDirty"    class="grey">有異動</span>
        <span id="statusUpdating" class="grey">更新中</span>
        <span id="statusSynced"   class="grey">已同步</span>
    </div>
</div>

<!-- 登入 or 離線 遮罩 & 彈窗 -->
<div class="login-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
    <h3>請選擇登入方式</h3>
    <p>若不登入，系統僅使用本地資料(離線模式)。</p>
    <button id="btnLoginNow" style="background:#4caf50;">登入 Google</button>
    <button id="btnOffline"  style="background:#9e9e9e;">離線模式</button>
    <p class="warn">注意：之後登入 Google 可能會覆蓋本地資料</p>
</div>

<!-- 登入處理中: 遮罩 + popup -->
<div class="login-processing-overlay" id="loginProcessingOverlay"></div>
<div class="login-processing-popup" id="loginProcessingPopup">
    <h3>登入中，請稍候...</h3>
    <p>如關閉 Google 彈窗或登入失敗，將回到登入選擇。</p>
</div>

<!-- 新增/編輯學生 -->
<div class="overlay" id="overlay"></div>
<div class="popup" id="studentPopup">
    <h3 id="popupTitle">新增學生</h3>
    <input type="text"   id="studentName"  placeholder="輸入姓名" />
    <input type="number" id="studentScore" placeholder="輸入分數" min="0" />
    <select id="studentGender">
        <option value="男">男生</option>
        <option value="女">女生</option>
    </select>
    <div class="image-preview" id="imageSelection"></div>
    <br />
    <button id="btnSaveStudent" style="background:#4caf50;">儲存</button>
    <button id="btnClosePopup" style="background:#757575;">取消</button>
</div>

<!-- 班級管理視窗 -->
<div class="class-overlay" id="classOverlay"></div>
<div class="class-popup" id="classPopup">
    <h3>班級管理</h3>
    <button id="btnAddClass" style="background:#4caf50;">新增班級</button>
    <div class="class-list" id="classList"></div>
    <button id="btnCloseClassPopup" style="background:#757575;">關閉</button>
</div>

<!-- 學生卡片容器 -->
<div class="container" id="studentContainer"></div>

<!-- 同步中 遮罩 + popup -->
<div class="sync-overlay" id="syncOverlay"></div>
<div class="sync-popup" id="syncPopup">
    <h3>資料同步中，請稍後...</h3>
</div>

<!-- 一切邏輯集中到一個 <script type="module"> -->
<script type="module">
    // ======== [1] GoogleAuth - 單檔: OAuth ========
    const googleAuth = (function(){
        let accessToken = localStorage.getItem("googleAccessToken") || null;
        let isGoogleSignedIn = !!accessToken;
        let tokenClient = null;

        function initGoogleAuth(onSuccess, onFailure){
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id:"310618779783-ephi24bku6psi9c7c1babi0v1n7fu8u9.apps.googleusercontent.com",
                scope:"https://www.googleapis.com/auth/drive.file",
                callback:(resp)=>{
                    if(resp.error){
                        if(onFailure) onFailure(resp.error);
                    } else {
                        // 成功
                        accessToken = resp.access_token;
                        localStorage.setItem("googleAccessToken", accessToken);
                        isGoogleSignedIn = true;
                        if(onSuccess) onSuccess();
                    }
                }
            });
        }
        function signIn(){
            if(!tokenClient) { console.warn("tokenClient未初始化"); return; }
            tokenClient.requestAccessToken();
        }
        function signOut(cb){
            if(!accessToken){
                if(cb) cb();
                return;
            }
            google.accounts.oauth2.revoke(accessToken,()=>{
                accessToken = null;
                isGoogleSignedIn = false;
                localStorage.removeItem("googleAccessToken");
                if(cb) cb();
            });
        }
        function getAccessToken(){ return accessToken; }
        function getIsSignedIn(){ return isGoogleSignedIn; }

        return {
            initGoogleAuth, signIn, signOut, getAccessToken, getIsSignedIn
        };
    })();

    // ======== [2] GoogleDrive - 單檔: 讀/寫 Drive ========
    const googleDrive = (function(){
        async function loadDriveFile(fileName){
            if(!googleAuth.getIsSignedIn()) return null;
            let token=googleAuth.getAccessToken();

            let listRes=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${fileName}'&spaces=drive&fields=files(id,name)`,{
                headers:{"Authorization":`Bearer ${token}`}
            });
            if(!listRes.ok) throw new Error("List Error "+listRes.status);
            let listData=await listRes.json();
            if(!listData.files || listData.files.length===0){
                // not found
                return null;
            }
            let fileId=listData.files[0].id;

            let getRes=await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,{
                headers:{"Authorization":`Bearer ${token}`}
            });
            if(!getRes.ok) throw new Error("Get Error "+getRes.status);
            let content=await getRes.text();
            return JSON.parse(content);
        }

        async function saveDriveFile(fileName, dataObj){
            if(!googleAuth.getIsSignedIn()) throw new Error("尚未登入Google");
            let token=googleAuth.getAccessToken();

            let listRes=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${fileName}'&spaces=drive&fields=files(id,name)`,{
                headers:{"Authorization":`Bearer ${token}`}
            });
            if(!listRes.ok) throw new Error("List Error "+listRes.status);
            let listData=await listRes.json();
            let fileId=(listData.files && listData.files.length>0)? listData.files[0].id:null;

            let fileMetadata={ name:fileName, mimeType:"application/json" };
            let fileContent=new Blob([JSON.stringify(dataObj)],{ type:"application/json" });
            let form=new FormData();
            form.append("metadata", new Blob([JSON.stringify(fileMetadata)],{ type:"application/json"}));
            form.append("file", fileContent);

            let url=fileId
                ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`
                : "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart";
            let method=fileId?"PATCH":"POST";

            let uploadRes=await fetch(url,{
                method,
                headers:{"Authorization":`Bearer ${token}`},
                body:form
            });
            if(!uploadRes.ok) throw new Error("Upload Error "+uploadRes.status);
            await uploadRes.json();
        }

        return {
            loadDriveFile, saveDriveFile
        };
    })();

    // ======== [3] 主程式 students.js ========

    // 全域狀態
    let classes = JSON.parse(localStorage.getItem("classes")) || { "一班":[] };
    let currentClass = Object.keys(classes)[0] || "一班";

    let updatingState = false; // true表示「更新中(黃)」階段 => 阻擋操作
    let editIndex = -1;
    let selectedImage = "";

    // 新增自動同步相關變數
    let autoSyncTimer = null;
    const AUTO_SYNC_DELAY = 30; // 30秒
    let remainingSeconds = 0;

    // 性別->圖片
    const imageMap = {
        "男1":"https://img.icons8.com/?size=100&id=oqlkrpDy3clZ&format=png&color=000000",
        "男2":"https://img.icons8.com/?size=100&id=C3wj6TWvegSk&format=png&color=000000",
        "男3":"https://img.icons8.com/?size=100&id=2lwL3N2H9Tbm&format=png&color=000000",
        "女1":"https://img.icons8.com/?size=100&id=eNAHQgRxtqVv&format=png&color=000000",
        "女2":"https://img.icons8.com/?size=100&id=DH9FJ32siusV&format=png&color=000000",
        "女3":"https://img.icons8.com/?size=100&id=gvFfuFtdrY7s&format=png&color=000000"
    };
    const genderImageLabels={
        "男":["男1","男2","男3"],
        "女":["女1","女2","女3"]
    };

    // 修改狀態相關函數
    function markDirty(){
        document.getElementById("statusDirty").className = "red";
        document.getElementById("statusUpdating").className = "grey";
        document.getElementById("statusSynced").className = "grey";
        document.getElementById("syncStatusBar").title = "點擊進行同步";
        updatingState = false;
        hideSyncOverlay();
        enableSyncBar();
        startAutoSyncTimer(); // 開始倒數
    }

    function markUpdating(){
        document.getElementById("statusDirty").className = "grey";
        document.getElementById("statusUpdating").className = "yellow";
        document.getElementById("statusSynced").className = "grey";
        document.getElementById("syncStatusBar").title = "同步處理中...";
        updatingState = true;
        showSyncOverlay();
        disableSyncBar();
        stopAutoSyncTimer(); // 停止倒數
    }

    function markSynced(){
        document.getElementById("statusDirty").className = "grey";
        document.getElementById("statusUpdating").className = "grey";
        document.getElementById("statusSynced").className = "green";
        document.getElementById("syncStatusBar").title = "資料已同步";
        updatingState = false;
        hideSyncOverlay();
        enableSyncBar();
        stopAutoSyncTimer(); // 停止倒數
    }

    // 新增自動同步相關函數
    function startAutoSyncTimer() {
        // 如果未登入 Google，不啟動計時器
        if (!googleAuth.getIsSignedIn()) return;
        
        // 清除現有計時器
        stopAutoSyncTimer();
        
        // 設定初始倒數時間
        remainingSeconds = AUTO_SYNC_DELAY;
        updateSyncStatus();
        
        // 啟動新計時器
        autoSyncTimer = setInterval(() => {
            remainingSeconds--;
            updateSyncStatus();
            
            // 時間到，執行同步
            if (remainingSeconds <= 0) {
                clearInterval(autoSyncTimer);
                autoSyncTimer = null;
                performSync();
            }
        }, 1000);
    }

    function stopAutoSyncTimer() {
        if (autoSyncTimer) {
            clearInterval(autoSyncTimer);
            autoSyncTimer = null;
        }
        remainingSeconds = 0;
    }

    function updateSyncStatus() {
        let statusBar = document.getElementById("syncStatusBar");
        if (remainingSeconds > 0) {
            statusBar.title = `點擊同步 (${remainingSeconds}秒後自動同步)`;
            // 更新狀態文字
            document.getElementById("statusDirty").textContent = `有異動 (${remainingSeconds}s)`;
        } else {
            statusBar.title = "點擊進行同步";
            document.getElementById("statusDirty").textContent = "有異動";
        }
    }

    // 新增執行同步的函數
    function performSync() {
        // 檢查是否可以同步
        if (!googleAuth.getIsSignedIn()) {
            alert("尚未登入 Google");
            return;
        }
        if (updatingState) {
            alert("同步處理中，請稍候...");
            return;
        }
        
        // 執行同步
        markUpdating();
        googleDrive.saveDriveFile("classes.json", classes)
            .then(() => {
                markSynced();
            })
            .catch(err => {
                console.error("儲存失敗:", err);
                markDirty();
                alert("同步失敗，請稍後再試");
            });
    }

    // 新增狀態列啟用/禁用函數
    function enableSyncBar() {
        let bar = document.getElementById("syncStatusBar");
        bar.classList.remove("disabled");
    }

    function disableSyncBar() {
        let bar = document.getElementById("syncStatusBar");
        bar.classList.add("disabled");
    }

    // 更新中時顯示遮罩
    function showSyncOverlay(){
        document.getElementById("syncOverlay").classList.add("show");
        document.getElementById("syncPopup").classList.add("show");
    }
    function hideSyncOverlay(){
        document.getElementById("syncOverlay").classList.remove("show");
        document.getElementById("syncPopup").classList.remove("show");
    }

    // 檢查是否更新中(黃)
    function checkIfUpdating(){
        if(updatingState){
            alert("目前正在『更新中』，請稍後再操作。");
            return true;
        }
        return false;
    }

    // onload
    window.onload = () => {
        hideMainButtons();
        
        // 檢查是否已有 token
        if(googleAuth.getIsSignedIn()){
            showMainButtons();
            markSynced();
            loadClassesFromDrive();
        } else {
            showLoginChoice();
        }

        // 初始化 googleAuth
        googleAuth.initGoogleAuth(
            ()=>{
                // onSuccess
                hideLoginProcessingOverlay();
                console.log("Google登入成功!");
                document.getElementById("login-btn").style.display = "none";
                document.getElementById("logout-btn").style.display = "inline-block";
                markSynced();
                loadClassesFromDrive();
            },
            (err)=>{
                // onFailure
                hideLoginProcessingOverlay();
                console.log("Google登入失敗:",err);
                localStorage.removeItem("googleAccessToken"); // 移除無效的 token
                backToLoginChoice();
            }
        );

        initUI();
        renderClassDropdown();
        renderStudents();
    };

    // 初始化UI事件
    function initUI(){
        // 登入/登出
        document.getElementById("login-btn").addEventListener("click",()=>{
            showLoginProcessingOverlay();
            googleAuth.signIn();
        });
        document.getElementById("logout-btn").addEventListener("click",handleLogout);

        // 班級
        let sel=document.getElementById("classSelect");
        sel.addEventListener("change",(evt)=>{
            if(checkIfUpdating()){ evt.target.value=currentClass; return; }
            currentClass=evt.target.value;
            renderStudents();
        });
        document.getElementById("btn-manage-classes").addEventListener("click",()=>{
            if(checkIfUpdating()) return;
            showClassPopup();
        });

        // 學生
        document.getElementById("btn-add-student").addEventListener("click",()=>{
            if(checkIfUpdating()) return;
            showPopup(-1);
        });
        document.getElementById("btn-export-csv").addEventListener("click",()=>{
            if(checkIfUpdating()) return;
            exportCSV();
        });
        document.getElementById("importCSV").addEventListener("change",(evt)=>{
            if(checkIfUpdating()){
                evt.target.value="";
                return;
            }
            importCSV(evt);
        });

        // 點擊狀態列觸發同步
        let syncBar = document.getElementById("syncStatusBar");
        syncBar.addEventListener("click", () => {
            // 檢查是否需要同步
            let isDirty = document.getElementById("statusDirty").className === "red";
            if (!isDirty) {
                alert("資料已是最新狀態");
                return;
            }
            
            performSync();
        });

        // 學生popup
        document.getElementById("btnSaveStudent").addEventListener("click",saveStudent);
        document.getElementById("btnClosePopup").addEventListener("click",closePopup);
        window.addEventListener("keydown",(evt)=>{
            if(evt.key==="Escape") closePopup();
        });

        // 登入/離線popup
        document.getElementById("btnLoginNow").addEventListener("click",()=>{
            closeLoginChoice();
            showMainButtons();
            markDirty();
            showLoginProcessingOverlay();
            googleAuth.signIn();
        });
        document.getElementById("btnOffline").addEventListener("click",()=>{
            closeLoginChoice();
            showMainButtons();
            markDirty();
            alert("離線模式啟用，之後登入Google可能覆蓋資料。");
        });

        // 班級管理
        document.getElementById("btnAddClass").addEventListener("click",addClassPrompt);
        document.getElementById("btnCloseClassPopup").addEventListener("click",closeClassPopup);
    }

    // 登出
    function handleLogout(){
        if(!googleAuth.getAccessToken()){
            alert("尚未登入");
            return;
        }
        stopAutoSyncTimer(); // 停止自動同步計時器
        googleAuth.signOut(()=>{
            console.log("已登出");
            hideMainButtons();
            backToLoginChoice();
        });
    }

    // 顯示/隱藏主功能按鈕
    function hideMainButtons(){
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("logout-btn").style.display = "none";
        document.getElementById("classSelect").style.display = "none";
        document.getElementById("btn-manage-classes").style.display = "none";
        document.getElementById("btn-add-student").style.display = "none";
        document.getElementById("btn-export-csv").style.display = "none";
        document.getElementById("importCSV").style.display = "none";
    }
    function showMainButtons(){
        let isSigned = googleAuth.getIsSignedIn();
        document.getElementById("login-btn").style.display = isSigned ? "none" : "inline-block";
        document.getElementById("logout-btn").style.display = isSigned ? "inline-block" : "none";
        document.getElementById("classSelect").style.display = "inline-block";
        document.getElementById("btn-manage-classes").style.display = "inline-block";
        document.getElementById("btn-add-student").style.display = "inline-block";
        document.getElementById("btn-export-csv").style.display = "inline-block";
        document.getElementById("importCSV").style.display = "inline-block";
    }

    // 登入選擇視窗
    function showLoginChoice(){
        document.getElementById("loginOverlay").classList.add("show");
        document.getElementById("loginPopup").classList.add("show");
    }
    function closeLoginChoice(){
        document.getElementById("loginOverlay").classList.remove("show");
        document.getElementById("loginPopup").classList.remove("show");
    }
    function backToLoginChoice(){
        hideLoginProcessingOverlay();
        showLoginChoice();
    }

    // 登入處理中
    function showLoginProcessingOverlay(){
        document.getElementById("loginProcessingOverlay").classList.add("show");
        document.getElementById("loginProcessingPopup").classList.add("show");
    }
    function hideLoginProcessingOverlay(){
        document.getElementById("loginProcessingOverlay").classList.remove("show");
        document.getElementById("loginProcessingPopup").classList.remove("show");
    }

    // 讀/寫 localStorage
    function saveClassesLocal(){
        localStorage.setItem("classes", JSON.stringify(classes));
    }

    // 從 Google Drive 載入 classes.json
    async function loadClassesFromDrive(){
        if(!googleAuth.getIsSignedIn()) return;
        try {
            let data=await googleDrive.loadDriveFile("classes.json");
            if(data){
                classes=data;
                saveClassesLocal();
                if(!classes[currentClass]){
                    currentClass=Object.keys(classes)[0]||"一班";
                }
                renderClassDropdown();
                renderStudents();
                markSynced();
            } else {
                console.log("未找到 classes.json => 等使用者手動同步建立");
                markDirty();
            }
        } catch(err){
            console.error("loadClasses失敗:",err);
            markDirty();
        }
    }

    // 班級
    function renderClassDropdown(){
        let sel=document.getElementById("classSelect");
        sel.innerHTML="";
        for(let cName in classes){
            let opt=document.createElement("option");
            opt.value=cName;
            opt.textContent=cName;
            if(cName===currentClass) opt.selected=true;
            sel.appendChild(opt);
        }
    }
    function getStudents(){
        if(!classes[currentClass]) classes[currentClass]=[];
        return classes[currentClass];
    }
    function renderStudents(){
        let arr=getStudents();
        let container=document.getElementById("studentContainer");
        container.innerHTML="";
        arr.forEach((st,idx)=>{
            let card=document.createElement("div");
            card.classList.add("student-card");
            let imgSrc=imageMap[st.imageLabel]||"";
            card.innerHTML=`
      <img src="${imgSrc}" alt="${st.gender}" onclick="editStudent(${idx})">
      <p>${st.name}</p>
      <p id="score-${idx}">${st.score} 分</p>
      <button class="btn-score" onclick="updateScore(${idx}, -5)">-5</button>
      <button class="btn-score" onclick="updateScore(${idx}, -1)">-1</button>
      <button class="btn-score" onclick="updateScore(${idx},  1)">+1</button>
      <button class="btn-score" onclick="updateScore(${idx},  5)">+5</button>
      <div class="quickAdjust">
        <select id="sign-${idx}">
          <option value="+">+</option>
          <option value="-">-</option>
        </select>
        <input type="number" id="custom-${idx}" placeholder="自訂分數" style="width:60px;">
        <button onclick="customAdjust(${idx})">確定</button>
      </div>
      <button class="btn-edit"   onclick="editStudent(${idx})">編輯</button>
      <button class="btn-delete" onclick="deleteStudent(${idx})">刪除</button>
    `;
            container.appendChild(card);
        });
    }

    // 防止更新中修改
    window.editStudent=function(idx){
        if(checkIfUpdating()) return;
        showPopup(idx);
    };
    window.updateScore=function(idx,delta){
        if(checkIfUpdating()) return;
        let arr=getStudents();
        arr[idx].score+=delta;
        saveClassesLocal();
        document.getElementById(`score-${idx}`).textContent=arr[idx].score+" 分";
        markDirty();
    };
    window.customAdjust=function(idx){
        if(checkIfUpdating()) return;
        let arr=getStudents();
        let signSel=document.getElementById(`sign-${idx}`);
        let customIn=document.getElementById(`custom-${idx}`);
        let sign=signSel.value;
        let val=parseInt(customIn.value)||0;
        if(sign==="-") val=-val;
        arr[idx].score+=val;
        saveClassesLocal();
        document.getElementById(`score-${idx}`).textContent=arr[idx].score+" 分";
        customIn.value="";
        markDirty();
    };
    window.deleteStudent=function(idx){
        if(checkIfUpdating()) return;
        if(!confirm("確定要刪除這位學生嗎？"))return;
        let arr=getStudents();
        arr.splice(idx,1);
        saveClassesLocal();
        renderStudents();
        markDirty();
    };

    // 新增/編輯 學生
    function showPopup(idx=-1){
        editIndex=idx;
        document.getElementById("overlay").classList.add("show");
        document.getElementById("studentPopup").classList.add("show");
        if(idx===-1){
            document.getElementById("popupTitle").textContent="新增學生";
            document.getElementById("studentName").value="";
            document.getElementById("studentScore").value=0;
            document.getElementById("studentGender").value="男";
            selectedImage="";
        }else{
            document.getElementById("popupTitle").textContent="編輯學生";
            let arr=getStudents();
            let st=arr[idx];
            document.getElementById("studentName").value=st.name;
            document.getElementById("studentScore").value=st.score;
            document.getElementById("studentGender").value=st.gender;
            selectedImage=st.imageLabel;
        }
        updateImagePreview();
    }
    function closePopup(){
        document.getElementById("overlay").classList.remove("show");
        document.getElementById("studentPopup").classList.remove("show");
    }
    function updateImagePreview(){
        let gender=document.getElementById("studentGender").value;
        let imageSelection=document.getElementById("imageSelection");
        imageSelection.innerHTML="";
        let labels=genderImageLabels[gender];
        labels.forEach((lbl,idx)=>{
            let img=document.createElement("img");
            img.src=imageMap[lbl];
            img.onclick=()=>{
                document.querySelectorAll(".image-preview img").forEach(x=>x.classList.remove("selected"));
                img.classList.add("selected");
                selectedImage=lbl;
            };
            if(idx===0 && editIndex===-1 && !selectedImage){
                img.classList.add("selected");
                selectedImage=lbl;
            }
            if(editIndex!==-1 && selectedImage===lbl){
                img.classList.add("selected");
            }
            imageSelection.appendChild(img);
        });
    }
    function saveStudent(){
        if(checkIfUpdating()) return;
        let name=document.getElementById("studentName").value.trim();
        let score=parseInt(document.getElementById("studentScore").value)||0;
        let gender=document.getElementById("studentGender").value;
        if(!selectedImage){
            let labs=genderImageLabels[gender];
            selectedImage=labs[0];
        }
        if(!name){
            alert("請輸入學生姓名");
            return;
        }
        let arr=getStudents();
        if(editIndex===-1){
            arr.push({ name,score,gender,imageLabel:selectedImage });
        }else{
            arr[editIndex]={ name,score,gender,imageLabel:selectedImage };
        }
        saveClassesLocal();
        closePopup();
        renderStudents();
        markDirty();
    }

    // CSV
    function exportCSV(){
        let arr=getStudents();
        let csv="姓名,分數,性別,圖片\n"+
            arr.map(s=>`${s.name},${s.score},${s.gender},${s.imageLabel}`).join("\n");
        let blob=new Blob([csv],{type:"text/csv"});
        let a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download=`${currentClass}-students.csv`;
        a.click();
    }
    function importCSV(evt){
        let file=evt.target.files[0];
        if(!file)return;
        let reader=new FileReader();
        reader.onload=(e)=>{
            let lines=e.target.result.split("\n").map(x=>x.trim()).filter(x=>x);
            lines.shift();
            let newArr=[];
            lines.forEach(line=>{
                let[name,score,gender,imageLabel]=line.split(",");
                score=parseInt(score)||0;
                if(!imageLabel){
                    let labs=genderImageLabels[gender]||["男1"];
                    imageLabel=labs[0];
                }
                newArr.push({ name,score,gender,imageLabel });
            });
            classes[currentClass]=newArr;
            saveClassesLocal();
            renderStudents();
            markDirty();
        };
        reader.readAsText(file);
    }

    // 班級管理
    function showClassPopup(){
        if(checkIfUpdating()) return;
        document.getElementById("classOverlay").classList.add("show");
        document.getElementById("classPopup").classList.add("show");
        renderClassList();
    }
    function closeClassPopup(){
        document.getElementById("classOverlay").classList.remove("show");
        document.getElementById("classPopup").classList.remove("show");
    }
    function renderClassList(){
        let listEl=document.getElementById("classList");
        listEl.innerHTML="";
        let cNames=Object.keys(classes);
        cNames.forEach(cName=>{
            let div=document.createElement("div");
            div.classList.add("class-item");
            let disableDelete=(cNames.length<=1)?true:false;
            let html=`
      <span class="class-name">${cName}</span>
      <div>
        <button class="btn-rename">修改</button>
        <button class="btn-delete-class" ${disableDelete?"disabled":""}>刪除</button>
      </div>
    `;
            div.innerHTML=html;
            let renameBtn=div.querySelector(".btn-rename");
            let delBtn=div.querySelector(".btn-delete-class");
            renameBtn.addEventListener("click",()=> renameClassPrompt(cName));
            delBtn.addEventListener("click",()=>{
                if(disableDelete){
                    alert("只剩最後一個班級，無法刪除");
                    return;
                }
                deleteClass(cName);
            });
            listEl.appendChild(div);
        });
    }
    function addClassPrompt(){
        if(checkIfUpdating()) return;
        let newName=prompt("請輸入新班級名稱：");
        if(!newName)return;
        newName=newName.trim();
        if(!newName)return;
        if(classes[newName]){
            alert("此班級已存在");
            return;
        }
        classes[newName]=[];
        saveClassesLocal();
        currentClass=newName;
        renderClassDropdown();
        renderStudents();
        renderClassList();
        markDirty();
    }
    function renameClassPrompt(oldName){
        if(checkIfUpdating()) return;
        let newName=prompt("新的班級名稱", oldName);
        if(!newName)return;
        newName=newName.trim();
        if(!newName|| newName===oldName)return;
        if(classes[newName]){
            alert("此班級已存在");
            return;
        }
        classes[newName]=classes[oldName];
        delete classes[oldName];
        if(currentClass===oldName) currentClass=newName;
        saveClassesLocal();
        renderClassDropdown();
        renderStudents();
        renderClassList();
        markDirty();
    }
    function deleteClass(cName){
        if(checkIfUpdating()) return;
        let cCount=Object.keys(classes).length;
        if(cCount<=1){
            alert("只剩最後一個班級，無法刪除");
            return;
        }
        if(!confirm(`確定刪除「${cName}」?`))return;
        delete classes[cName];
        currentClass=Object.keys(classes)[0];
        saveClassesLocal();
        renderClassDropdown();
        renderStudents();
        renderClassList();
        markDirty();
    }
</script>
</body>
</html>
