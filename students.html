<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>班級學員分數管理</title>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- CSS 模組 -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/popup.css">
    <link rel="stylesheet" href="css/wheel.css">
    <link rel="stylesheet" href="css/help.css">

    <!-- JavaScript 模組 -->
    <script type="module" src="js/main.js"></script>
</head>
<body>
<!-- 側邊欄 -->
<div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" id="sidebarToggle">☰</button>
    
    <!-- 帳號管理群組 -->
    <div class="menu-group">
        <div class="menu-group-title">帳號管理</div>
        <a class="menu-item" id="login-btn" style="display:none;">
            <i>👤</i><span>登入 Google</span>
        </a>
        <a class="menu-item" id="logout-btn" style="display:none;">
            <i>🚪</i><span>登出</span>
        </a>
    </div>

    <!-- 班級管理群組 -->
    <div class="menu-group">
        <div class="menu-group-title">班級</div>
        <div class="menu-item">
            <i>📚</i>
            <span><select id="classSelect" style="display:none;"></select></span>
        </div>
    </div>

    <!-- 功能群組 -->
    <div class="menu-group">
        <div class="menu-group-title">功能選單</div>
        <!-- 管理功能子選單 -->
        <a class="menu-item has-submenu" id="btnManage">
            <i>⚙️</i><span>管理功能</span>
        </a>
        <div class="submenu" id="manageSubmenu">
            <a class="menu-item" id="btnScoreSettings">
                <i>📊</i><span>分數按鈕設定</span>
            </a>
            <a class="menu-item" id="btnClassManage">
                <i>📝</i><span>班級管理</span>
            </a>
            <a class="menu-item" id="btnAddStudent">
                <i>➕</i><span>新增學生</span>
            </a>
        </div>
        <a class="menu-item" id="btnWheel">
            <i>🎡</i><span>輪轉盤</span>
        </a>
        <a class="menu-item" id="btnHelp">
            <i>❓</i><span>使用說明</span>
        </a>
    </div>

    <!-- 資料管理群組 -->
    <div class="menu-group">
        <div class="menu-group-title">資料管理</div>
        <a class="menu-item has-submenu" id="btnDataManage">
            <i>📁</i><span>CSV 資料</span>
        </a>
        <div class="submenu" id="dataSubmenu">
            <a class="menu-item" id="btnExportCSV">
                <i>📤</i><span>匯出 CSV</span>
            </a>
            <a class="menu-item" id="btnImportCSV">
                <i>📥</i><span>匯入 CSV</span>
            </a>
        </div>
    </div>

    <!-- 同步狀態 -->
    <div class="menu-group">
        <div class="menu-group-title">同步狀態</div>
        <div id="syncStatusBar">
            <span id="statusDirty" class="grey">有異動</span>
            <span id="statusUpdating" class="grey">更新中</span>
            <span id="statusSynced" class="grey">已同步</span>
        </div>
    </div>
</div>

<!-- 主內容區域 -->
<div class="main-content" id="mainContent">
    <h2>班級學員分數管理</h2>
    <div class="container" id="studentContainer"></div>
</div>

<input type="file" id="importCSV" accept=".csv" style="display:none;" />

<!-- 登入 or 離線 遮罩 & 彈窗 -->
<div class="login-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
    <h3>請選擇登入方式</h3>
    <p>若不登入，系統僅使用本地資料(離線模式)。</p>
    <button id="btnLoginNow" style="background:#4caf50;">登入 Google</button>
    <button id="btnOffline"  style="background:#9e9e9e;">離線模式</button>
    <p class="warn">注意：之後登入 Google 可能會覆蓋本地資料</p>
</div>

<!-- 登入處理中: 遮罩 + popup -->
<div class="login-processing-overlay" id="loginProcessingOverlay"></div>
<div class="login-processing-popup" id="loginProcessingPopup">
    <h3>登入中，請稍候...</h3>
    <p>如關閉 Google 彈窗或登入失敗，將回到登入選擇。</p>
</div>

<!-- 新增/編輯學生 -->
<div class="overlay" id="overlay"></div>
<div class="popup" id="studentPopup">
    <h3 id="popupTitle">新增學生</h3>
    <input type="text"   id="studentName"  placeholder="輸入姓名" />
    <input type="number" id="studentScore" placeholder="輸入分數" min="0" />
    <select id="studentGender">
        <option value="男">男生</option>
        <option value="女">女生</option>
    </select>
    <div class="image-preview" id="imageSelection"></div>
    <div class="custom-image-upload">
        <input type="file" id="customImageUpload" accept="image/*" style="display:none;">
        <button id="btnUploadImage" style="background:#2196f3;">上傳自訂圖片</button>
        <div id="customImagePreview" class="custom-image-preview"></div>
    </div>
    <br />
    <button id="btnSaveStudent" style="background:#4caf50;">儲存</button>
    <button id="btnClosePopup" style="background:#757575;">取消</button>
</div>

<!-- 班級管理視窗 -->
<div class="class-overlay" id="classOverlay"></div>
<div class="class-popup" id="classPopup">
    <h3>班級管理</h3>
    <button id="btnAddClass" style="background:#4caf50;">新增班級</button>
    <div class="class-list" id="classList"></div>
    <button id="btnCloseClassPopup" style="background:#757575;">關閉</button>
</div>

<!-- 同步中 遮罩 + popup -->
<div class="sync-overlay" id="syncOverlay"></div>
<div class="sync-popup" id="syncPopup">
    <h3>資料同步中，請稍後...</h3>
    <p id="syncMessage"></p>
</div>

<!-- 輪轉盤視窗 -->
<div class="wheel-overlay" id="wheelOverlay"></div>
<div class="wheel-popup" id="wheelPopup">
    <div class="wheel-type-switch">
        <button id="btnStudentWheel" class="wheel-type-btn active">學生輪轉盤</button>
        <button id="btnRewardWheel" class="wheel-type-btn">獎懲輪轉盤</button>
    </div>
    <h3 id="wheelTitle">學生輪轉盤</h3>
    
    <div class="wheel-controls-container">
        <div class="wheel-left-controls">
            <label>
                <input type="checkbox" id="noRepeat" checked>
                不重複選擇
            </label>
            <button id="btnResetWheel" style="background:#ff9800;">重置已選名單</button>
        </div>
        <div class="wheel-right-controls">
            <button id="btnSpinWheel" style="background:#4caf50;">開始轉動</button>
            <button id="btnCloseWheel" style="background:#757575;">關閉</button>
        </div>
    </div>

    <div class="wheel-container">
        <canvas id="wheelCanvas"></canvas>
        <div class="wheel-pointer"></div>
    </div>

    <div class="selected-students">
        <h4>已選項目</h4>
        <div id="selectedList"></div>
    </div>

    <div id="rewardControls" style="display:none;">
        <div class="reward-input">
            <input type="text" id="newReward" placeholder="輸入獎懲項目">
            <button id="btnAddReward" style="background:#4caf50;">新增</button>
        </div>
        <div id="rewardList" class="reward-list"></div>
    </div>
</div>

<!-- 使用說明視窗 -->
<div class="help-overlay" id="helpOverlay"></div>
<div class="help-popup" id="helpPopup">
    <h3>使用說明</h3>
    <div class="help-tabs">
        <button class="tab-btn active" data-tab="usage">使用說明</button>
        <button class="tab-btn" data-tab="version">版本歷程</button>
    </div>
    <div class="help-content">
        <div class="tab-content active" id="usageContent">
            <div class="help-section">
                <h4>基本操作</h4>
                <ul>
                    <li>點擊「新增學生」可以新增學生資料</li>
                    <li>點擊學生卡片上的圖片可以編輯學生資料</li>
                    <li>點擊學生卡片右上角的 × 可以刪除學生</li>
                    <li>可以拖曳學生卡片調整順序</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>分數管理</h4>
                <ul>
                    <li>使用四個分數按鈕快速加減分</li>
                    <li>使用「自訂分數」輸入框手動調整分數</li>
                    <li>點擊「分數按鈕設定」可以自訂四個按鈕的分數值</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>圖片管理</h4>
                <ul>
                    <li>可以選擇預設的學生頭像</li>
                    <li>可以上傳自訂圖片（需要登入 Google）</li>
                    <li>可以管理所有已上傳的圖片</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>班級管理</h4>
                <ul>
                    <li>可以新增、修改、刪除班級</li>
                    <li>使用下拉選單切換不同班級</li>
                    <li>可以匯出/匯入 CSV 檔案</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>輪轉盤功能</h4>
                <ul>
                    <li>可以切換學生輪轉盤和獎懲輪轉盤</li>
                    <li>學生輪轉盤：隨機選擇學生</li>
                    <li>獎懲輪轉盤：隨機選擇獎懲項目</li>
                    <li>可以新增、刪除獎懲項目</li>
                    <li>可以設定是否重複選擇</li>
                    <li>可以查看已選名單</li>
                    <li>點擊輪盤可以停止轉動</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>資料同步</h4>
                <ul>
                    <li>登入 Google 後可以同步資料</li>
                    <li>狀態列顯示同步狀態</li>
                    <li>可以手動點擊同步</li>
                </ul>
            </div>
        </div>
        <div class="tab-content" id="versionContent">
            <div class="help-section version-history">
                <div class="version-item">
                    <div class="version-header">
                        <span>版本 1.3.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>新增獎懲輪轉盤功能</li>
                        <li>新增獎懲項目管理功能</li>
                        <li>新增獎懲項目資料同步功能</li>
                        <li>優化輪轉盤使用者介面</li>
                    </ul>
                </div>
                <div class="version-item">
                    <div class="version-header">
                        <span>版本 1.2.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>新增使用說明功能</li>
                        <li>修正 ESC 按鍵關閉視窗功能</li>
                        <li>優化使用者介面樣式</li>
                    </ul>
                </div>
                <div class="version-item">
                    <div class="version-header">
                        <span>版本 1.1.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>新增輪轉盤功能</li>
                        <li>新增自訂圖片上傳功能</li>
                        <li>新增圖片管理功能</li>
                        <li>優化同步機制</li>
                    </ul>
                </div>
                <div class="version-item">
                    <div class="version-header">
                        <span>版本 1.0.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>基本學生管理功能</li>
                        <li>分數加減功能</li>
                        <li>班級管理功能</li>
                        <li>Google 帳號整合</li>
                        <li>資料同步功能</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <button id="btnCloseHelp" style="background:#757575;">關閉</button>
</div>

<!-- 初始化 Google API -->
<script>
    // 先初始化 Google API
    function initGapi() {
        gapi.load('client', async () => {
            await gapi.client.init({
                apiKey: 'AIzaSyCpO6sP8jmBvwuuM2qRU8XYyaFHD_TP-34',
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
            console.log('Google API 初始化完成');
        });
    }
    
    // 當 Google API 腳本載入完成後執行初始化
    function onGapiLoad() {
        initGapi();
    }
    
    // 添加 Google API 載入事件
    document.querySelector('script[src="https://apis.google.com/js/api.js"]').addEventListener('load', onGapiLoad);
</script>
</body>
</html>
