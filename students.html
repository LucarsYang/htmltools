<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>班級學員分數管理</title>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- CSS 直接寫在 <style> 中 -->
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f4f4f4;
            margin: 0; padding: 0;
        }
        h2 { margin-top:20px; margin-bottom:10px; }

        /* 側邊欄樣式 */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background: #2c3e50;
            color: white;
            transition: all 0.3s ease;
            z-index: 100;  /* 降低側邊欄的 z-index */
            padding-top: 60px;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .menu-group {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .menu-group-title {
            color: #ecf0f1;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px;
            color: white;
            text-decoration: none;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.2s;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .sidebar.collapsed .menu-item span,
        .sidebar.collapsed .menu-group-title {
            display: none;
        }

        /* 主內容區域樣式 */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 60px;
        }

        /* 修改工具列樣式 */
        .toolbar {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        /* 狀態指示器樣式 */
        #syncStatusBar {
            background: transparent;
            padding: 5px 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* 工具列群組樣式 */
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            background: #f5f5f5;
            border-radius: 5px;
            margin: 5px;
        }

        .toolbar-group.auth {
            background: #e8f5e9;  /* 淺綠色背景 */
        }

        .toolbar {
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px;
            margin-bottom: 10px; 
            align-items: center;
        }
        button {
            margin:5px; padding:8px; cursor:pointer; border:none; border-radius:5px;
            background-color:#4caf50; color:white;
        }
        button:hover { opacity:0.9; }
        #login-btn { background:#4caf50; }
        #logout-btn { background:#ff4d4d; }
        #btn-add-student { background:#2196f3; }
        #btn-export-csv  { background:#ff9800; }
        #btn-manage-classes { background:#9c27b0; }
        #btn-manual-sync { background:#d32f2f; } /* 手動同步按鈕 */

        #classSelect {
            margin:5px; padding:5px; border-radius:5px;
        }

        /* 三狀態: 有異動/更新中/已同步 */
        #syncStatusBar {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 5px 10px;
            border-radius: 5px;
            background: #f5f5f5;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #syncStatusBar:hover {
            background: #e0e0e0;
        }
        #syncStatusBar.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .red    { color:red;    }
        .yellow { color:#FFC107;}
        .green  { color:green;  }
        .grey   { color:#aaa;   }

        .container {
            display:flex; flex-wrap:wrap; justify-content:center; gap:20px;
            margin-top:20px; padding-bottom:30px;
        }
        .student-card {
            width:180px; border:1px solid #ccc; background:white;
            padding:10px; text-align:center; border-radius:10px;
            box-shadow:2px 2px 10px rgba(0,0,0,0.1);
            cursor: move; /* 添加移動游標 */
            user-select: none; /* 防止拖拉時選中文字 */
            transition: transform 0.2s, box-shadow 0.2s; /* 添加過渡效果 */
            position: relative; /* 添加相對定位 */
        }
        .student-card.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .student-card.drag-over {
            border: 2px dashed #4caf50;
        }
        .student-card img { width:80px; height:80px; cursor:pointer; }
        .btn-score {
            color:#fff; border-radius:3px; margin:2px;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-score:hover {
            opacity: 0.9;
        }
        .btn-score.positive {
            background: #4caf50;  /* 綠色 */
        }
        .btn-score.negative {
            background: #f44336;  /* 紅色 */
        }
        .btn-edit {
            background:#ffa500; color:white; margin:5px 2px;
        }
        .btn-delete {
            background:#ff4d4d; color:white; margin:5px 2px;
        }
        .quickAdjust { margin-top:5px; }
        .quickAdjust select, .quickAdjust input { margin-right:5px; }

        /* 登入 or 離線 遮罩 & 彈窗 */
        .login-overlay, .overlay, .class-overlay, .login-processing-overlay,
        .sync-overlay {
            display:none;
            position:fixed; top:0; left:0;
            width:100%; height:100%;
            background:rgba(0,0,0,0.5);
            z-index:1000;  /* 提高遮罩的 z-index */
        }
        .login-overlay.show, .overlay.show, .class-overlay.show,
        .login-processing-overlay.show, .sync-overlay.show {
            display:block;
        }
        .login-popup, .popup, .class-popup, .login-processing-popup, .sync-popup {
            display:none;
            position:fixed; top:50%; left:50%;
            transform:translate(-50%,-50%);
            background:white; padding:20px; border-radius:10px; text-align:center; width:320px;
            box-shadow:2px 2px 10px rgba(0,0,0,0.3); z-index:1001; opacity:0; transition:opacity 0.3s;  /* 提高彈窗的 z-index */
        }
        .login-popup.show, .popup.show, .class-popup.show,
        .login-processing-popup.show, .sync-popup.show {
            display:block; opacity:1;
        }
        .popup input, .popup select,
        .class-popup button, .login-popup button, .login-processing-popup button {
            margin-top:10px; padding:8px;
        }
        .popup button, .class-popup button, .login-processing-popup button {
            margin-top:10px; padding:8px 12px;
        }
        .image-preview {
            display:flex; justify-content:center; gap:10px; margin-top:10px; flex-wrap:wrap;
        }
        .image-preview img {
            width:50px; height:50px; cursor:pointer; border:2px solid transparent; border-radius:5px; box-sizing:border-box;
        }
        .image-preview img.selected { border:2px solid #2196f3; }

        .login-popup .warn {
            margin-top:10px; font-size:14px; color:#f44336;
        }

        .class-list { text-align:left; margin-top:10px; }
        .class-item {
            display:flex; align-items:center; justify-content:space-between;
            margin:5px 0; padding:5px; background:#f9f9f9; border-radius:5px;
        }
        .class-name { font-weight:bold; margin-right:10px; }
        .class-item button {
            margin:5px; font-size:14px;
        }
        .btn-rename { background:#ff9800; }
        .btn-delete-class { background:#f44336; }

        .custom-image-upload {
            margin-top: 10px;
            text-align: center;
        }
        .custom-image-preview {
            margin-top: 10px;
            display: flex;
            justify-content: center;
        }
        .custom-image-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
            border: 2px solid #2196f3;
        }
        .uploaded-images-section {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .uploaded-images-section h4 {
            margin: 0 0 10px 0;
            color: #666;
        }
        .uploaded-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .uploaded-images-grid img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .uploaded-images-grid img:hover {
            transform: scale(1.05);
        }
        .uploaded-images-grid img.selected {
            border-color: #2196f3;
        }
        .image-container {
            position: relative;
            width: 70px;
            margin: 5px;
            text-align: center;
        }
        .image-delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            padding: 0;
            line-height: 1;
        }
        .image-container:hover .image-delete-btn {
            display: block;
        }
        .image-name {
            font-size: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 2px;
            color: #666;
        }
        .uploaded-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }

        /* 下拉式選單樣式 */
        .dropdown {
            position: relative;
            display: inline-block;
            margin: 5px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            overflow: hidden;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropbtn {
            background-color: #4caf50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .dropbtn:hover {
            opacity: 0.9;
        }

        /* 輪轉盤樣式 */
        .wheel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .wheel-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 800px;
            height: 90vh;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1001;
        }

        .wheel-popup.show {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .wheel-overlay.show {
            display: block;
        }

        .wheel-type-switch {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .wheel-type-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #f0f0f0;
            transition: all 0.3s ease;
            font-size: 16px;
            min-width: 120px;
        }

        .wheel-type-btn.active {
            background: #4caf50;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .wheel-controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 10px;
        }

        .wheel-left-controls, .wheel-right-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .wheel-left-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .wheel-left-controls input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .wheel-container {
            position: relative;
            width: 600px;
            height: 600px;
            margin: 0 auto;
            flex: 1;
            min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #wheelCanvas {
            max-width: 100%;
            max-height: 100%;
        }

        .wheel-pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-top: 50px solid #ff4d4d;
            z-index: 2;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
        }

        .selected-students {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 20px;
            max-height: 200px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .selected-students h4 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        #selectedList {
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 150px;
        }

        #selectedList li {
            list-style: none;
            padding: 8px 12px;
            background: #f0f0f0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        #selectedList li:hover {
            background: #e8e8e8;
        }

        #selectedList li button {
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        #selectedList li button:hover {
            background: #ff3333;
            transform: scale(1.1);
        }

        #rewardControls {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 20px;
        }

        .reward-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .reward-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .reward-input button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #4caf50;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reward-input button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .reward-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .reward-item {
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .reward-item:hover {
            background: #e8e8e8;
        }

        .reward-item button {
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .reward-item button:hover {
            background: #ff3333;
            transform: scale(1.1);
        }

        #btnSpinWheel, #btnResetWheel, #btnCloseWheel {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        #btnSpinWheel:hover, #btnResetWheel:hover, #btnCloseWheel:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* 使用說明視窗樣式 */
        .help-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .help-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
            z-index: 1001;
        }

        /* 切換按鈕樣式 */
        .help-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #f5f5f5;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #e0e0e0;
        }

        .tab-btn.active {
            background: #2196f3;
            color: white;
        }

        /* 內容區塊樣式 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .help-overlay.show,
        .help-popup.show {
            display: block;
        }

        .help-content {
            margin: 20px 0;
            text-align: left;
        }

        .help-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .help-section h4 {
            margin: 0 0 10px 0;
            color: #2196f3;
            font-size: 16px;
        }

        .help-section ul {
            margin: 0;
            padding-left: 20px;
            list-style-type: none;
        }

        .help-section li {
            margin: 5px 0;
            color: #666;
            line-height: 1.4;
            position: relative;
            padding-left: 15px;
        }

        .help-section li:before {
            content: "";
            position: absolute;
            left: 0;
            top: 8px;
            width: 6px;
            height: 6px;
            background: #2196f3;
            border-radius: 50%;
        }

        .help-section.version-history {
            background: #e8f5e9;
        }

        .version-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .version-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            color: #1b5e20;
            font-weight: bold;
        }

        .version-date {
            font-size: 0.9em;
            color: #666;
        }

        .version-changes {
            margin: 0;
            padding-left: 20px;
            list-style-type: none;
        }

        .version-changes li {
            color: #444;
            margin: 3px 0;
            position: relative;
            padding-left: 15px;
        }

        .version-changes li:before {
            content: "";
            position: absolute;
            left: 0;
            top: 8px;
            width: 6px;
            height: 6px;
            background: #4caf50;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            .help-popup {
                width: 95%;
                max-height: 90vh;
            }
        }

        .reward-input {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .reward-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .reward-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .reward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f5f5f5;
            margin: 5px 0;
            border-radius: 5px;
        }

        .reward-item button {
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
<!-- 側邊欄 -->
<div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>
    
    <!-- 帳號管理群組 -->
    <div class="menu-group">
        <div class="menu-group-title">帳號管理</div>
        <a class="menu-item" id="login-btn" style="display:none;">
            <i>👤</i><span>登入 Google</span>
        </a>
        <a class="menu-item" id="logout-btn" style="display:none;">
            <i>🚪</i><span>登出</span>
        </a>
    </div>

    <!-- 班級管理群組 -->
    <div class="menu-group">
        <div class="menu-group-title">班級</div>
        <div class="menu-item">
            <i>📚</i>
            <span><select id="classSelect" style="display:none;"></select></span>
        </div>
    </div>

    <!-- 功能群組 -->
    <div class="menu-group">
        <div class="menu-group-title">功能選單</div>
        <a class="menu-item" id="btnScoreSettings">
            <i>⚙️</i><span>分數按鈕設定</span>
        </a>
        <a class="menu-item" id="btnClassManage">
            <i>📝</i><span>班級管理</span>
        </a>
        <a class="menu-item" id="btnAddStudent">
            <i>➕</i><span>新增學生</span>
        </a>
        <a class="menu-item" id="btnWheel">
            <i>🎡</i><span>輪轉盤</span>
        </a>
        <a class="menu-item" id="btnExportCSV">
            <i>📤</i><span>匯出 CSV</span>
        </a>
        <a class="menu-item" id="btnImportCSV">
            <i>📥</i><span>匯入 CSV</span>
        </a>
        <a class="menu-item" id="btnHelp">
            <i>❓</i><span>使用說明</span>
        </a>
    </div>

    <!-- 同步狀態 -->
    <div class="menu-group">
        <div class="menu-group-title">同步狀態</div>
        <div id="syncStatusBar">
            <span id="statusDirty" class="grey">有異動</span>
            <span id="statusUpdating" class="grey">更新中</span>
            <span id="statusSynced" class="grey">已同步</span>
        </div>
    </div>
</div>

<!-- 主內容區域 -->
<div class="main-content" id="mainContent">
    <h2>班級學員分數管理</h2>
    <div class="container" id="studentContainer"></div>
</div>

<input type="file" id="importCSV" accept=".csv" style="display:none;" />

<!-- 登入 or 離線 遮罩 & 彈窗 -->
<div class="login-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
    <h3>請選擇登入方式</h3>
    <p>若不登入，系統僅使用本地資料(離線模式)。</p>
    <button id="btnLoginNow" style="background:#4caf50;">登入 Google</button>
    <button id="btnOffline"  style="background:#9e9e9e;">離線模式</button>
    <p class="warn">注意：之後登入 Google 可能會覆蓋本地資料</p>
</div>

<!-- 登入處理中: 遮罩 + popup -->
<div class="login-processing-overlay" id="loginProcessingOverlay"></div>
<div class="login-processing-popup" id="loginProcessingPopup">
    <h3>登入中，請稍候...</h3>
    <p>如關閉 Google 彈窗或登入失敗，將回到登入選擇。</p>
</div>

<!-- 新增/編輯學生 -->
<div class="overlay" id="overlay"></div>
<div class="popup" id="studentPopup">
    <h3 id="popupTitle">新增學生</h3>
    <input type="text"   id="studentName"  placeholder="輸入姓名" />
    <input type="number" id="studentScore" placeholder="輸入分數" min="0" />
    <select id="studentGender">
        <option value="男">男生</option>
        <option value="女">女生</option>
    </select>
    <div class="image-preview" id="imageSelection"></div>
    <div class="custom-image-upload">
        <input type="file" id="customImageUpload" accept="image/*" style="display:none;">
        <button id="btnUploadImage" style="background:#2196f3;">上傳自訂圖片</button>
        <div id="customImagePreview" class="custom-image-preview"></div>
    </div>
    <br />
    <button id="btnSaveStudent" style="background:#4caf50;">儲存</button>
    <button id="btnClosePopup" style="background:#757575;">取消</button>
</div>

<!-- 班級管理視窗 -->
<div class="class-overlay" id="classOverlay"></div>
<div class="class-popup" id="classPopup">
    <h3>班級管理</h3>
    <button id="btnAddClass" style="background:#4caf50;">新增班級</button>
    <div class="class-list" id="classList"></div>
    <button id="btnCloseClassPopup" style="background:#757575;">關閉</button>
</div>

<!-- 同步中 遮罩 + popup -->
<div class="sync-overlay" id="syncOverlay"></div>
<div class="sync-popup" id="syncPopup">
    <h3>資料同步中，請稍後...</h3>
</div>

<!-- 輪轉盤視窗 -->
<div class="wheel-overlay" id="wheelOverlay"></div>
<div class="wheel-popup" id="wheelPopup">
    <div class="wheel-type-switch">
        <button id="btnStudentWheel" class="wheel-type-btn active">學生輪轉盤</button>
        <button id="btnRewardWheel" class="wheel-type-btn">獎懲輪轉盤</button>
    </div>
    <h3 id="wheelTitle">學生輪轉盤</h3>
    
    <div class="wheel-controls-container">
        <div class="wheel-left-controls">
            <label>
                <input type="checkbox" id="noRepeat" checked>
                不重複選擇
            </label>
            <button id="btnResetWheel" style="background:#ff9800;">重置已選名單</button>
        </div>
        <div class="wheel-right-controls">
            <button id="btnSpinWheel" style="background:#4caf50;">開始轉動</button>
            <button id="btnCloseWheel" style="background:#757575;">關閉</button>
        </div>
    </div>

    <div class="wheel-container">
        <canvas id="wheelCanvas"></canvas>
        <div class="wheel-pointer"></div>
    </div>

    <div class="selected-students">
        <h4>已選項目</h4>
        <div id="selectedList"></div>
    </div>

    <div id="rewardControls" style="display:none;">
        <div class="reward-input">
            <input type="text" id="newReward" placeholder="輸入獎懲項目">
            <button id="btnAddReward" style="background:#4caf50;">新增</button>
        </div>
        <div id="rewardList" class="reward-list"></div>
    </div>
</div>

<!-- 使用說明視窗 -->
<div class="help-overlay" id="helpOverlay"></div>
<div class="help-popup" id="helpPopup">
    <h3>使用說明</h3>
    <div class="help-tabs">
        <button class="tab-btn active" data-tab="usage">使用說明</button>
        <button class="tab-btn" data-tab="version">版本歷程</button>
    </div>
    <div class="help-content">
        <div class="tab-content active" id="usageContent">
            <div class="help-section">
                <h4>基本操作</h4>
                <ul>
                    <li>點擊「新增學生」可以新增學生資料</li>
                    <li>點擊學生卡片上的圖片可以編輯學生資料</li>
                    <li>點擊學生卡片右上角的 × 可以刪除學生</li>
                    <li>可以拖曳學生卡片調整順序</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>分數管理</h4>
                <ul>
                    <li>使用四個分數按鈕快速加減分</li>
                    <li>使用「自訂分數」輸入框手動調整分數</li>
                    <li>點擊「分數按鈕設定」可以自訂四個按鈕的分數值</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>圖片管理</h4>
                <ul>
                    <li>可以選擇預設的學生頭像</li>
                    <li>可以上傳自訂圖片（需要登入 Google）</li>
                    <li>可以管理所有已上傳的圖片</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>班級管理</h4>
                <ul>
                    <li>可以新增、修改、刪除班級</li>
                    <li>使用下拉選單切換不同班級</li>
                    <li>可以匯出/匯入 CSV 檔案</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>輪轉盤功能</h4>
                <ul>
                    <li>可以切換學生輪轉盤和獎懲輪轉盤</li>
                    <li>學生輪轉盤：隨機選擇學生</li>
                    <li>獎懲輪轉盤：隨機選擇獎懲項目</li>
                    <li>可以新增、刪除獎懲項目</li>
                    <li>可以設定是否重複選擇</li>
                    <li>可以查看已選名單</li>
                    <li>點擊輪盤可以停止轉動</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>資料同步</h4>
                <ul>
                    <li>登入 Google 後可以同步資料</li>
                    <li>狀態列顯示同步狀態</li>
                    <li>可以手動點擊同步</li>
                </ul>
            </div>
        </div>
        <div class="tab-content" id="versionContent">
            <div class="help-section version-history">
                <div class="version-item">
                    <div class="version-header">
                        <span>版本 1.3.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>新增獎懲輪轉盤功能</li>
                        <li>新增獎懲項目管理功能</li>
                        <li>新增獎懲項目資料同步功能</li>
                        <li>優化輪轉盤使用者介面</li>
                    </ul>
                </div>
                <div class="version-item">
                    <div class="version-header">
                        <span>版本 1.2.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>新增使用說明功能</li>
                        <li>修正 ESC 按鍵關閉視窗功能</li>
                        <li>優化使用者介面樣式</li>
                    </ul>
                </div>
                <div class="version-item">
                    <div class="version-header">
                        <span>版本 1.1.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>新增輪轉盤功能</li>
                        <li>新增自訂圖片上傳功能</li>
                        <li>新增圖片管理功能</li>
                        <li>優化同步機制</li>
                    </ul>
                </div>
                <div class="version-item">
                    <div class="version-header">
                        <span>版本 1.0.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>基本學生管理功能</li>
                        <li>分數加減功能</li>
                        <li>班級管理功能</li>
                        <li>Google 帳號整合</li>
                        <li>資料同步功能</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <button onclick="closeHelpPopup()" style="background:#757575;">關閉</button>
</div>

<!-- 一切邏輯集中到一個 <script type="module"> -->
<script type="module">
    // 將 toggleSidebar 函數加入到全局範圍
    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
    };

    // ======== [1] GoogleAuth - 單檔: OAuth ========
    const googleAuth = (function(){
        let accessToken = localStorage.getItem("googleAccessToken") || null;
        let isGoogleSignedIn = !!accessToken;
        let tokenClient = null;

        // 測試用：模擬 token 過期
        function simulateTokenExpired() {
            accessToken = "test_expired_token";
            isGoogleSignedIn = true;
            localStorage.setItem("googleAccessToken", accessToken);
        }

        function initGoogleAuth(onSuccess, onFailure){
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id:"310618779783-ephi24bku6psi9c7c1babi0v1n7fu8u9.apps.googleusercontent.com",
                scope:"https://www.googleapis.com/auth/drive.file",
                callback:(resp)=>{
                    if(resp.error){
                        if(onFailure) onFailure(resp.error);
                    } else {
                        // 成功
                        accessToken = resp.access_token;
                        localStorage.setItem("googleAccessToken", accessToken);
                        isGoogleSignedIn = true;
                        if(onSuccess) onSuccess();
                    }
                }
            });
        }
        function signIn(){
            if(!tokenClient) { console.warn("tokenClient未初始化"); return; }
            tokenClient.requestAccessToken();
        }
        function signOut(cb){
            if(!accessToken){
                if(cb) cb();
                return;
            }
            google.accounts.oauth2.revoke(accessToken,()=>{
                accessToken = null;
                isGoogleSignedIn = false;
                localStorage.removeItem("googleAccessToken");
                if(cb) cb();
            });
        }
        function getAccessToken(){ return accessToken; }
        function getIsSignedIn(){ return isGoogleSignedIn; }

        return {
            initGoogleAuth, signIn, signOut, getAccessToken, getIsSignedIn,
            simulateTokenExpired  // 加入測試用方法
        };
    })();

    // 將 googleAuth 暴露到全局範圍
    window.googleAuth = googleAuth;

    // ======== [2] GoogleDrive - 單檔: 讀/寫 Drive ========
    const googleDrive = (function(){
        let appFolderId = null; // 儲存應用程式目錄的 ID

        // 初始化：確保應用程式目錄存在
        async function ensureAppFolder() {
            if (!googleAuth.getIsSignedIn()) return null;
            let token = googleAuth.getAccessToken();

            // 先搜尋是否已存在目錄
            let searchRes = await fetch(
                `https://www.googleapis.com/drive/v3/files?q=name='htmltools' and mimeType='application/vnd.google-apps.folder' and trashed=false&spaces=drive&fields=files(id,name)`,
                { headers: { "Authorization": `Bearer ${token}` } }
            );
            if (!searchRes.ok) throw new Error("Search Error " + searchRes.status);
            let searchData = await searchRes.json();

            if (searchData.files && searchData.files.length > 0) {
                // 目錄已存在
                appFolderId = searchData.files[0].id;
                return appFolderId;
            }

            // 建立新目錄
            let folderMetadata = {
                name: "htmltools",
                mimeType: "application/vnd.google-apps.folder"
            };

            let createRes = await fetch(
                "https://www.googleapis.com/drive/v3/files?fields=id",
                {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(folderMetadata)
                }
            );
            if (!createRes.ok) throw new Error("Create Folder Error " + createRes.status);
            let createData = await createRes.json();
            appFolderId = createData.id;
            return appFolderId;
        }

        async function loadDriveFile(fileName) {
            if (!googleAuth.getIsSignedIn()) return null;
            let token = googleAuth.getAccessToken();
            await ensureAppFolder();

            // 在應用程式目錄中搜尋檔案
            let listRes = await fetch(
                `https://www.googleapis.com/drive/v3/files?q='${appFolderId}' in parents and name='${fileName}' and trashed=false&spaces=drive&fields=files(id,name)`,
                { headers: { "Authorization": `Bearer ${token}` } }
            );
            if (!listRes.ok) throw new Error("List Error " + listRes.status);
            let listData = await listRes.json();
            if (!listData.files || listData.files.length === 0) {
                return null;
            }
            let fileId = listData.files[0].id;

            let getRes = await fetch(
                `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                { headers: { "Authorization": `Bearer ${token}` } }
            );
            if (!getRes.ok) throw new Error("Get Error " + getRes.status);
            let content = await getRes.text();
            return JSON.parse(content);
        }

        async function saveDriveFile(fileName, dataObj) {
            if (!googleAuth.getIsSignedIn()) throw new Error("尚未登入Google");
            let token = googleAuth.getAccessToken();
            await ensureAppFolder();

            // 測試用：模擬 token 過期
            if (token === "test_expired_token") {
                throw new Error("401 Unauthorized");
            }

            // 在應用程式目錄中搜尋檔案
            let listRes = await fetch(
                `https://www.googleapis.com/drive/v3/files?q='${appFolderId}' in parents and name='${fileName}' and trashed=false&spaces=drive&fields=files(id,name)`,
                { headers: { "Authorization": `Bearer ${token}` } }
            );
            if (!listRes.ok) throw new Error("List Error " + listRes.status);
            let listData = await listRes.json();
            let fileId = (listData.files && listData.files.length > 0) ? listData.files[0].id : null;

            if (fileId) {
                // 如果檔案存在，先刪除它
                await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                    method: 'DELETE',
                    headers: { "Authorization": `Bearer ${token}` }
                });
            }

            // 建立新檔案
            let fileMetadata = {
                name: fileName,
                mimeType: "application/json",
                parents: [appFolderId]
            };
            let fileContent = new Blob([JSON.stringify(dataObj)], { type: "application/json" });
            let form = new FormData();
            form.append("metadata", new Blob([JSON.stringify(fileMetadata)], { type: "application/json" }));
            form.append("file", fileContent);

            let uploadRes = await fetch(
                "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
                {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${token}`
                    },
                    body: form
                }
            );

            if (!uploadRes.ok) throw new Error("Upload Error " + uploadRes.status);
            await uploadRes.json();
        }

        // 上傳圖片到應用程式目錄
        async function uploadImageToDrive(file) {
            const token = googleAuth.getAccessToken();
            await ensureAppFolder();

            const metadata = {
                name: `student_${Date.now()}_${file.name}`,
                mimeType: file.type,
                parents: [appFolderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const uploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: form
            });

            if (!uploadRes.ok) throw new Error('上傳失敗');
            const uploadData = await uploadRes.json();

            // 設定檔案權限為「任何人都可以查看」
            const permissionRes = await fetch(`https://www.googleapis.com/drive/v3/files/${uploadData.id}/permissions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    role: 'reader',
                    type: 'anyone'
                })
            });

            if (!permissionRes.ok) {
                // 如果設定權限失敗，刪除已上傳的檔案
                await fetch(`https://www.googleapis.com/drive/v3/files/${uploadData.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                throw new Error('設定權限失敗');
            }

            return uploadData.id;
        }

        // 從 Google Drive 取得圖片的檢視連結
        async function getImageUrlFromDrive(fileId) {
            // 直接回傳固定格式的 URL
            return `https://drive.google.com/thumbnail?id=${fileId}&sz=w200-h200`;
        }

        // 新增：從 Google Drive 取得所有圖片
        async function getAllImages() {
            if (!googleAuth.getIsSignedIn()) return [];
            const token = googleAuth.getAccessToken();
            await ensureAppFolder();

            try {
                // 搜尋應用程式目錄中的所有圖片檔案
                const searchRes = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q='${appFolderId}' in parents and mimeType contains 'image/' and trashed=false&fields=files(id,name,mimeType)`,
                    { headers: { "Authorization": `Bearer ${token}` } }
                );

                if (!searchRes.ok) throw new Error("搜尋圖片失敗");
                const searchData = await searchRes.json();

                // 為每個圖片取得縮圖 URL
                return searchData.files.map(file => ({
                    id: file.id,
                    url: `https://drive.google.com/thumbnail?id=${file.id}&sz=w200-h200`,
                    name: file.name
                }));
            } catch(err) {
                console.error("取得圖片列表失敗:", err);
                return [];
            }
        }

        // 新增：從 Google Drive 刪除檔案
        async function deleteFile(fileId) {
            if (!googleAuth.getIsSignedIn()) return;
            const token = googleAuth.getAccessToken();
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}`,
                    {
                        method: 'DELETE',
                        headers: { "Authorization": `Bearer ${token}` }
                    }
                );
                
                if (!response.ok) throw new Error("刪除失敗");
                return true;
            } catch(err) {
                console.error("刪除檔案失敗:", err);
                throw err;
            }
        }

        return {
            loadDriveFile, saveDriveFile, uploadImageToDrive, getImageUrlFromDrive,
            getAllImages, deleteFile  // 匯出新函數
        };
    })();

    // ======== [3] 主程式 students.js ========

    // 全域狀態
    let classes = JSON.parse(localStorage.getItem("classes")) || { 
        "501": [],
        "scoreButtons": [-5, -1, 1, 5],  // 預設值
        "rewards": ["獎勵", "懲罰"]  // 新增：預設獎懲項目
    };
    let currentClass = Object.keys(classes).find(key => !['scoreButtons', 'rewards'].includes(key)) || "一班";

    let updatingState = false; // true表示「更新中(黃)」階段 => 阻擋操作
    let editIndex = -1;
    let selectedImage = "";
    let customImageData = null; // 新增：儲存自訂圖片的 base64 資料
    let customImageFileId = null; // 新增：儲存 Google Drive 上的圖片 ID
    let uploadedImages = new Set(); // 儲存所有已上傳的圖片資訊

    // 新增自動同步相關變數
    let autoSyncTimer = null;
    const AUTO_SYNC_DELAY = 30; // 30秒
    let remainingSeconds = 0;

    // 新增自動檢查相關變數
    let inactivityTimer = null;
    const INACTIVITY_CHECK_DELAY = 60; // 60秒
    let lastActivityTime = Date.now();

    // 新增：重置不活動計時器
    function resetInactivityTimer() {
        if (inactivityTimer) {
            clearTimeout(inactivityTimer);
        }
        lastActivityTime = Date.now();
        inactivityTimer = setTimeout(checkCloudFile, INACTIVITY_CHECK_DELAY * 1000);
    }

    // 新增：檢查雲端檔案
    async function checkCloudFile() {
        if (!googleAuth.getIsSignedIn()) return;

        try {
            const cloudData = await googleDrive.loadDriveFile("classes.json");
            if (!cloudData) return;

            // 比較本地和雲端資料
            const localData = JSON.stringify(classes);
            const cloudDataStr = JSON.stringify(cloudData);

            if (localData !== cloudDataStr) {
                // 如果資料不同，顯示確認對話框
                if (confirm("發現雲端檔案有更新，是否要同步？\n注意：同步後本地資料將被雲端資料覆蓋。")) {
                    // 用戶確認同步
                    markUpdating();
                    // 更新本地資料為雲端資料
                    classes = cloudData;
                    saveClassesLocal();
                    renderClassDropdown();
                    renderStudents();
                    markSynced();
                }
            }
        } catch (err) {
            console.error("檢查雲端檔案失敗:", err);
            if (err.message.includes("401") || err.message.includes("unauthorized")) {
                alert("登入已過期，請重新登入");
                handleLogout();
            }
        }
    }

    // 新增：監聽用戶活動
    function setupActivityListeners() {
        const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
        events.forEach(event => {
            document.addEventListener(event, resetInactivityTimer);
        });
    }

    // 性別->圖片
    const imageMap = {
        "男1":"https://img.icons8.com/?size=100&id=oqlkrpDy3clZ&format=png&color=000000",
        "男2":"https://img.icons8.com/?size=100&id=C3wj6TWvegSk&format=png&color=000000",
        "男3":"https://img.icons8.com/?size=100&id=2lwL3N2H9Tbm&format=png&color=000000",
        "女1":"https://img.icons8.com/?size=100&id=eNAHQgRxtqVv&format=png&color=000000",
        "女2":"https://img.icons8.com/?size=100&id=DH9FJ32siusV&format=png&color=000000",
        "女3":"https://img.icons8.com/?size=100&id=gvFfuFtdrY7s&format=png&color=000000"
    };
    const genderImageLabels={
        "男":["男1","男2","男3"],
        "女":["女1","女2","女3"]
    };

    // 修改狀態相關函數
    function markDirty(){
        document.getElementById("statusDirty").className = "red";
        document.getElementById("statusUpdating").className = "grey";
        document.getElementById("statusSynced").className = "grey";
        document.getElementById("syncStatusBar").title = "點擊進行同步";
        updatingState = false;
        hideSyncOverlay();
        enableSyncBar();
        startAutoSyncTimer(); // 開始倒數
    }

    function markUpdating(){
        document.getElementById("statusDirty").className = "grey";
        document.getElementById("statusUpdating").className = "yellow";
        document.getElementById("statusSynced").className = "grey";
        document.getElementById("syncStatusBar").title = "同步處理中...";
        updatingState = true;
        showSyncOverlay();
        disableSyncBar();
        stopAutoSyncTimer(); // 停止倒數
    }

    function markSynced(){
        document.getElementById("statusDirty").className = "grey";
        document.getElementById("statusUpdating").className = "grey";
        document.getElementById("statusSynced").className = "green";
        document.getElementById("syncStatusBar").title = "資料已同步";
        updatingState = false;
        hideSyncOverlay();
        enableSyncBar();
        stopAutoSyncTimer(); // 停止倒數
    }

    // 新增自動同步相關函數
    function startAutoSyncTimer() {
        // 如果未登入 Google，不啟動計時器
        if (!googleAuth.getIsSignedIn()) return;
        
        // 清除現有計時器
        stopAutoSyncTimer();
        
        // 設定初始倒數時間
        remainingSeconds = AUTO_SYNC_DELAY;
        updateSyncStatus();
        
        // 啟動新計時器
        autoSyncTimer = setInterval(() => {
            remainingSeconds--;
            updateSyncStatus();
            
            // 時間到，執行同步
            if (remainingSeconds <= 0) {
                clearInterval(autoSyncTimer);
                autoSyncTimer = null;
                performSync();
            }
        }, 1000);
    }

    function stopAutoSyncTimer() {
        if (autoSyncTimer) {
            clearInterval(autoSyncTimer);
            autoSyncTimer = null;
        }
        remainingSeconds = 0;
    }

    function updateSyncStatus() {
        let statusBar = document.getElementById("syncStatusBar");
        if (remainingSeconds > 0) {
            statusBar.title = `點擊同步 (${remainingSeconds}秒後自動同步)`;
            // 更新狀態文字
            document.getElementById("statusDirty").textContent = `有異動 (${remainingSeconds}s)`;
        } else {
            statusBar.title = "點擊進行同步";
            document.getElementById("statusDirty").textContent = "有異動";
        }
    }

    // 新增執行同步的函數
    function performSync() {
        // 檢查是否可以同步
        if (!googleAuth.getIsSignedIn()) {
            alert("尚未登入 Google");
            return;
        }
        if (updatingState) {
            alert("同步處理中，請稍候...");
            return;
        }
        
        // 執行同步
        markUpdating();
        googleDrive.saveDriveFile("classes.json", classes)
            .then(() => {
                markSynced();
            })
            .catch(err => {
                console.error("儲存失敗:", err);
                markDirty();
                
                // 檢查是否為 token 過期
                if (err.message.includes("401") || err.message.includes("unauthorized")) {
                    alert("登入已過期，請重新登入");
                    // 清除 token
                    localStorage.removeItem("googleAccessToken");
                    // 回到登入畫面
                    hideMainButtons();
                    backToLoginChoice();
                } else {
                    alert("同步失敗，請稍後再試");
                }
            });
    }

    // 新增狀態列啟用/禁用函數
    function enableSyncBar() {
        let bar = document.getElementById("syncStatusBar");
        bar.classList.remove("disabled");
    }

    function disableSyncBar() {
        let bar = document.getElementById("syncStatusBar");
        bar.classList.add("disabled");
    }

    // 更新中時顯示遮罩
    function showSyncOverlay(){
        document.getElementById("syncOverlay").classList.add("show");
        document.getElementById("syncPopup").classList.add("show");
    }
    function hideSyncOverlay(){
        document.getElementById("syncOverlay").classList.remove("show");
        document.getElementById("syncPopup").classList.remove("show");
    }

    // 檢查是否更新中(黃)
    function checkIfUpdating(){
        if(updatingState){
            alert("目前正在『更新中』，請稍後再操作。");
            return true;
        }
        return false;
    }

    // onload
    window.onload = () => {
        hideMainButtons();
        
        // 檢查是否已有 token
        if(googleAuth.getIsSignedIn()){
            showMainButtons();
            markSynced();
            loadClassesFromDrive();
            setupActivityListeners(); // 設置活動監聽器
            resetInactivityTimer(); // 開始不活動計時器
        } else {
            showLoginChoice();
        }

        // 初始化 googleAuth
        googleAuth.initGoogleAuth(
            ()=>{
                // onSuccess
                hideLoginProcessingOverlay();
                console.log("Google登入成功!");
                document.getElementById("login-btn").style.display = "none";
                document.getElementById("logout-btn").style.display = "inline-block";
                markSynced();
                loadClassesFromDrive();
                setupActivityListeners(); // 設置活動監聽器
                resetInactivityTimer(); // 開始不活動計時器
            },
            (err)=>{
                // onFailure
                hideLoginProcessingOverlay();
                console.log("Google登入失敗:",err);
                localStorage.removeItem("googleAccessToken"); // 移除無效的 token
                backToLoginChoice();
            }
        );

        initUI();
        renderClassDropdown();
        renderStudents();
    };

    // 初始化UI事件
    function initUI(){
        // 登入/登出
        document.getElementById("login-btn").addEventListener("click",()=>{
            showLoginProcessingOverlay();
            googleAuth.signIn();
        });
        document.getElementById("logout-btn").addEventListener("click",handleLogout);

        // 班級選擇
        let sel=document.getElementById("classSelect");
        sel.addEventListener("change",(evt)=>{
            if(checkIfUpdating()){ evt.target.value=currentClass; return; }
            currentClass=evt.target.value;
            renderStudents();
        });

        // CSV 匯入
        document.getElementById("importCSV").addEventListener("change",(evt)=>{
            if(checkIfUpdating()){
                evt.target.value="";
                return;
            }
            importCSV(evt);
        });

        // 點擊狀態列觸發同步
        let syncBar = document.getElementById("syncStatusBar");
        syncBar.addEventListener("click", () => {
            // 檢查是否需要同步
            let isDirty = document.getElementById("statusDirty").className === "red";
            if (!isDirty) {
                alert("資料已是最新狀態");
                return;
            }
            
            performSync();
        });

        // 學生popup
        document.getElementById("btnSaveStudent").addEventListener("click",saveStudent);
        document.getElementById("btnClosePopup").addEventListener("click",closePopup);
        document.getElementById("btnUploadImage").addEventListener("click",()=>{
            document.getElementById("customImageUpload").click();
        });
        document.getElementById("customImageUpload").addEventListener("change",handleCustomImageUpload);

        // 登入/離線popup
        document.getElementById("btnLoginNow").addEventListener("click",()=>{
            closeLoginChoice();
            showMainButtons();
            markDirty();
            showLoginProcessingOverlay();
            googleAuth.signIn();
        });
        document.getElementById("btnOffline").addEventListener("click",()=>{
            closeLoginChoice();
            showMainButtons();
            markDirty();
            alert("離線模式啟用，之後登入Google可能覆蓋資料。");
        });

        // 班級管理
        document.getElementById("btnAddClass").addEventListener("click",addClassPrompt);
        document.getElementById("btnCloseClassPopup").addEventListener("click",closeClassPopup);

        // 設定選單
        document.getElementById("btnScoreSettings").addEventListener("click", showScoreButtonsSettings);

        // 管理選單
        document.getElementById("btnClassManage").addEventListener("click", showClassPopup);
        document.getElementById("btnAddStudent").addEventListener("click", () => showPopup(-1));

        // 功能選單
        document.getElementById("btnExportCSV").addEventListener("click", exportCSV);
        document.getElementById("btnImportCSV").addEventListener("click", () => {
            document.getElementById("importCSV").click();
        });
        document.getElementById("btnWheel").addEventListener("click", () => {
            showWheelPopup();
        });

        // 添加 ESC 鍵關閉視窗功能
        window.addEventListener("keydown", (evt) => {
            if (evt.key === "Escape") {
                // 檢查各個視窗是否開啟
                if (document.getElementById("overlay").classList.contains("show")) {
                    closePopup();
                } else if (document.getElementById("loginOverlay").classList.contains("show")) {
                    closeLoginChoice();
                } else if (document.getElementById("classOverlay").classList.contains("show")) {
                    closeClassPopup();
                } else if (document.getElementById("settingsOverlay")?.classList.contains("show")) {
                    closeScoreButtonsSettings();
                } else if (document.getElementById("wheelOverlay").classList.contains("show")) {
                    closeWheelPopup();
                } else if (document.getElementById("helpOverlay").classList.contains("show")) {
                    closeHelpPopup();
                }
            }
        });

        // 使用說明
        document.getElementById("btnHelp").addEventListener("click", showHelpPopup);
    }

    // 登出
    function handleLogout(){
        if(!googleAuth.getAccessToken()){
            alert("尚未登入");
            return;
        }
        stopAutoSyncTimer(); // 停止自動同步計時器
        if (inactivityTimer) {
            clearTimeout(inactivityTimer); // 清除不活動計時器
        }
        googleAuth.signOut(()=>{
            console.log("已登出");
            hideMainButtons();
            backToLoginChoice();
        });
    }

    // 顯示/隱藏主功能按鈕
    function hideMainButtons(){
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("logout-btn").style.display = "none";
        document.getElementById("classSelect").style.display = "none";
        document.querySelectorAll(".dropdown").forEach(dropdown => {
            dropdown.style.display = "none";
        });
    }
    function showMainButtons(){
        let isSigned = googleAuth.getIsSignedIn();
        document.getElementById("login-btn").style.display = isSigned ? "none" : "inline-block";
        document.getElementById("logout-btn").style.display = isSigned ? "inline-block" : "none";
        document.getElementById("classSelect").style.display = "inline-block";
        document.querySelectorAll(".dropdown").forEach(dropdown => {
            dropdown.style.display = "inline-block";
        });
    }

    // 登入選擇視窗
    function showLoginChoice(){
        document.getElementById("loginOverlay").classList.add("show");
        document.getElementById("loginPopup").classList.add("show");
    }
    function closeLoginChoice(){
        document.getElementById("loginOverlay").classList.remove("show");
        document.getElementById("loginPopup").classList.remove("show");
    }
    function backToLoginChoice(){
        hideLoginProcessingOverlay();
        showLoginChoice();
    }

    // 登入處理中
    function showLoginProcessingOverlay(){
        document.getElementById("loginProcessingOverlay").classList.add("show");
        document.getElementById("loginProcessingPopup").classList.add("show");
    }
    function hideLoginProcessingOverlay(){
        document.getElementById("loginProcessingOverlay").classList.remove("show");
        document.getElementById("loginProcessingPopup").classList.remove("show");
    }

    // 讀/寫 localStorage
    function saveClassesLocal(){
        localStorage.setItem("classes", JSON.stringify(classes));
    }

    // 從 Google Drive 載入 classes.json
    async function loadClassesFromDrive(){
        if(!googleAuth.getIsSignedIn()) return;
        try {
            let data = await googleDrive.loadDriveFile("classes.json");
            if(data){
                // 確保 scoreButtons 存在
                if (!data.scoreButtons) {
                    data.scoreButtons = [-5, -1, 1, 5];  // 使用預設值
                }
                classes = data;
                saveClassesLocal();
                if(!classes[currentClass]){
                    currentClass = Object.keys(classes).find(key => key !== 'scoreButtons') || "一班";
                }
                renderClassDropdown();
                renderStudents();
                markSynced();
            } else {
                console.log("未找到 classes.json => 等使用者手動同步建立");
                markDirty();
            }
        } catch(err){
            console.error("loadClasses失敗:",err);
            markDirty();
        }
    }

    // 班級
    function renderClassDropdown(){
        let sel = document.getElementById("classSelect");
        sel.innerHTML = "";
        for(let cName in classes){
            // 跳過 scoreButtons
            if(cName === 'scoreButtons') continue;
            
            let opt = document.createElement("option");
            opt.value = cName;
            opt.textContent = cName;
            if(cName === currentClass) opt.selected = true;
            sel.appendChild(opt);
        }
    }
    function getStudents(){
        if(!classes[currentClass]) classes[currentClass]=[];
        return classes[currentClass];
    }
    function renderStudents(){
        let arr=getStudents();
        let container=document.getElementById("studentContainer");
        container.innerHTML="";
        arr.forEach((st,idx)=>{
            let card=document.createElement("div");
            card.classList.add("student-card");
            let imgSrc = st.customImage || imageMap[st.imageLabel] || "";
            
            // 添加拖拉屬性
            card.draggable = true;
            card.dataset.index = idx;
            
            // 添加拖拉事件監聽器
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleDrop);
            
            // 根據分數正負決定按鈕類別
            const getButtonClass = (score) => {
                return score >= 0 ? 'positive' : 'negative';
            };
            
            card.innerHTML=`
      <button class="delete-btn" onclick="deleteStudent(${idx})">×</button>
      <img src="${imgSrc}" alt="${st.gender}" onclick="editStudent(${idx})">
      <p>${st.name}</p>
      <p id="score-${idx}">${st.score} 分</p>
      <button class="btn-score ${getButtonClass(classes.scoreButtons[0])}" onclick="updateScore(${idx}, ${classes.scoreButtons[0]})">${classes.scoreButtons[0] >= 0 ? '+' : ''}${classes.scoreButtons[0]}</button>
      <button class="btn-score ${getButtonClass(classes.scoreButtons[1])}" onclick="updateScore(${idx}, ${classes.scoreButtons[1]})">${classes.scoreButtons[1] >= 0 ? '+' : ''}${classes.scoreButtons[1]}</button>
      <button class="btn-score ${getButtonClass(classes.scoreButtons[2])}" onclick="updateScore(${idx}, ${classes.scoreButtons[2]})">${classes.scoreButtons[2] >= 0 ? '+' : ''}${classes.scoreButtons[2]}</button>
      <button class="btn-score ${getButtonClass(classes.scoreButtons[3])}" onclick="updateScore(${idx}, ${classes.scoreButtons[3]})">${classes.scoreButtons[3] >= 0 ? '+' : ''}${classes.scoreButtons[3]}</button>
      <div class="quickAdjust">
        <select id="sign-${idx}"">
          <option value="+">+</option>
          <option value="-">-</option>
        </select>
        <input type="number" id="custom-${idx}" placeholder="自訂分數" style="width:60px;">
        <button onclick="customAdjust(${idx})">確定</button>
      </div>
    `;
            container.appendChild(card);
        });
    }

    // 拖拉相關函數
    function handleDragStart(e) {
        this.classList.add('dragging');
        e.dataTransfer.setData('text/plain', this.dataset.index);
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.student-card').forEach(card => {
            card.classList.remove('drag-over');
        });
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
        const toIndex = parseInt(this.dataset.index);
        
        if (fromIndex === toIndex) return;
        
        // 更新陣列順序
        const arr = getStudents();
        const [movedStudent] = arr.splice(fromIndex, 1);
        arr.splice(toIndex, 0, movedStudent);
        
        // 儲存並重新渲染
        saveClassesLocal();
        renderStudents();
        markDirty();
    }

    // 防止更新中修改
    window.editStudent=function(idx){
        if(checkIfUpdating()) return;
        showPopup(idx);
    };
    window.updateScore=function(idx,delta){
        if(checkIfUpdating()) return;
        let arr=getStudents();
        arr[idx].score+=delta;
        saveClassesLocal();
        document.getElementById(`score-${idx}`).textContent=arr[idx].score+" 分";
        markDirty();
    };
    window.customAdjust=function(idx){
        if(checkIfUpdating()) return;
        let arr=getStudents();
        let signSel=document.getElementById(`sign-${idx}`);
        let customIn=document.getElementById(`custom-${idx}`);
        let sign=signSel.value;
        let val=parseInt(customIn.value)||0;
        if(sign==="-") val=-val;
        arr[idx].score+=val;
        saveClassesLocal();
        document.getElementById(`score-${idx}`).textContent=arr[idx].score+" 分";
        customIn.value="";
        markDirty();
    };
    window.deleteStudent=function(idx){
        if(checkIfUpdating()) return;
        if(!confirm("確定要刪除這位學生嗎？"))return;
        let arr=getStudents();
        arr.splice(idx,1);
        saveClassesLocal();
        renderStudents();
        markDirty();
    };

    // 處理自訂圖片上傳
    async function handleCustomImageUpload(evt) {
        const file = evt.target.files[0];
        if (!file) return;

        // 檢查檔案類型
        if (!file.type.startsWith('image/')) {
            alert('請上傳圖片檔案');
            return;
        }

        // 檢查檔案大小（限制為 5MB）
        if (file.size > 5 * 1024 * 1024) {
            alert('圖片大小不能超過 5MB');
            return;
        }

        // 檢查是否已登入 Google
        if (!googleAuth.getIsSignedIn()) {
            alert('請先登入 Google 帳號才能上傳圖片');
            return;
        }

        try {
            // 顯示上傳中的提示
            const preview = document.getElementById('customImagePreview');
            preview.innerHTML = '<p>圖片上傳中...</p>';

            // 上傳到 Google Drive
            const fileId = await googleDrive.uploadImageToDrive(file);
            customImageFileId = fileId;
            
            // 取得圖片的公開連結
            const imageUrl = await googleDrive.getImageUrlFromDrive(fileId);
            customImageData = imageUrl;
            
            // 更新預覽
            preview.innerHTML = `
                <img src="${imageUrl}" alt="自訂圖片">
                <button onclick="clearCustomImage()" style="display:block; margin:5px auto; background:#ff4d4d;">移除自訂圖片</button>
            `;
            
            // 取消選擇預設圖片
            document.querySelectorAll(".image-preview img").forEach(x => x.classList.remove("selected"));
            selectedImage = "";

            // 更新已上傳圖片集合
            uploadedImages.add(JSON.stringify({
                url: imageUrl,
                id: fileId
            }));
            
            // 更新已上傳圖片區域
            updateUploadedImagesSection();
        } catch (err) {
            console.error('圖片上傳失敗:', err);
            alert('圖片上傳失敗，請稍後再試');
            preview.innerHTML = '';
        }
    }

    // 新增：清除自訂圖片的函數
    window.clearCustomImage = function() {
        customImageData = null;
        customImageFileId = null;
        document.getElementById("customImagePreview").innerHTML = "";
        document.getElementById("customImageUpload").value = "";
        
        // 清除已上傳圖片的選中狀態
        document.querySelectorAll('.uploaded-images-grid img').forEach(img => {
            img.classList.remove('selected');
        });
        
        // 選擇第一個預設圖片
        let gender = document.getElementById("studentGender").value;
        let labels = genderImageLabels[gender];
        selectedImage = labels[0];
        updateImagePreview();
    };

    // 新增/編輯 學生
    async function showPopup(idx=-1){
        editIndex = idx;
        document.getElementById("overlay").classList.add("show");
        document.getElementById("studentPopup").classList.add("show");
        
        let genderSelect = document.getElementById("studentGender");
        genderSelect.addEventListener("change", updateImagePreview);
        
        customImageData = null;
        customImageFileId = null;
        document.getElementById("customImagePreview").innerHTML = "";
        document.getElementById("customImageUpload").value = "";
        
        // 改為非同步收集圖片
        collectUploadedImages().then(() => {
            updateUploadedImagesSection();
            
            if(idx === -1){
                document.getElementById("popupTitle").textContent = "新增學生";
                document.getElementById("studentName").value = "";
                document.getElementById("studentScore").value = 0;
                genderSelect.value = "男";
                selectedImage = "";
            } else {
                document.getElementById("popupTitle").textContent = "編輯學生";
                let arr = getStudents();
                let st = arr[idx];
                document.getElementById("studentName").value = st.name;
                document.getElementById("studentScore").value = st.score;
                genderSelect.value = st.gender;
                selectedImage = st.imageLabel;
                
                // 如果有自訂圖片，顯示它
                if (st.customImage) {
                    customImageData = st.customImage;
                    customImageFileId = st.customImageFileId;
                    document.getElementById("customImagePreview").innerHTML = 
                        `<img src="${st.customImage}" alt="自訂圖片">
                         <button onclick="clearCustomImage()" style="display:block; margin:5px auto; background:#ff4d4d;">移除自訂圖片</button>`;
                }
            }
            updateImagePreview();
        });
    }
    function closePopup(){
        // 移除性別選擇的事件監聽器
        let genderSelect = document.getElementById("studentGender");
        genderSelect.removeEventListener("change", updateImagePreview);
        
        document.getElementById("overlay").classList.remove("show");
        document.getElementById("studentPopup").classList.remove("show");
    }
    function updateImagePreview(){
        let gender = document.getElementById("studentGender").value;
        let imageSelection = document.getElementById("imageSelection");
        imageSelection.innerHTML = "";
        let labels = genderImageLabels[gender];
        
        // 如果切換性別後，之前選中的圖片不屬於新性別，則重置選擇
        if(selectedImage && !labels.includes(selectedImage)){
            selectedImage = "";
        }
        
        labels.forEach((lbl, idx) => {
            let img = document.createElement("img");
            img.src = imageMap[lbl];
            img.onclick = () => {
                document.querySelectorAll(".image-preview img").forEach(x => x.classList.remove("selected"));
                img.classList.add("selected");
                selectedImage = lbl;
                // 清除自訂圖片
                customImageData = null;
                customImageFileId = null;
                document.getElementById("customImagePreview").innerHTML = "";
                document.getElementById("customImageUpload").value = "";
            };
            
            // 選中圖片的邏輯：如果沒有自訂圖片時才套用
            if(!customImageData && ((idx === 0 && !selectedImage) || selectedImage === lbl)){
                img.classList.add("selected");
                selectedImage = lbl;
            }
            
            imageSelection.appendChild(img);
        });
    }
    function saveStudent(){
        if(checkIfUpdating()) return;
        let name=document.getElementById("studentName").value.trim();
        let score=parseInt(document.getElementById("studentScore").value)||0;
        let gender=document.getElementById("studentGender").value;
        
        // 處理圖片選擇
        let imageData = null;
        let imageFileId = null;
        let imageLabel = "";
        
        if (customImageData) {
            imageData = customImageData;
            imageFileId = customImageFileId;
            imageLabel = "";  // 使用自訂圖片時，清空 imageLabel
        } else {
            imageLabel = selectedImage || genderImageLabels[gender][0];
        }
        
        if(!name){
            alert("請輸入學生姓名");
            return;
        }
        
        let arr=getStudents();
        if(editIndex===-1){
            arr.push({ 
                name,
                score,
                gender,
                imageLabel,
                customImage: imageData,
                customImageFileId: imageFileId
            });
        }else{
            arr[editIndex]={
                name,
                score,
                gender,
                imageLabel,
                customImage: imageData,
                customImageFileId: imageFileId
            };
        }
        saveClassesLocal();
        closePopup();
        renderStudents();
        markDirty();
    }

    // CSV
    function exportCSV(){
        if(checkIfUpdating()) return;
        let arr=getStudents();
        let csv="姓名,分數,性別,預設圖片,自訂圖片ID\n"+
            arr.map(s=>`${s.name},${s.score},${s.gender},${s.imageLabel || ''},${s.customImageFileId || ''}`).join("\n");
        let blob=new Blob([csv],{type:"text/csv"});
        let a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download=`${currentClass}-students.csv`;
        a.click();
    }

    async function importCSV(evt){
        let file=evt.target.files[0];
        if(!file)return;

        // 檢查是否已登入 Google
        if (!googleAuth.getIsSignedIn()) {
            alert('請先登入 Google 帳號才能匯入包含自訂圖片的資料');
            return;
        }

        let reader=new FileReader();
        reader.onload=async (e)=>{
            let lines=e.target.result.split("\n").map(x=>x.trim()).filter(x=>x);
            let headers = lines.shift().split(',');
            let hasCustomImage = headers.includes('自訂圖片ID');

            let newArr = [];
            for(let line of lines) {
                let [name, score, gender, imageLabel, customImageFileId=''] = line.split(",");
                score = parseInt(score) || 0;
                
                // 處理預設圖片
                if(!imageLabel){
                    let labs = genderImageLabels[gender] || ["男1"];
                    imageLabel = labs[0];
                }

                // 建立學生資料物件
                let student = { 
                    name, 
                    score, 
                    gender, 
                    imageLabel
                };

                // 如果有自訂圖片ID，嘗試取得圖片URL
                if(hasCustomImage && customImageFileId) {
                    try {
                        const imageUrl = await googleDrive.getImageUrlFromDrive(customImageFileId);
                        student.customImage = imageUrl;
                        student.customImageFileId = customImageFileId;
                    } catch(err) {
                        console.warn(`無法取得圖片 ${customImageFileId} 的URL:`, err);
                        // 如果取得圖片失敗，使用預設圖片
                        student.customImage = null;
                        student.customImageFileId = null;
                    }
                }

                newArr.push(student);
            }
            
            classes[currentClass] = newArr;
            saveClassesLocal();
            renderStudents();
            markDirty();
        };
        reader.readAsText(file);
    }

    // 班級管理
    function showClassPopup(){
        if(checkIfUpdating()) return;
        document.getElementById("classOverlay").classList.add("show");
        document.getElementById("classPopup").classList.add("show");
        renderClassList();
    }
    function closeClassPopup(){
        document.getElementById("classOverlay").classList.remove("show");
        document.getElementById("classPopup").classList.remove("show");
    }
    function renderClassList(){
        let listEl=document.getElementById("classList");
        listEl.innerHTML="";
        // 過濾掉特殊屬性：scoreButtons 和 rewards
        let cNames = Object.keys(classes).filter(key => !['scoreButtons', 'rewards'].includes(key));
        cNames.forEach(cName=>{
            let div=document.createElement("div");
            div.classList.add("class-item");
            let disableDelete=(cNames.length<=1)?true:false;
            let html=`
      <span class="class-name">${cName}</span>
      <div>
        <button class="btn-rename">修改</button>
        <button class="btn-delete-class" ${disableDelete?"disabled":""}>刪除</button>
      </div>
    `;
            div.innerHTML=html;
            let renameBtn=div.querySelector(".btn-rename");
            let delBtn=div.querySelector(".btn-delete-class");
            renameBtn.addEventListener("click",()=> renameClassPrompt(cName));
            delBtn.addEventListener("click",()=>{
                if(disableDelete){
                    alert("只剩最後一個班級，無法刪除");
                    return;
                }
                deleteClass(cName);
            });
            listEl.appendChild(div);
        });
    }
    function addClassPrompt(){
        if(checkIfUpdating()) return;
        let newName=prompt("請輸入新班級名稱：");
        if(!newName)return;
        newName=newName.trim();
        if(!newName)return;
        if(classes[newName]){
            alert("此班級已存在");
            return;
        }
        classes[newName]=[];
        saveClassesLocal();
        currentClass=newName;
        renderClassDropdown();
        renderStudents();
        renderClassList();
        markDirty();
    }
    function renameClassPrompt(oldName){
        if(checkIfUpdating()) return;
        let newName=prompt("新的班級名稱", oldName);
        if(!newName)return;
        newName=newName.trim();
        if(!newName|| newName===oldName)return;
        if(classes[newName]){
            alert("此班級已存在");
            return;
        }
        classes[newName]=classes[oldName];
        delete classes[oldName];
        if(currentClass===oldName) currentClass=newName;
        saveClassesLocal();
        renderClassDropdown();
        renderStudents();
        renderClassList();
        markDirty();
    }
    function deleteClass(cName){
        if(checkIfUpdating()) return;
        let cCount=Object.keys(classes).length;
        if(cCount<=1){
            alert("只剩最後一個班級，無法刪除");
            return;
        }
        if(!confirm(`確定刪除「${cName}」?`))return;
        delete classes[cName];
        currentClass=Object.keys(classes)[0];
        saveClassesLocal();
        renderClassDropdown();
        renderStudents();
        renderClassList();
        markDirty();
    }

    // 修改收集已上傳圖片的函數
    async function collectUploadedImages() {
        uploadedImages.clear();

        // 1. 先加入當前頁面上的圖片
        Object.values(classes).forEach(students => {
            students.forEach(student => {
                if (student.customImage && student.customImageFileId) {
                    uploadedImages.add(JSON.stringify({
                        url: student.customImage,
                        id: student.customImageFileId,
                        name: '使用中的圖片'
                    }));
                }
            });
        });

        try {
            // 2. 從 Google Drive 取得所有圖片
            const driveImages = await googleDrive.getAllImages();
            driveImages.forEach(img => {
                uploadedImages.add(JSON.stringify({
                    url: img.url,
                    id: img.id,
                    name: img.name
                }));
            });
        } catch(err) {
            console.error('取得 Google Drive 圖片失敗:', err);
        }
    }

    // 修改顯示已上傳圖片的函數
    function updateUploadedImagesSection() {
        const customImageUpload = document.querySelector('.custom-image-upload');
        
        // 移除舊的已上傳圖片區域
        const oldSection = document.querySelector('.uploaded-images-section');
        if (oldSection) {
            oldSection.remove();
        }

        // 如果有已上傳的圖片，建立新的區域
        if (uploadedImages.size > 0) {
            const section = document.createElement('div');
            section.className = 'uploaded-images-section';
            section.innerHTML = `
                <h4>選擇已上傳的圖片</h4>
                <div class="uploaded-images-grid"></div>
            `;

            const grid = section.querySelector('.uploaded-images-grid');
            [...uploadedImages].forEach(imageInfo => {
                const { url, id, name } = JSON.parse(imageInfo);
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-container';
                imgContainer.innerHTML = `
                    <img src="${url}" alt="${name}" title="${name}">
                    <button class="image-delete-btn" title="刪除圖片">×</button>
                    <div class="image-name">${name}</div>
                `;
                
                const img = imgContainer.querySelector('img');
                if (customImageData === url) {
                    img.classList.add('selected');
                }
                
                // 圖片點擊事件
                img.onclick = () => {
                    document.querySelectorAll('.uploaded-images-grid img').forEach(img => {
                        img.classList.remove('selected');
                    });
                    document.querySelectorAll('.image-preview img').forEach(img => {
                        img.classList.remove('selected');
                    });
                    img.classList.add('selected');
                    
                    customImageData = url;
                    customImageFileId = id;
                    selectedImage = "";
                    
                    document.getElementById('customImagePreview').innerHTML = `
                        <img src="${url}" alt="${name}">
                        <button onclick="clearCustomImage()" style="display:block; margin:5px auto; background:#ff4d4d;">移除自訂圖片</button>
                    `;
                };

                // 刪除按鈕點擊事件
                const deleteBtn = imgContainer.querySelector('.image-delete-btn');
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();  // 防止觸發圖片的點擊事件
                    
                    // 檢查圖片是否正在使用中
                    let isInUse = false;
                    Object.values(classes).forEach(students => {
                        students.forEach(student => {
                            if (student.customImageFileId === id) {
                                isInUse = true;
                            }
                        });
                    });

                    if (isInUse) {
                        alert('此圖片正在使用中，無法刪除');
                        return;
                    }

                    if (!confirm('確定要刪除這張圖片嗎？')) return;

                    try {
                        await googleDrive.deleteFile(id);
                        
                        // 如果刪除的是目前選中的圖片，清除預覽
                        if (customImageFileId === id) {
                            clearCustomImage();
                        }
                        
                        // 從集合中移除
                        uploadedImages.delete(imageInfo);
                        
                        // 重新渲染圖片區域
                        updateUploadedImagesSection();
                    } catch (err) {
                        alert('刪除失敗，請稍後再試');
                    }
                };
                
                grid.appendChild(imgContainer);
            });

            customImageUpload.appendChild(section);
        }
    }

    // 新增設定視窗的 HTML
    function addSettingsPopup() {
        const overlay = document.createElement("div");
        overlay.id = "settingsOverlay";
        overlay.className = "overlay";
        
        const popup = document.createElement("div");
        popup.id = "settingsPopup";
        popup.className = "popup";
        popup.innerHTML = `
            <h3>分數按鈕設定</h3>
            <p>請設定四個按鈕的分數值：</p>
            <div style="display:flex; flex-direction:column; gap:10px; margin:15px 0;">
                <div>
                    <label>第一個按鈕：</label>
                    <input type="number" id="btn1" value="${classes.scoreButtons[0]}">
                </div>
                <div>
                    <label>第二個按鈕：</label>
                    <input type="number" id="btn2" value="${classes.scoreButtons[1]}">
                </div>
                <div>
                    <label>第三個按鈕：</label>
                    <input type="number" id="btn3" value="${classes.scoreButtons[2]}">
                </div>
                <div>
                    <label>第四個按鈕：</label>
                    <input type="number" id="btn4" value="${classes.scoreButtons[3]}">
                </div>
            </div>
            <button onclick="saveScoreButtonsSettings()" style="background:#4caf50;">儲存</button>
            <button onclick="closeScoreButtonsSettings()" style="background:#757575;">取消</button>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(popup);
    }

    // 顯示設定視窗
    function showScoreButtonsSettings() {
        if(checkIfUpdating()) return;
        
        // 如果設定視窗不存在，先建立
        if (!document.getElementById("settingsOverlay")) {
            addSettingsPopup();
        }
        
        document.getElementById("settingsOverlay").classList.add("show");
        document.getElementById("settingsPopup").classList.add("show");
    }

    // 關閉設定視窗
    function closeScoreButtonsSettings() {
        document.getElementById("settingsOverlay").classList.remove("show");
        document.getElementById("settingsPopup").classList.remove("show");
    }

    // 儲存設定
    function saveScoreButtonsSettings() {
        if(checkIfUpdating()) return;
        
        const btn1 = parseInt(document.getElementById("btn1").value) || 0;
        const btn2 = parseInt(document.getElementById("btn2").value) || 0;
        const btn3 = parseInt(document.getElementById("btn3").value) || 0;
        const btn4 = parseInt(document.getElementById("btn4").value) || 0;
        
        classes.scoreButtons = [btn1, btn2, btn3, btn4];
        saveClassesLocal();
        renderStudents();
        closeScoreButtonsSettings();
        markDirty();
    }

    // 將新函數加入 window 物件
    window.showScoreButtonsSettings = showScoreButtonsSettings;
    window.closeScoreButtonsSettings = closeScoreButtonsSettings;
    window.saveScoreButtonsSettings = saveScoreButtonsSettings;

    // 輪轉盤相關變數
    let wheelCanvas = null;
    let wheelCtx = null;
    let wheelRotation = 0;
    let isSpinning = false;
    let selectedStudents = new Set();
    let wheelAnimation = null;
    let isRewardWheel = false; // 新增：是否為獎懲輪轉盤
    let rewards = classes.rewards || ["獎勵", "懲罰"]; // 從 classes 中讀取獎懲項目

    // 輪轉盤視窗
    function showWheelPopup() {
        if(checkIfUpdating()) return;
        
        document.getElementById("wheelOverlay").classList.add("show");
        const wheelPopup = document.getElementById("wheelPopup");
        wheelPopup.classList.add("show");
        wheelPopup.classList.add("enlarged");
        
        // 初始化畫布
        wheelCanvas = document.getElementById("wheelCanvas");
        wheelCtx = wheelCanvas.getContext("2d");
        
        // 設置畫布大小
        wheelCanvas.width = 600;
        wheelCanvas.height = 600;
        
        // 初始化事件監聽器
        document.getElementById("btnSpinWheel").addEventListener("click", startSpinning);
        document.getElementById("btnCloseWheel").addEventListener("click", closeWheelPopup);
        document.getElementById("btnResetWheel").addEventListener("click", resetSelectedStudents);
        document.getElementById("btnStudentWheel").addEventListener("click", () => switchWheelType(false));
        document.getElementById("btnRewardWheel").addEventListener("click", () => switchWheelType(true));
        document.getElementById("btnAddReward").addEventListener("click", addNewReward);
        
        // 點擊輪轉盤時停止轉動
        wheelCanvas.addEventListener("click", () => {
            if (isSpinning) {
                isSpinning = false;
                if (wheelAnimation) {
                    cancelAnimationFrame(wheelAnimation);
                }
            }
        });
        
        // 渲染輪轉盤
        renderWheel();
        
        // 更新已選列表
        updateSelectedList();
        
        // 更新獎懲列表
        updateRewardList();
    }

    // 修改：渲染輪轉盤函數
    function renderWheel() {
        const items = isRewardWheel ? rewards : getStudents();
        const noRepeat = document.getElementById("noRepeat")?.checked;
        const availableItems = noRepeat ? 
            (isRewardWheel ? items.filter(item => !selectedStudents.has(item)) : items.filter(s => !selectedStudents.has(s.name))) : 
            items;
        
        if (!wheelCanvas || !wheelCtx) {
            wheelCanvas = document.getElementById("wheelCanvas");
            wheelCtx = wheelCanvas.getContext("2d");
            if (!wheelCanvas || !wheelCtx) return;
        }

        if (availableItems.length === 0) {
            wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
            wheelCtx.fillStyle = "#f5f5f5";
            wheelCtx.beginPath();
            wheelCtx.arc(wheelCanvas.width/2, wheelCanvas.height/2, wheelCanvas.width/2 - 10, 0, Math.PI * 2);
            wheelCtx.fill();
            
            wheelCtx.fillStyle = "#666";
            wheelCtx.font = "24px Arial";
            wheelCtx.textAlign = "center";
            wheelCtx.textBaseline = "middle";
            wheelCtx.fillText("所有項目都已選過", wheelCanvas.width/2, wheelCanvas.height/2);
            return;
        }

        const centerX = wheelCanvas.width / 2;
        const centerY = wheelCanvas.height / 2;
        const radius = Math.min(centerX, centerY) - 10;
        const colors = ["#FF5733", "#33FF57", "#3357FF", "#F333FF", "#33FFF3", "#FF3333"];

        wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
        
        // 繪製扇形
        const angleStep = (Math.PI * 2) / availableItems.length;
        availableItems.forEach((item, index) => {
            const startAngle = index * angleStep + wheelRotation;
            const endAngle = (index + 1) * angleStep + wheelRotation;

            wheelCtx.beginPath();
            wheelCtx.moveTo(centerX, centerY);
            wheelCtx.arc(centerX, centerY, radius, startAngle, endAngle);
            wheelCtx.closePath();
            wheelCtx.fillStyle = colors[index % colors.length];
            wheelCtx.fill();
            wheelCtx.strokeStyle = "#fff";
            wheelCtx.lineWidth = 3;
            wheelCtx.stroke();

            // 繪製文字
            wheelCtx.save();
            wheelCtx.translate(centerX, centerY);
            wheelCtx.rotate(startAngle + angleStep / 2);
            wheelCtx.textAlign = "right";
            wheelCtx.fillStyle = "#fff";
            wheelCtx.font = "18px Arial";
            wheelCtx.fillText(isRewardWheel ? item : item.name, radius - 30, 5);
            wheelCtx.restore();
        });
    }

    // 修改：關閉輪轉盤
    function closeWheelPopup() {
        const wheelPopup = document.getElementById("wheelPopup");
        document.getElementById("wheelOverlay").classList.remove("show");
        wheelPopup.classList.remove("show");
        wheelPopup.classList.remove("enlarged");
        if (wheelAnimation) {
            cancelAnimationFrame(wheelAnimation);
        }
    }

    // 切換輪轉盤類型
    function switchWheelType(isReward) {
        isRewardWheel = isReward;
        document.getElementById("btnStudentWheel").classList.toggle("active", !isReward);
        document.getElementById("btnRewardWheel").classList.toggle("active", isReward);
        document.getElementById("wheelTitle").textContent = isReward ? "獎懲輪轉盤" : "學生輪轉盤";
        document.getElementById("rewardControls").style.display = isReward ? "block" : "none";
        selectedStudents.clear();
        updateSelectedList();
        renderWheel();
    }

    // 新增獎懲項目
    function addNewReward() {
        const input = document.getElementById("newReward");
        const newReward = input.value.trim();
        
        if (newReward && !rewards.includes(newReward)) {
            rewards.unshift(newReward);
            classes.rewards = rewards; // 保存到 classes 物件
            saveClassesLocal(); // 保存到 localStorage
            updateRewardList();
            renderWheel();
            input.value = "";
            markDirty(); // 標記需要同步
        }
    }

    // 刪除獎懲項目
    window.deleteReward = function(index) {
        if (rewards.length <= 2) {
            alert("至少需要保留兩個獎懲項目！");
            return;
        }
        rewards.splice(index, 1);
        classes.rewards = rewards; // 保存到 classes 物件
        saveClassesLocal(); // 保存到 localStorage
        updateRewardList();
        renderWheel();
        markDirty(); // 標記需要同步
    };

    // 更新獎懲列表
    function updateRewardList() {
        const rewardList = document.getElementById("rewardList");
        rewardList.innerHTML = "";
        
        rewards.forEach((reward, index) => {
            const div = document.createElement("div");
            div.className = "reward-item";
            div.innerHTML = `
                ${reward}
                <button onclick="deleteReward(${index})">×</button>
            `;
            rewardList.appendChild(div);
        });
    }

    // 更新已選列表
    function updateSelectedList() {
        const selectedList = document.getElementById("selectedList");
        selectedList.innerHTML = "";
        
        // 將 Set 轉換為陣列並反轉順序，這樣最新的會在最前面
        const selectedArray = Array.from(selectedStudents).reverse();
        
        selectedArray.forEach((item, index) => {
            const li = document.createElement("li");
            if (isRewardWheel) {
                li.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${item}
                    </div>
                    <button onclick="removeSelectedStudent('${item}')">×</button>
                `;
            } else {
                const student = getStudents().find(s => s.name === item);
                if (student) {
                    const imgSrc = student.customImage || imageMap[student.imageLabel] || "";
                    li.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="min-width: 25px; color: #666;">${selectedArray.length - index}.</span>
                            <img src="${imgSrc}" alt="${student.gender}" style="width: 30px; height: 30px; border-radius: 50%;">
                            ${item}
                        </div>
                        <button onclick="removeSelectedStudent('${item}')">×</button>
                    `;
                }
            }
            selectedList.appendChild(li);
        });
    }

    // 開始轉動
    function startSpinning() {
        if (isSpinning) return;
        
        const items = isRewardWheel ? rewards : getStudents();
        const noRepeat = document.getElementById("noRepeat").checked;
        const availableItems = noRepeat ? 
            (isRewardWheel ? items.filter(item => !selectedStudents.has(item)) : items.filter(s => !selectedStudents.has(s.name))) : 
            items;
        
        if (availableItems.length === 0) {
            alert("所有項目都已選過！");
            return;
        }

        // 隱藏其他元素
        document.querySelector('.wheel-type-switch').style.display = 'none';
        document.querySelector('.wheel-controls-container').style.display = 'none';
        document.querySelector('.selected-students').style.display = 'none';
        document.getElementById('rewardControls').style.display = 'none';
        document.getElementById('wheelTitle').style.display = 'none';

        // 調整輪轉盤容器大小
        const wheelContainer = document.querySelector('.wheel-container');
        wheelContainer.style.width = '90vh';
        wheelContainer.style.height = '90vh';
        wheelCanvas.width = wheelContainer.clientWidth;
        wheelCanvas.height = wheelContainer.clientHeight;

        isSpinning = true;
        const spinDuration = 3000; // 3秒
        const startTime = Date.now();
        const startRotation = wheelRotation;
        const totalRotation = Math.PI * 8 + Math.random() * Math.PI * 2; // 至少轉4圈

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / spinDuration, 1);
            
            // 使用緩動函數
            const easeOut = 1 - Math.pow(1 - progress, 3);
            wheelRotation = startRotation + totalRotation * easeOut;
            
            renderWheel();
            
            if (progress < 1) {
                wheelAnimation = requestAnimationFrame(animate);
            } else {
                isSpinning = false;
                // 計算選中的項目
                const angleStep = (Math.PI * 2) / availableItems.length;
                // 調整角度計算，考慮指針在頂部（270度）的位置
                const pointerAngle = Math.PI * 1.5; // 270度
                let finalAngle = (-wheelRotation + pointerAngle) % (Math.PI * 2);
                if (finalAngle < 0) {
                    finalAngle += Math.PI * 2;
                }
                const selectedIndex = Math.floor(finalAngle / angleStep);
                const selectedItem = availableItems[selectedIndex];
                
                if (selectedItem) {
                    // 只有在勾選不重複時，才將項目加入已選名單
                    if (noRepeat) {
                        selectedStudents.add(isRewardWheel ? selectedItem : selectedItem.name);
                        updateSelectedList();
                    }
                    
                    // 先顯示選中結果
                    alert(`選中：${isRewardWheel ? selectedItem : selectedItem.name}`);
                    
                    // 恢復其他元素的顯示
                    document.querySelector('.wheel-type-switch').style.display = 'flex';
                    document.querySelector('.wheel-controls-container').style.display = 'flex';
                    document.querySelector('.selected-students').style.display = 'flex';
                    document.getElementById('rewardControls').style.display = isRewardWheel ? 'block' : 'none';
                    document.getElementById('wheelTitle').style.display = 'block';

                    // 恢復輪轉盤容器的原始大小
                    const wheelContainer = document.querySelector('.wheel-container');
                    wheelContainer.style.width = '600px';
                    wheelContainer.style.height = '600px';
                    wheelCanvas.width = 600;
                    wheelCanvas.height = 600;

                    // 確保重新渲染輪轉盤
                    setTimeout(() => {
                        renderWheel();
                    }, 0);
                }
            }
        }

        animate();
    }

    // 重置已選名單
    function resetSelectedStudents() {
        selectedStudents.clear();
        updateSelectedList();
        renderWheel();
    }

    // 使用說明相關函數
    function showHelpPopup() {
        if(checkIfUpdating()) return;
        document.getElementById("helpOverlay").classList.add("show");
        document.getElementById("helpPopup").classList.add("show");
    }

    function closeHelpPopup() {
        document.getElementById("helpOverlay").classList.remove("show");
        document.getElementById("helpPopup").classList.remove("show");
    }

    // 將新函數加入 window 物件
    window.closeHelpPopup = closeHelpPopup;

    window.addEventListener("load", ()=>{
        // 幫助視窗的標籤切換功能
        const tabBtns = document.querySelectorAll('.tab-btn');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // 移除所有按鈕的 active 類別
                tabBtns.forEach(b => b.classList.remove('active'));
                // 為當前按鈕添加 active 類別
                btn.classList.add('active');
                
                // 隱藏所有內容
                const contents = document.querySelectorAll('.tab-content');
                contents.forEach(content => content.classList.remove('active'));
                
                // 顯示對應的內容
                const targetId = btn.dataset.tab === 'usage' ? 'usageContent' : 'versionContent';
                document.getElementById(targetId).classList.add('active');
            });
        });
    });

    // 移除已選學生
    window.removeSelectedStudent = function(name) {
        selectedStudents.delete(name);
        updateSelectedList();
        renderWheel();
    };

    // 將輪轉盤相關函數加入 window 物件
    window.closeWheelPopup = closeWheelPopup;
    window.switchWheelType = switchWheelType;
    window.addNewReward = addNewReward;
</script>
</body>
</html>
