<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>ç­ç´šå­¸å“¡åˆ†æ•¸ç®¡ç†</title>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- CSS ç›´æ¥å¯«åœ¨ <style> ä¸­ -->
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f4f4f4;
            margin: 0; padding: 0;
        }
        h2 { margin-top:20px; margin-bottom:10px; }

        /* å´é‚Šæ¬„æ¨£å¼ */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background: #2c3e50;
            color: white;
            transition: all 0.3s ease;
            z-index: 100;  /* é™ä½å´é‚Šæ¬„çš„ z-index */
            padding-top: 60px;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .menu-group {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .menu-group-title {
            color: #ecf0f1;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px;
            color: white;
            text-decoration: none;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.2s;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .sidebar.collapsed .menu-item span,
        .sidebar.collapsed .menu-group-title {
            display: none;
        }

        /* ä¸»å…§å®¹å€åŸŸæ¨£å¼ */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 60px;
        }

        /* ä¿®æ”¹å·¥å…·åˆ—æ¨£å¼ */
        .toolbar {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        /* ç‹€æ…‹æŒ‡ç¤ºå™¨æ¨£å¼ */
        #syncStatusBar {
            background: transparent;
            padding: 5px 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* å·¥å…·åˆ—ç¾¤çµ„æ¨£å¼ */
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            background: #f5f5f5;
            border-radius: 5px;
            margin: 5px;
        }

        .toolbar-group.auth {
            background: #e8f5e9;  /* æ·ºç¶ è‰²èƒŒæ™¯ */
        }

        .toolbar {
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px;
            margin-bottom: 10px; 
            align-items: center;
        }
        button {
            margin:5px; padding:8px; cursor:pointer; border:none; border-radius:5px;
            background-color:#4caf50; color:white;
        }
        button:hover { opacity:0.9; }
        #login-btn { background:#4caf50; }
        #logout-btn { background:#ff4d4d; }
        #btn-add-student { background:#2196f3; }
        #btn-export-csv  { background:#ff9800; }
        #btn-manage-classes { background:#9c27b0; }
        #btn-manual-sync { background:#d32f2f; } /* æ‰‹å‹•åŒæ­¥æŒ‰éˆ• */

        #classSelect {
            margin:5px; padding:5px; border-radius:5px;
        }

        /* ä¸‰ç‹€æ…‹: æœ‰ç•°å‹•/æ›´æ–°ä¸­/å·²åŒæ­¥ */
        #syncStatusBar {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 5px 10px;
            border-radius: 5px;
            background: #f5f5f5;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #syncStatusBar:hover {
            background: #e0e0e0;
        }
        #syncStatusBar.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .red    { color:red;    }
        .yellow { color:#FFC107;}
        .green  { color:green;  }
        .grey   { color:#aaa;   }

        .container {
            display:flex; flex-wrap:wrap; justify-content:center; gap:20px;
            margin-top:20px; padding-bottom:30px;
        }
        .student-card {
            width:180px; border:1px solid #ccc; background:white;
            padding:10px; text-align:center; border-radius:10px;
            box-shadow:2px 2px 10px rgba(0,0,0,0.1);
            cursor: move; /* æ·»åŠ ç§»å‹•æ¸¸æ¨™ */
            user-select: none; /* é˜²æ­¢æ‹–æ‹‰æ™‚é¸ä¸­æ–‡å­— */
            transition: transform 0.2s, box-shadow 0.2s; /* æ·»åŠ éæ¸¡æ•ˆæœ */
            position: relative; /* æ·»åŠ ç›¸å°å®šä½ */
        }
        .student-card.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .student-card.drag-over {
            border: 2px dashed #4caf50;
        }
        .student-card img { width:80px; height:80px; cursor:pointer; }
        .btn-score {
            color:#fff; border-radius:3px; margin:2px;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-score:hover {
            opacity: 0.9;
        }
        .btn-score.positive {
            background: #4caf50;  /* ç¶ è‰² */
        }
        .btn-score.negative {
            background: #f44336;  /* ç´…è‰² */
        }
        .btn-edit {
            background:#ffa500; color:white; margin:5px 2px;
        }
        .btn-delete {
            background:#ff4d4d; color:white; margin:5px 2px;
        }
        .quickAdjust { margin-top:5px; }
        .quickAdjust select, .quickAdjust input { margin-right:5px; }

        /* ç™»å…¥ or é›¢ç·š é®ç½© & å½ˆçª— */
        .login-overlay, .overlay, .class-overlay, .login-processing-overlay,
        .sync-overlay {
            display:none;
            position:fixed; top:0; left:0;
            width:100%; height:100%;
            background:rgba(0,0,0,0.5);
            z-index:1000;  /* æé«˜é®ç½©çš„ z-index */
        }
        .login-overlay.show, .overlay.show, .class-overlay.show,
        .login-processing-overlay.show, .sync-overlay.show {
            display:block;
        }
        .login-popup, .popup, .class-popup, .login-processing-popup, .sync-popup {
            display:none;
            position:fixed; top:50%; left:50%;
            transform:translate(-50%,-50%);
            background:white; padding:20px; border-radius:10px; text-align:center; width:320px;
            box-shadow:2px 2px 10px rgba(0,0,0,0.3); z-index:1001; opacity:0; transition:opacity 0.3s;  /* æé«˜å½ˆçª—çš„ z-index */
        }
        .login-popup.show, .popup.show, .class-popup.show,
        .login-processing-popup.show, .sync-popup.show {
            display:block; opacity:1;
        }
        .popup input, .popup select,
        .class-popup button, .login-popup button, .login-processing-popup button {
            margin-top:10px; padding:8px;
        }
        .popup button, .class-popup button, .login-processing-popup button {
            margin-top:10px; padding:8px 12px;
        }
        .image-preview {
            display:flex; justify-content:center; gap:10px; margin-top:10px; flex-wrap:wrap;
        }
        .image-preview img {
            width:50px; height:50px; cursor:pointer; border:2px solid transparent; border-radius:5px; box-sizing:border-box;
        }
        .image-preview img.selected { border:2px solid #2196f3; }

        .login-popup .warn {
            margin-top:10px; font-size:14px; color:#f44336;
        }

        .class-list { text-align:left; margin-top:10px; }
        .class-item {
            display:flex; align-items:center; justify-content:space-between;
            margin:5px 0; padding:5px; background:#f9f9f9; border-radius:5px;
        }
        .class-name { font-weight:bold; margin-right:10px; }
        .class-item button {
            margin:5px; font-size:14px;
        }
        .btn-rename { background:#ff9800; }
        .btn-delete-class { background:#f44336; }

        .custom-image-upload {
            margin-top: 10px;
            text-align: center;
        }
        .custom-image-preview {
            margin-top: 10px;
            display: flex;
            justify-content: center;
        }
        .custom-image-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
            border: 2px solid #2196f3;
        }
        .uploaded-images-section {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .uploaded-images-section h4 {
            margin: 0 0 10px 0;
            color: #666;
        }
        .uploaded-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .uploaded-images-grid img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .uploaded-images-grid img:hover {
            transform: scale(1.05);
        }
        .uploaded-images-grid img.selected {
            border-color: #2196f3;
        }
        .image-container {
            position: relative;
            width: 70px;
            margin: 5px;
            text-align: center;
        }
        .image-delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            padding: 0;
            line-height: 1;
        }
        .image-container:hover .image-delete-btn {
            display: block;
        }
        .image-name {
            font-size: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 2px;
            color: #666;
        }
        .uploaded-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }

        /* ä¸‹æ‹‰å¼é¸å–®æ¨£å¼ */
        .dropdown {
            position: relative;
            display: inline-block;
            margin: 5px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            overflow: hidden;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropbtn {
            background-color: #4caf50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .dropbtn:hover {
            opacity: 0.9;
        }

        /* è¼ªè½‰ç›¤æ¨£å¼ */
        .wheel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .wheel-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 800px;
            height: 90vh;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1001;
        }

        .wheel-popup.show {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .wheel-overlay.show {
            display: block;
        }

        .wheel-type-switch {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .wheel-type-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #f0f0f0;
            transition: all 0.3s ease;
            font-size: 16px;
            min-width: 120px;
        }

        .wheel-type-btn.active {
            background: #4caf50;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .wheel-controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 10px;
        }

        .wheel-left-controls, .wheel-right-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .wheel-left-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .wheel-left-controls input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .wheel-container {
            position: relative;
            width: 600px;
            height: 600px;
            margin: 0 auto;
            flex: 1;
            min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #wheelCanvas {
            max-width: 100%;
            max-height: 100%;
        }

        .wheel-pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-top: 50px solid #ff4d4d;
            z-index: 2;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
        }

        .selected-students {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 20px;
            max-height: 200px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .selected-students h4 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        #selectedList {
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 150px;
        }

        #selectedList li {
            list-style: none;
            padding: 8px 12px;
            background: #f0f0f0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        #selectedList li:hover {
            background: #e8e8e8;
        }

        #selectedList li button {
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        #selectedList li button:hover {
            background: #ff3333;
            transform: scale(1.1);
        }

        #rewardControls {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 20px;
        }

        .reward-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .reward-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .reward-input button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #4caf50;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reward-input button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .reward-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .reward-item {
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .reward-item:hover {
            background: #e8e8e8;
        }

        .reward-item button {
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .reward-item button:hover {
            background: #ff3333;
            transform: scale(1.1);
        }

        #btnSpinWheel, #btnResetWheel, #btnCloseWheel {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        #btnSpinWheel:hover, #btnResetWheel:hover, #btnCloseWheel:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* ä½¿ç”¨èªªæ˜è¦–çª—æ¨£å¼ */
        .help-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .help-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
            z-index: 1001;
        }

        /* åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .help-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #f5f5f5;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #e0e0e0;
        }

        .tab-btn.active {
            background: #2196f3;
            color: white;
        }

        /* å…§å®¹å€å¡Šæ¨£å¼ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .help-overlay.show,
        .help-popup.show {
            display: block;
        }

        .help-content {
            margin: 20px 0;
            text-align: left;
        }

        .help-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .help-section h4 {
            margin: 0 0 10px 0;
            color: #2196f3;
            font-size: 16px;
        }

        .help-section ul {
            margin: 0;
            padding-left: 20px;
            list-style-type: none;
        }

        .help-section li {
            margin: 5px 0;
            color: #666;
            line-height: 1.4;
            position: relative;
            padding-left: 15px;
        }

        .help-section li:before {
            content: "";
            position: absolute;
            left: 0;
            top: 8px;
            width: 6px;
            height: 6px;
            background: #2196f3;
            border-radius: 50%;
        }

        .help-section.version-history {
            background: #e8f5e9;
        }

        .version-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .version-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            color: #1b5e20;
            font-weight: bold;
        }

        .version-date {
            font-size: 0.9em;
            color: #666;
        }

        .version-changes {
            margin: 0;
            padding-left: 20px;
            list-style-type: none;
        }

        .version-changes li {
            color: #444;
            margin: 3px 0;
            position: relative;
            padding-left: 15px;
        }

        .version-changes li:before {
            content: "";
            position: absolute;
            left: 0;
            top: 8px;
            width: 6px;
            height: 6px;
            background: #4caf50;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            .help-popup {
                width: 95%;
                max-height: 90vh;
            }
        }

        .reward-input {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .reward-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .reward-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .reward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f5f5f5;
            margin: 5px 0;
            border-radius: 5px;
        }

        .reward-item button {
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
<!-- å´é‚Šæ¬„ -->
<div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
    
    <!-- å¸³è™Ÿç®¡ç†ç¾¤çµ„ -->
    <div class="menu-group">
        <div class="menu-group-title">å¸³è™Ÿç®¡ç†</div>
        <a class="menu-item" id="login-btn" style="display:none;">
            <i>ğŸ‘¤</i><span>ç™»å…¥ Google</span>
        </a>
        <a class="menu-item" id="logout-btn" style="display:none;">
            <i>ğŸšª</i><span>ç™»å‡º</span>
        </a>
    </div>

    <!-- ç­ç´šç®¡ç†ç¾¤çµ„ -->
    <div class="menu-group">
        <div class="menu-group-title">ç­ç´š</div>
        <div class="menu-item">
            <i>ğŸ“š</i>
            <span><select id="classSelect" style="display:none;"></select></span>
        </div>
    </div>

    <!-- åŠŸèƒ½ç¾¤çµ„ -->
    <div class="menu-group">
        <div class="menu-group-title">åŠŸèƒ½é¸å–®</div>
        <a class="menu-item" id="btnScoreSettings">
            <i>âš™ï¸</i><span>åˆ†æ•¸æŒ‰éˆ•è¨­å®š</span>
        </a>
        <a class="menu-item" id="btnClassManage">
            <i>ğŸ“</i><span>ç­ç´šç®¡ç†</span>
        </a>
        <a class="menu-item" id="btnAddStudent">
            <i>â•</i><span>æ–°å¢å­¸ç”Ÿ</span>
        </a>
        <a class="menu-item" id="btnWheel">
            <i>ğŸ¡</i><span>è¼ªè½‰ç›¤</span>
        </a>
        <a class="menu-item" id="btnExportCSV">
            <i>ğŸ“¤</i><span>åŒ¯å‡º CSV</span>
        </a>
        <a class="menu-item" id="btnImportCSV">
            <i>ğŸ“¥</i><span>åŒ¯å…¥ CSV</span>
        </a>
        <a class="menu-item" id="btnHelp">
            <i>â“</i><span>ä½¿ç”¨èªªæ˜</span>
        </a>
    </div>

    <!-- åŒæ­¥ç‹€æ…‹ -->
    <div class="menu-group">
        <div class="menu-group-title">åŒæ­¥ç‹€æ…‹</div>
        <div id="syncStatusBar">
            <span id="statusDirty" class="grey">æœ‰ç•°å‹•</span>
            <span id="statusUpdating" class="grey">æ›´æ–°ä¸­</span>
            <span id="statusSynced" class="grey">å·²åŒæ­¥</span>
        </div>
    </div>
</div>

<!-- ä¸»å…§å®¹å€åŸŸ -->
<div class="main-content" id="mainContent">
    <h2>ç­ç´šå­¸å“¡åˆ†æ•¸ç®¡ç†</h2>
    <div class="container" id="studentContainer"></div>
</div>

<input type="file" id="importCSV" accept=".csv" style="display:none;" />

<!-- ç™»å…¥ or é›¢ç·š é®ç½© & å½ˆçª— -->
<div class="login-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
    <h3>è«‹é¸æ“‡ç™»å…¥æ–¹å¼</h3>
    <p>è‹¥ä¸ç™»å…¥ï¼Œç³»çµ±åƒ…ä½¿ç”¨æœ¬åœ°è³‡æ–™(é›¢ç·šæ¨¡å¼)ã€‚</p>
    <button id="btnLoginNow" style="background:#4caf50;">ç™»å…¥ Google</button>
    <button id="btnOffline"  style="background:#9e9e9e;">é›¢ç·šæ¨¡å¼</button>
    <p class="warn">æ³¨æ„ï¼šä¹‹å¾Œç™»å…¥ Google å¯èƒ½æœƒè¦†è“‹æœ¬åœ°è³‡æ–™</p>
</div>

<!-- ç™»å…¥è™•ç†ä¸­: é®ç½© + popup -->
<div class="login-processing-overlay" id="loginProcessingOverlay"></div>
<div class="login-processing-popup" id="loginProcessingPopup">
    <h3>ç™»å…¥ä¸­ï¼Œè«‹ç¨å€™...</h3>
    <p>å¦‚é—œé–‰ Google å½ˆçª—æˆ–ç™»å…¥å¤±æ•—ï¼Œå°‡å›åˆ°ç™»å…¥é¸æ“‡ã€‚</p>
</div>

<!-- æ–°å¢/ç·¨è¼¯å­¸ç”Ÿ -->
<div class="overlay" id="overlay"></div>
<div class="popup" id="studentPopup">
    <h3 id="popupTitle">æ–°å¢å­¸ç”Ÿ</h3>
    <input type="text"   id="studentName"  placeholder="è¼¸å…¥å§“å" />
    <input type="number" id="studentScore" placeholder="è¼¸å…¥åˆ†æ•¸" min="0" />
    <select id="studentGender">
        <option value="ç”·">ç”·ç”Ÿ</option>
        <option value="å¥³">å¥³ç”Ÿ</option>
    </select>
    <div class="image-preview" id="imageSelection"></div>
    <div class="custom-image-upload">
        <input type="file" id="customImageUpload" accept="image/*" style="display:none;">
        <button id="btnUploadImage" style="background:#2196f3;">ä¸Šå‚³è‡ªè¨‚åœ–ç‰‡</button>
        <div id="customImagePreview" class="custom-image-preview"></div>
    </div>
    <br />
    <button id="btnSaveStudent" style="background:#4caf50;">å„²å­˜</button>
    <button id="btnClosePopup" style="background:#757575;">å–æ¶ˆ</button>
</div>

<!-- ç­ç´šç®¡ç†è¦–çª— -->
<div class="class-overlay" id="classOverlay"></div>
<div class="class-popup" id="classPopup">
    <h3>ç­ç´šç®¡ç†</h3>
    <button id="btnAddClass" style="background:#4caf50;">æ–°å¢ç­ç´š</button>
    <div class="class-list" id="classList"></div>
    <button id="btnCloseClassPopup" style="background:#757575;">é—œé–‰</button>
</div>

<!-- åŒæ­¥ä¸­ é®ç½© + popup -->
<div class="sync-overlay" id="syncOverlay"></div>
<div class="sync-popup" id="syncPopup">
    <h3>è³‡æ–™åŒæ­¥ä¸­ï¼Œè«‹ç¨å¾Œ...</h3>
</div>

<!-- è¼ªè½‰ç›¤è¦–çª— -->
<div class="wheel-overlay" id="wheelOverlay"></div>
<div class="wheel-popup" id="wheelPopup">
    <div class="wheel-type-switch">
        <button id="btnStudentWheel" class="wheel-type-btn active">å­¸ç”Ÿè¼ªè½‰ç›¤</button>
        <button id="btnRewardWheel" class="wheel-type-btn">çæ‡²è¼ªè½‰ç›¤</button>
    </div>
    <h3 id="wheelTitle">å­¸ç”Ÿè¼ªè½‰ç›¤</h3>
    
    <div class="wheel-controls-container">
        <div class="wheel-left-controls">
            <label>
                <input type="checkbox" id="noRepeat" checked>
                ä¸é‡è¤‡é¸æ“‡
            </label>
            <button id="btnResetWheel" style="background:#ff9800;">é‡ç½®å·²é¸åå–®</button>
        </div>
        <div class="wheel-right-controls">
            <button id="btnSpinWheel" style="background:#4caf50;">é–‹å§‹è½‰å‹•</button>
            <button id="btnCloseWheel" style="background:#757575;">é—œé–‰</button>
        </div>
    </div>

    <div class="wheel-container">
        <canvas id="wheelCanvas"></canvas>
        <div class="wheel-pointer"></div>
    </div>

    <div class="selected-students">
        <h4>å·²é¸é …ç›®</h4>
        <div id="selectedList"></div>
    </div>

    <div id="rewardControls" style="display:none;">
        <div class="reward-input">
            <input type="text" id="newReward" placeholder="è¼¸å…¥çæ‡²é …ç›®">
            <button id="btnAddReward" style="background:#4caf50;">æ–°å¢</button>
        </div>
        <div id="rewardList" class="reward-list"></div>
    </div>
</div>

<!-- ä½¿ç”¨èªªæ˜è¦–çª— -->
<div class="help-overlay" id="helpOverlay"></div>
<div class="help-popup" id="helpPopup">
    <h3>ä½¿ç”¨èªªæ˜</h3>
    <div class="help-tabs">
        <button class="tab-btn active" data-tab="usage">ä½¿ç”¨èªªæ˜</button>
        <button class="tab-btn" data-tab="version">ç‰ˆæœ¬æ­·ç¨‹</button>
    </div>
    <div class="help-content">
        <div class="tab-content active" id="usageContent">
            <div class="help-section">
                <h4>åŸºæœ¬æ“ä½œ</h4>
                <ul>
                    <li>é»æ“Šã€Œæ–°å¢å­¸ç”Ÿã€å¯ä»¥æ–°å¢å­¸ç”Ÿè³‡æ–™</li>
                    <li>é»æ“Šå­¸ç”Ÿå¡ç‰‡ä¸Šçš„åœ–ç‰‡å¯ä»¥ç·¨è¼¯å­¸ç”Ÿè³‡æ–™</li>
                    <li>é»æ“Šå­¸ç”Ÿå¡ç‰‡å³ä¸Šè§’çš„ Ã— å¯ä»¥åˆªé™¤å­¸ç”Ÿ</li>
                    <li>å¯ä»¥æ‹–æ›³å­¸ç”Ÿå¡ç‰‡èª¿æ•´é †åº</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>åˆ†æ•¸ç®¡ç†</h4>
                <ul>
                    <li>ä½¿ç”¨å››å€‹åˆ†æ•¸æŒ‰éˆ•å¿«é€ŸåŠ æ¸›åˆ†</li>
                    <li>ä½¿ç”¨ã€Œè‡ªè¨‚åˆ†æ•¸ã€è¼¸å…¥æ¡†æ‰‹å‹•èª¿æ•´åˆ†æ•¸</li>
                    <li>é»æ“Šã€Œåˆ†æ•¸æŒ‰éˆ•è¨­å®šã€å¯ä»¥è‡ªè¨‚å››å€‹æŒ‰éˆ•çš„åˆ†æ•¸å€¼</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>åœ–ç‰‡ç®¡ç†</h4>
                <ul>
                    <li>å¯ä»¥é¸æ“‡é è¨­çš„å­¸ç”Ÿé ­åƒ</li>
                    <li>å¯ä»¥ä¸Šå‚³è‡ªè¨‚åœ–ç‰‡ï¼ˆéœ€è¦ç™»å…¥ Googleï¼‰</li>
                    <li>å¯ä»¥ç®¡ç†æ‰€æœ‰å·²ä¸Šå‚³çš„åœ–ç‰‡</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>ç­ç´šç®¡ç†</h4>
                <ul>
                    <li>å¯ä»¥æ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤ç­ç´š</li>
                    <li>ä½¿ç”¨ä¸‹æ‹‰é¸å–®åˆ‡æ›ä¸åŒç­ç´š</li>
                    <li>å¯ä»¥åŒ¯å‡º/åŒ¯å…¥ CSV æª”æ¡ˆ</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>è¼ªè½‰ç›¤åŠŸèƒ½</h4>
                <ul>
                    <li>å¯ä»¥åˆ‡æ›å­¸ç”Ÿè¼ªè½‰ç›¤å’Œçæ‡²è¼ªè½‰ç›¤</li>
                    <li>å­¸ç”Ÿè¼ªè½‰ç›¤ï¼šéš¨æ©Ÿé¸æ“‡å­¸ç”Ÿ</li>
                    <li>çæ‡²è¼ªè½‰ç›¤ï¼šéš¨æ©Ÿé¸æ“‡çæ‡²é …ç›®</li>
                    <li>å¯ä»¥æ–°å¢ã€åˆªé™¤çæ‡²é …ç›®</li>
                    <li>å¯ä»¥è¨­å®šæ˜¯å¦é‡è¤‡é¸æ“‡</li>
                    <li>å¯ä»¥æŸ¥çœ‹å·²é¸åå–®</li>
                    <li>é»æ“Šè¼ªç›¤å¯ä»¥åœæ­¢è½‰å‹•</li>
                </ul>
            </div>
            <div class="help-section">
                <h4>è³‡æ–™åŒæ­¥</h4>
                <ul>
                    <li>ç™»å…¥ Google å¾Œå¯ä»¥åŒæ­¥è³‡æ–™</li>
                    <li>ç‹€æ…‹åˆ—é¡¯ç¤ºåŒæ­¥ç‹€æ…‹</li>
                    <li>å¯ä»¥æ‰‹å‹•é»æ“ŠåŒæ­¥</li>
                </ul>
            </div>
        </div>
        <div class="tab-content" id="versionContent">
            <div class="help-section version-history">
                <div class="version-item">
                    <div class="version-header">
                        <span>ç‰ˆæœ¬ 1.3.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>æ–°å¢çæ‡²è¼ªè½‰ç›¤åŠŸèƒ½</li>
                        <li>æ–°å¢çæ‡²é …ç›®ç®¡ç†åŠŸèƒ½</li>
                        <li>æ–°å¢çæ‡²é …ç›®è³‡æ–™åŒæ­¥åŠŸèƒ½</li>
                        <li>å„ªåŒ–è¼ªè½‰ç›¤ä½¿ç”¨è€…ä»‹é¢</li>
                    </ul>
                </div>
                <div class="version-item">
                    <div class="version-header">
                        <span>ç‰ˆæœ¬ 1.2.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>æ–°å¢ä½¿ç”¨èªªæ˜åŠŸèƒ½</li>
                        <li>ä¿®æ­£ ESC æŒ‰éµé—œé–‰è¦–çª—åŠŸèƒ½</li>
                        <li>å„ªåŒ–ä½¿ç”¨è€…ä»‹é¢æ¨£å¼</li>
                    </ul>
                </div>
                <div class="version-item">
                    <div class="version-header">
                        <span>ç‰ˆæœ¬ 1.1.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>æ–°å¢è¼ªè½‰ç›¤åŠŸèƒ½</li>
                        <li>æ–°å¢è‡ªè¨‚åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½</li>
                        <li>æ–°å¢åœ–ç‰‡ç®¡ç†åŠŸèƒ½</li>
                        <li>å„ªåŒ–åŒæ­¥æ©Ÿåˆ¶</li>
                    </ul>
                </div>
                <div class="version-item">
                    <div class="version-header">
                        <span>ç‰ˆæœ¬ 1.0.0</span>
                        <span class="version-date">2025-03-22</span>
                    </div>
                    <ul class="version-changes">
                        <li>åŸºæœ¬å­¸ç”Ÿç®¡ç†åŠŸèƒ½</li>
                        <li>åˆ†æ•¸åŠ æ¸›åŠŸèƒ½</li>
                        <li>ç­ç´šç®¡ç†åŠŸèƒ½</li>
                        <li>Google å¸³è™Ÿæ•´åˆ</li>
                        <li>è³‡æ–™åŒæ­¥åŠŸèƒ½</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <button onclick="closeHelpPopup()" style="background:#757575;">é—œé–‰</button>
</div>

<!-- ä¸€åˆ‡é‚è¼¯é›†ä¸­åˆ°ä¸€å€‹ <script type="module"> -->
<script type="module">
    // å°‡ toggleSidebar å‡½æ•¸åŠ å…¥åˆ°å…¨å±€ç¯„åœ
    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
    };

    // ======== [1] GoogleAuth - å–®æª”: OAuth ========
    const googleAuth = (function(){
        let accessToken = localStorage.getItem("googleAccessToken") || null;
        let isGoogleSignedIn = !!accessToken;
        let tokenClient = null;

        // æ¸¬è©¦ç”¨ï¼šæ¨¡æ“¬ token éæœŸ
        function simulateTokenExpired() {
            accessToken = "test_expired_token";
            isGoogleSignedIn = true;
            localStorage.setItem("googleAccessToken", accessToken);
        }

        function initGoogleAuth(onSuccess, onFailure){
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id:"310618779783-ephi24bku6psi9c7c1babi0v1n7fu8u9.apps.googleusercontent.com",
                scope:"https://www.googleapis.com/auth/drive.file",
                callback:(resp)=>{
                    if(resp.error){
                        if(onFailure) onFailure(resp.error);
                    } else {
                        // æˆåŠŸ
                        accessToken = resp.access_token;
                        localStorage.setItem("googleAccessToken", accessToken);
                        isGoogleSignedIn = true;
                        if(onSuccess) onSuccess();
                    }
                }
            });
        }
        function signIn(){
            if(!tokenClient) { console.warn("tokenClientæœªåˆå§‹åŒ–"); return; }
            tokenClient.requestAccessToken();
        }
        function signOut(cb){
            if(!accessToken){
                if(cb) cb();
                return;
            }
            google.accounts.oauth2.revoke(accessToken,()=>{
                accessToken = null;
                isGoogleSignedIn = false;
                localStorage.removeItem("googleAccessToken");
                if(cb) cb();
            });
        }
        function getAccessToken(){ return accessToken; }
        function getIsSignedIn(){ return isGoogleSignedIn; }

        return {
            initGoogleAuth, signIn, signOut, getAccessToken, getIsSignedIn,
            simulateTokenExpired  // åŠ å…¥æ¸¬è©¦ç”¨æ–¹æ³•
        };
    })();

    // å°‡ googleAuth æš´éœ²åˆ°å…¨å±€ç¯„åœ
    window.googleAuth = googleAuth;

    // ======== [2] GoogleDrive - å–®æª”: è®€/å¯« Drive ========
    const googleDrive = (function(){
        let appFolderId = null; // å„²å­˜æ‡‰ç”¨ç¨‹å¼ç›®éŒ„çš„ ID

        // åˆå§‹åŒ–ï¼šç¢ºä¿æ‡‰ç”¨ç¨‹å¼ç›®éŒ„å­˜åœ¨
        async function ensureAppFolder() {
            if (!googleAuth.getIsSignedIn()) return null;
            let token = googleAuth.getAccessToken();

            // å…ˆæœå°‹æ˜¯å¦å·²å­˜åœ¨ç›®éŒ„
            let searchRes = await fetch(
                `https://www.googleapis.com/drive/v3/files?q=name='htmltools' and mimeType='application/vnd.google-apps.folder' and trashed=false&spaces=drive&fields=files(id,name)`,
                { headers: { "Authorization": `Bearer ${token}` } }
            );
            if (!searchRes.ok) throw new Error("Search Error " + searchRes.status);
            let searchData = await searchRes.json();

            if (searchData.files && searchData.files.length > 0) {
                // ç›®éŒ„å·²å­˜åœ¨
                appFolderId = searchData.files[0].id;
                return appFolderId;
            }

            // å»ºç«‹æ–°ç›®éŒ„
            let folderMetadata = {
                name: "htmltools",
                mimeType: "application/vnd.google-apps.folder"
            };

            let createRes = await fetch(
                "https://www.googleapis.com/drive/v3/files?fields=id",
                {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(folderMetadata)
                }
            );
            if (!createRes.ok) throw new Error("Create Folder Error " + createRes.status);
            let createData = await createRes.json();
            appFolderId = createData.id;
            return appFolderId;
        }

        async function loadDriveFile(fileName) {
            if (!googleAuth.getIsSignedIn()) return null;
            let token = googleAuth.getAccessToken();
            await ensureAppFolder();

            // åœ¨æ‡‰ç”¨ç¨‹å¼ç›®éŒ„ä¸­æœå°‹æª”æ¡ˆ
            let listRes = await fetch(
                `https://www.googleapis.com/drive/v3/files?q='${appFolderId}' in parents and name='${fileName}' and trashed=false&spaces=drive&fields=files(id,name)`,
                { headers: { "Authorization": `Bearer ${token}` } }
            );
            if (!listRes.ok) throw new Error("List Error " + listRes.status);
            let listData = await listRes.json();
            if (!listData.files || listData.files.length === 0) {
                return null;
            }
            let fileId = listData.files[0].id;

            let getRes = await fetch(
                `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                { headers: { "Authorization": `Bearer ${token}` } }
            );
            if (!getRes.ok) throw new Error("Get Error " + getRes.status);
            let content = await getRes.text();
            return JSON.parse(content);
        }

        async function saveDriveFile(fileName, dataObj) {
            if (!googleAuth.getIsSignedIn()) throw new Error("å°šæœªç™»å…¥Google");
            let token = googleAuth.getAccessToken();
            await ensureAppFolder();

            // æ¸¬è©¦ç”¨ï¼šæ¨¡æ“¬ token éæœŸ
            if (token === "test_expired_token") {
                throw new Error("401 Unauthorized");
            }

            // åœ¨æ‡‰ç”¨ç¨‹å¼ç›®éŒ„ä¸­æœå°‹æª”æ¡ˆ
            let listRes = await fetch(
                `https://www.googleapis.com/drive/v3/files?q='${appFolderId}' in parents and name='${fileName}' and trashed=false&spaces=drive&fields=files(id,name)`,
                { headers: { "Authorization": `Bearer ${token}` } }
            );
            if (!listRes.ok) throw new Error("List Error " + listRes.status);
            let listData = await listRes.json();
            let fileId = (listData.files && listData.files.length > 0) ? listData.files[0].id : null;

            if (fileId) {
                // å¦‚æœæª”æ¡ˆå­˜åœ¨ï¼Œå…ˆåˆªé™¤å®ƒ
                await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                    method: 'DELETE',
                    headers: { "Authorization": `Bearer ${token}` }
                });
            }

            // å»ºç«‹æ–°æª”æ¡ˆ
            let fileMetadata = {
                name: fileName,
                mimeType: "application/json",
                parents: [appFolderId]
            };
            let fileContent = new Blob([JSON.stringify(dataObj)], { type: "application/json" });
            let form = new FormData();
            form.append("metadata", new Blob([JSON.stringify(fileMetadata)], { type: "application/json" }));
            form.append("file", fileContent);

            let uploadRes = await fetch(
                "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
                {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${token}`
                    },
                    body: form
                }
            );

            if (!uploadRes.ok) throw new Error("Upload Error " + uploadRes.status);
            await uploadRes.json();
        }

        // ä¸Šå‚³åœ–ç‰‡åˆ°æ‡‰ç”¨ç¨‹å¼ç›®éŒ„
        async function uploadImageToDrive(file) {
            const token = googleAuth.getAccessToken();
            await ensureAppFolder();

            const metadata = {
                name: `student_${Date.now()}_${file.name}`,
                mimeType: file.type,
                parents: [appFolderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const uploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: form
            });

            if (!uploadRes.ok) throw new Error('ä¸Šå‚³å¤±æ•—');
            const uploadData = await uploadRes.json();

            // è¨­å®šæª”æ¡ˆæ¬Šé™ç‚ºã€Œä»»ä½•äººéƒ½å¯ä»¥æŸ¥çœ‹ã€
            const permissionRes = await fetch(`https://www.googleapis.com/drive/v3/files/${uploadData.id}/permissions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    role: 'reader',
                    type: 'anyone'
                })
            });

            if (!permissionRes.ok) {
                // å¦‚æœè¨­å®šæ¬Šé™å¤±æ•—ï¼Œåˆªé™¤å·²ä¸Šå‚³çš„æª”æ¡ˆ
                await fetch(`https://www.googleapis.com/drive/v3/files/${uploadData.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                throw new Error('è¨­å®šæ¬Šé™å¤±æ•—');
            }

            return uploadData.id;
        }

        // å¾ Google Drive å–å¾—åœ–ç‰‡çš„æª¢è¦–é€£çµ
        async function getImageUrlFromDrive(fileId) {
            // ç›´æ¥å›å‚³å›ºå®šæ ¼å¼çš„ URL
            return `https://drive.google.com/thumbnail?id=${fileId}&sz=w200-h200`;
        }

        // æ–°å¢ï¼šå¾ Google Drive å–å¾—æ‰€æœ‰åœ–ç‰‡
        async function getAllImages() {
            if (!googleAuth.getIsSignedIn()) return [];
            const token = googleAuth.getAccessToken();
            await ensureAppFolder();

            try {
                // æœå°‹æ‡‰ç”¨ç¨‹å¼ç›®éŒ„ä¸­çš„æ‰€æœ‰åœ–ç‰‡æª”æ¡ˆ
                const searchRes = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q='${appFolderId}' in parents and mimeType contains 'image/' and trashed=false&fields=files(id,name,mimeType)`,
                    { headers: { "Authorization": `Bearer ${token}` } }
                );

                if (!searchRes.ok) throw new Error("æœå°‹åœ–ç‰‡å¤±æ•—");
                const searchData = await searchRes.json();

                // ç‚ºæ¯å€‹åœ–ç‰‡å–å¾—ç¸®åœ– URL
                return searchData.files.map(file => ({
                    id: file.id,
                    url: `https://drive.google.com/thumbnail?id=${file.id}&sz=w200-h200`,
                    name: file.name
                }));
            } catch(err) {
                console.error("å–å¾—åœ–ç‰‡åˆ—è¡¨å¤±æ•—:", err);
                return [];
            }
        }

        // æ–°å¢ï¼šå¾ Google Drive åˆªé™¤æª”æ¡ˆ
        async function deleteFile(fileId) {
            if (!googleAuth.getIsSignedIn()) return;
            const token = googleAuth.getAccessToken();
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}`,
                    {
                        method: 'DELETE',
                        headers: { "Authorization": `Bearer ${token}` }
                    }
                );
                
                if (!response.ok) throw new Error("åˆªé™¤å¤±æ•—");
                return true;
            } catch(err) {
                console.error("åˆªé™¤æª”æ¡ˆå¤±æ•—:", err);
                throw err;
            }
        }

        return {
            loadDriveFile, saveDriveFile, uploadImageToDrive, getImageUrlFromDrive,
            getAllImages, deleteFile  // åŒ¯å‡ºæ–°å‡½æ•¸
        };
    })();

    // ======== [3] ä¸»ç¨‹å¼ students.js ========

    // å…¨åŸŸç‹€æ…‹
    let classes = JSON.parse(localStorage.getItem("classes")) || { 
        "501": [],
        "scoreButtons": [-5, -1, 1, 5],  // é è¨­å€¼
        "rewards": ["çå‹µ", "æ‡²ç½°"]  // æ–°å¢ï¼šé è¨­çæ‡²é …ç›®
    };
    let currentClass = Object.keys(classes).find(key => !['scoreButtons', 'rewards'].includes(key)) || "ä¸€ç­";

    let updatingState = false; // trueè¡¨ç¤ºã€Œæ›´æ–°ä¸­(é»ƒ)ã€éšæ®µ => é˜»æ“‹æ“ä½œ
    let editIndex = -1;
    let selectedImage = "";
    let customImageData = null; // æ–°å¢ï¼šå„²å­˜è‡ªè¨‚åœ–ç‰‡çš„ base64 è³‡æ–™
    let customImageFileId = null; // æ–°å¢ï¼šå„²å­˜ Google Drive ä¸Šçš„åœ–ç‰‡ ID
    let uploadedImages = new Set(); // å„²å­˜æ‰€æœ‰å·²ä¸Šå‚³çš„åœ–ç‰‡è³‡è¨Š

    // æ–°å¢è‡ªå‹•åŒæ­¥ç›¸é—œè®Šæ•¸
    let autoSyncTimer = null;
    const AUTO_SYNC_DELAY = 30; // 30ç§’
    let remainingSeconds = 0;

    // æ–°å¢è‡ªå‹•æª¢æŸ¥ç›¸é—œè®Šæ•¸
    let inactivityTimer = null;
    const INACTIVITY_CHECK_DELAY = 60; // 60ç§’
    let lastActivityTime = Date.now();

    // æ–°å¢ï¼šé‡ç½®ä¸æ´»å‹•è¨ˆæ™‚å™¨
    function resetInactivityTimer() {
        if (inactivityTimer) {
            clearTimeout(inactivityTimer);
        }
        lastActivityTime = Date.now();
        inactivityTimer = setTimeout(checkCloudFile, INACTIVITY_CHECK_DELAY * 1000);
    }

    // æ–°å¢ï¼šæª¢æŸ¥é›²ç«¯æª”æ¡ˆ
    async function checkCloudFile() {
        if (!googleAuth.getIsSignedIn()) return;

        try {
            const cloudData = await googleDrive.loadDriveFile("classes.json");
            if (!cloudData) return;

            // æ¯”è¼ƒæœ¬åœ°å’Œé›²ç«¯è³‡æ–™
            const localData = JSON.stringify(classes);
            const cloudDataStr = JSON.stringify(cloudData);

            if (localData !== cloudDataStr) {
                // å¦‚æœè³‡æ–™ä¸åŒï¼Œé¡¯ç¤ºç¢ºèªå°è©±æ¡†
                if (confirm("ç™¼ç¾é›²ç«¯æª”æ¡ˆæœ‰æ›´æ–°ï¼Œæ˜¯å¦è¦åŒæ­¥ï¼Ÿ\næ³¨æ„ï¼šåŒæ­¥å¾Œæœ¬åœ°è³‡æ–™å°‡è¢«é›²ç«¯è³‡æ–™è¦†è“‹ã€‚")) {
                    // ç”¨æˆ¶ç¢ºèªåŒæ­¥
                    markUpdating();
                    // æ›´æ–°æœ¬åœ°è³‡æ–™ç‚ºé›²ç«¯è³‡æ–™
                    classes = cloudData;
                    saveClassesLocal();
                    renderClassDropdown();
                    renderStudents();
                    markSynced();
                }
            }
        } catch (err) {
            console.error("æª¢æŸ¥é›²ç«¯æª”æ¡ˆå¤±æ•—:", err);
            if (err.message.includes("401") || err.message.includes("unauthorized")) {
                alert("ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥");
                handleLogout();
            }
        }
    }

    // æ–°å¢ï¼šç›£è½ç”¨æˆ¶æ´»å‹•
    function setupActivityListeners() {
        const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
        events.forEach(event => {
            document.addEventListener(event, resetInactivityTimer);
        });
    }

    // æ€§åˆ¥->åœ–ç‰‡
    const imageMap = {
        "ç”·1":"https://img.icons8.com/?size=100&id=oqlkrpDy3clZ&format=png&color=000000",
        "ç”·2":"https://img.icons8.com/?size=100&id=C3wj6TWvegSk&format=png&color=000000",
        "ç”·3":"https://img.icons8.com/?size=100&id=2lwL3N2H9Tbm&format=png&color=000000",
        "å¥³1":"https://img.icons8.com/?size=100&id=eNAHQgRxtqVv&format=png&color=000000",
        "å¥³2":"https://img.icons8.com/?size=100&id=DH9FJ32siusV&format=png&color=000000",
        "å¥³3":"https://img.icons8.com/?size=100&id=gvFfuFtdrY7s&format=png&color=000000"
    };
    const genderImageLabels={
        "ç”·":["ç”·1","ç”·2","ç”·3"],
        "å¥³":["å¥³1","å¥³2","å¥³3"]
    };

    // ä¿®æ”¹ç‹€æ…‹ç›¸é—œå‡½æ•¸
    function markDirty(){
        document.getElementById("statusDirty").className = "red";
        document.getElementById("statusUpdating").className = "grey";
        document.getElementById("statusSynced").className = "grey";
        document.getElementById("syncStatusBar").title = "é»æ“Šé€²è¡ŒåŒæ­¥";
        updatingState = false;
        hideSyncOverlay();
        enableSyncBar();
        startAutoSyncTimer(); // é–‹å§‹å€’æ•¸
    }

    function markUpdating(){
        document.getElementById("statusDirty").className = "grey";
        document.getElementById("statusUpdating").className = "yellow";
        document.getElementById("statusSynced").className = "grey";
        document.getElementById("syncStatusBar").title = "åŒæ­¥è™•ç†ä¸­...";
        updatingState = true;
        showSyncOverlay();
        disableSyncBar();
        stopAutoSyncTimer(); // åœæ­¢å€’æ•¸
    }

    function markSynced(){
        document.getElementById("statusDirty").className = "grey";
        document.getElementById("statusUpdating").className = "grey";
        document.getElementById("statusSynced").className = "green";
        document.getElementById("syncStatusBar").title = "è³‡æ–™å·²åŒæ­¥";
        updatingState = false;
        hideSyncOverlay();
        enableSyncBar();
        stopAutoSyncTimer(); // åœæ­¢å€’æ•¸
    }

    // æ–°å¢è‡ªå‹•åŒæ­¥ç›¸é—œå‡½æ•¸
    function startAutoSyncTimer() {
        // å¦‚æœæœªç™»å…¥ Googleï¼Œä¸å•Ÿå‹•è¨ˆæ™‚å™¨
        if (!googleAuth.getIsSignedIn()) return;
        
        // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨
        stopAutoSyncTimer();
        
        // è¨­å®šåˆå§‹å€’æ•¸æ™‚é–“
        remainingSeconds = AUTO_SYNC_DELAY;
        updateSyncStatus();
        
        // å•Ÿå‹•æ–°è¨ˆæ™‚å™¨
        autoSyncTimer = setInterval(() => {
            remainingSeconds--;
            updateSyncStatus();
            
            // æ™‚é–“åˆ°ï¼ŒåŸ·è¡ŒåŒæ­¥
            if (remainingSeconds <= 0) {
                clearInterval(autoSyncTimer);
                autoSyncTimer = null;
                performSync();
            }
        }, 1000);
    }

    function stopAutoSyncTimer() {
        if (autoSyncTimer) {
            clearInterval(autoSyncTimer);
            autoSyncTimer = null;
        }
        remainingSeconds = 0;
    }

    function updateSyncStatus() {
        let statusBar = document.getElementById("syncStatusBar");
        if (remainingSeconds > 0) {
            statusBar.title = `é»æ“ŠåŒæ­¥ (${remainingSeconds}ç§’å¾Œè‡ªå‹•åŒæ­¥)`;
            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            document.getElementById("statusDirty").textContent = `æœ‰ç•°å‹• (${remainingSeconds}s)`;
        } else {
            statusBar.title = "é»æ“Šé€²è¡ŒåŒæ­¥";
            document.getElementById("statusDirty").textContent = "æœ‰ç•°å‹•";
        }
    }

    // æ–°å¢åŸ·è¡ŒåŒæ­¥çš„å‡½æ•¸
    function performSync() {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥åŒæ­¥
        if (!googleAuth.getIsSignedIn()) {
            alert("å°šæœªç™»å…¥ Google");
            return;
        }
        if (updatingState) {
            alert("åŒæ­¥è™•ç†ä¸­ï¼Œè«‹ç¨å€™...");
            return;
        }
        
        // åŸ·è¡ŒåŒæ­¥
        markUpdating();
        googleDrive.saveDriveFile("classes.json", classes)
            .then(() => {
                markSynced();
            })
            .catch(err => {
                console.error("å„²å­˜å¤±æ•—:", err);
                markDirty();
                
                // æª¢æŸ¥æ˜¯å¦ç‚º token éæœŸ
                if (err.message.includes("401") || err.message.includes("unauthorized")) {
                    alert("ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥");
                    // æ¸…é™¤ token
                    localStorage.removeItem("googleAccessToken");
                    // å›åˆ°ç™»å…¥ç•«é¢
                    hideMainButtons();
                    backToLoginChoice();
                } else {
                    alert("åŒæ­¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                }
            });
    }

    // æ–°å¢ç‹€æ…‹åˆ—å•Ÿç”¨/ç¦ç”¨å‡½æ•¸
    function enableSyncBar() {
        let bar = document.getElementById("syncStatusBar");
        bar.classList.remove("disabled");
    }

    function disableSyncBar() {
        let bar = document.getElementById("syncStatusBar");
        bar.classList.add("disabled");
    }

    // æ›´æ–°ä¸­æ™‚é¡¯ç¤ºé®ç½©
    function showSyncOverlay(){
        document.getElementById("syncOverlay").classList.add("show");
        document.getElementById("syncPopup").classList.add("show");
    }
    function hideSyncOverlay(){
        document.getElementById("syncOverlay").classList.remove("show");
        document.getElementById("syncPopup").classList.remove("show");
    }

    // æª¢æŸ¥æ˜¯å¦æ›´æ–°ä¸­(é»ƒ)
    function checkIfUpdating(){
        if(updatingState){
            alert("ç›®å‰æ­£åœ¨ã€æ›´æ–°ä¸­ã€ï¼Œè«‹ç¨å¾Œå†æ“ä½œã€‚");
            return true;
        }
        return false;
    }

    // onload
    window.onload = () => {
        hideMainButtons();
        
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰ token
        if(googleAuth.getIsSignedIn()){
            showMainButtons();
            markSynced();
            loadClassesFromDrive();
            setupActivityListeners(); // è¨­ç½®æ´»å‹•ç›£è½å™¨
            resetInactivityTimer(); // é–‹å§‹ä¸æ´»å‹•è¨ˆæ™‚å™¨
        } else {
            showLoginChoice();
        }

        // åˆå§‹åŒ– googleAuth
        googleAuth.initGoogleAuth(
            ()=>{
                // onSuccess
                hideLoginProcessingOverlay();
                console.log("Googleç™»å…¥æˆåŠŸ!");
                document.getElementById("login-btn").style.display = "none";
                document.getElementById("logout-btn").style.display = "inline-block";
                markSynced();
                loadClassesFromDrive();
                setupActivityListeners(); // è¨­ç½®æ´»å‹•ç›£è½å™¨
                resetInactivityTimer(); // é–‹å§‹ä¸æ´»å‹•è¨ˆæ™‚å™¨
            },
            (err)=>{
                // onFailure
                hideLoginProcessingOverlay();
                console.log("Googleç™»å…¥å¤±æ•—:",err);
                localStorage.removeItem("googleAccessToken"); // ç§»é™¤ç„¡æ•ˆçš„ token
                backToLoginChoice();
            }
        );

        initUI();
        renderClassDropdown();
        renderStudents();
    };

    // åˆå§‹åŒ–UIäº‹ä»¶
    function initUI(){
        // ç™»å…¥/ç™»å‡º
        document.getElementById("login-btn").addEventListener("click",()=>{
            showLoginProcessingOverlay();
            googleAuth.signIn();
        });
        document.getElementById("logout-btn").addEventListener("click",handleLogout);

        // ç­ç´šé¸æ“‡
        let sel=document.getElementById("classSelect");
        sel.addEventListener("change",(evt)=>{
            if(checkIfUpdating()){ evt.target.value=currentClass; return; }
            currentClass=evt.target.value;
            renderStudents();
        });

        // CSV åŒ¯å…¥
        document.getElementById("importCSV").addEventListener("change",(evt)=>{
            if(checkIfUpdating()){
                evt.target.value="";
                return;
            }
            importCSV(evt);
        });

        // é»æ“Šç‹€æ…‹åˆ—è§¸ç™¼åŒæ­¥
        let syncBar = document.getElementById("syncStatusBar");
        syncBar.addEventListener("click", () => {
            // æª¢æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥
            let isDirty = document.getElementById("statusDirty").className === "red";
            if (!isDirty) {
                alert("è³‡æ–™å·²æ˜¯æœ€æ–°ç‹€æ…‹");
                return;
            }
            
            performSync();
        });

        // å­¸ç”Ÿpopup
        document.getElementById("btnSaveStudent").addEventListener("click",saveStudent);
        document.getElementById("btnClosePopup").addEventListener("click",closePopup);
        document.getElementById("btnUploadImage").addEventListener("click",()=>{
            document.getElementById("customImageUpload").click();
        });
        document.getElementById("customImageUpload").addEventListener("change",handleCustomImageUpload);

        // ç™»å…¥/é›¢ç·špopup
        document.getElementById("btnLoginNow").addEventListener("click",()=>{
            closeLoginChoice();
            showMainButtons();
            markDirty();
            showLoginProcessingOverlay();
            googleAuth.signIn();
        });
        document.getElementById("btnOffline").addEventListener("click",()=>{
            closeLoginChoice();
            showMainButtons();
            markDirty();
            alert("é›¢ç·šæ¨¡å¼å•Ÿç”¨ï¼Œä¹‹å¾Œç™»å…¥Googleå¯èƒ½è¦†è“‹è³‡æ–™ã€‚");
        });

        // ç­ç´šç®¡ç†
        document.getElementById("btnAddClass").addEventListener("click",addClassPrompt);
        document.getElementById("btnCloseClassPopup").addEventListener("click",closeClassPopup);

        // è¨­å®šé¸å–®
        document.getElementById("btnScoreSettings").addEventListener("click", showScoreButtonsSettings);

        // ç®¡ç†é¸å–®
        document.getElementById("btnClassManage").addEventListener("click", showClassPopup);
        document.getElementById("btnAddStudent").addEventListener("click", () => showPopup(-1));

        // åŠŸèƒ½é¸å–®
        document.getElementById("btnExportCSV").addEventListener("click", exportCSV);
        document.getElementById("btnImportCSV").addEventListener("click", () => {
            document.getElementById("importCSV").click();
        });
        document.getElementById("btnWheel").addEventListener("click", () => {
            showWheelPopup();
        });

        // æ·»åŠ  ESC éµé—œé–‰è¦–çª—åŠŸèƒ½
        window.addEventListener("keydown", (evt) => {
            if (evt.key === "Escape") {
                // æª¢æŸ¥å„å€‹è¦–çª—æ˜¯å¦é–‹å•Ÿ
                if (document.getElementById("overlay").classList.contains("show")) {
                    closePopup();
                } else if (document.getElementById("loginOverlay").classList.contains("show")) {
                    closeLoginChoice();
                } else if (document.getElementById("classOverlay").classList.contains("show")) {
                    closeClassPopup();
                } else if (document.getElementById("settingsOverlay")?.classList.contains("show")) {
                    closeScoreButtonsSettings();
                } else if (document.getElementById("wheelOverlay").classList.contains("show")) {
                    closeWheelPopup();
                } else if (document.getElementById("helpOverlay").classList.contains("show")) {
                    closeHelpPopup();
                }
            }
        });

        // ä½¿ç”¨èªªæ˜
        document.getElementById("btnHelp").addEventListener("click", showHelpPopup);
    }

    // ç™»å‡º
    function handleLogout(){
        if(!googleAuth.getAccessToken()){
            alert("å°šæœªç™»å…¥");
            return;
        }
        stopAutoSyncTimer(); // åœæ­¢è‡ªå‹•åŒæ­¥è¨ˆæ™‚å™¨
        if (inactivityTimer) {
            clearTimeout(inactivityTimer); // æ¸…é™¤ä¸æ´»å‹•è¨ˆæ™‚å™¨
        }
        googleAuth.signOut(()=>{
            console.log("å·²ç™»å‡º");
            hideMainButtons();
            backToLoginChoice();
        });
    }

    // é¡¯ç¤º/éš±è—ä¸»åŠŸèƒ½æŒ‰éˆ•
    function hideMainButtons(){
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("logout-btn").style.display = "none";
        document.getElementById("classSelect").style.display = "none";
        document.querySelectorAll(".dropdown").forEach(dropdown => {
            dropdown.style.display = "none";
        });
    }
    function showMainButtons(){
        let isSigned = googleAuth.getIsSignedIn();
        document.getElementById("login-btn").style.display = isSigned ? "none" : "inline-block";
        document.getElementById("logout-btn").style.display = isSigned ? "inline-block" : "none";
        document.getElementById("classSelect").style.display = "inline-block";
        document.querySelectorAll(".dropdown").forEach(dropdown => {
            dropdown.style.display = "inline-block";
        });
    }

    // ç™»å…¥é¸æ“‡è¦–çª—
    function showLoginChoice(){
        document.getElementById("loginOverlay").classList.add("show");
        document.getElementById("loginPopup").classList.add("show");
    }
    function closeLoginChoice(){
        document.getElementById("loginOverlay").classList.remove("show");
        document.getElementById("loginPopup").classList.remove("show");
    }
    function backToLoginChoice(){
        hideLoginProcessingOverlay();
        showLoginChoice();
    }

    // ç™»å…¥è™•ç†ä¸­
    function showLoginProcessingOverlay(){
        document.getElementById("loginProcessingOverlay").classList.add("show");
        document.getElementById("loginProcessingPopup").classList.add("show");
    }
    function hideLoginProcessingOverlay(){
        document.getElementById("loginProcessingOverlay").classList.remove("show");
        document.getElementById("loginProcessingPopup").classList.remove("show");
    }

    // è®€/å¯« localStorage
    function saveClassesLocal(){
        localStorage.setItem("classes", JSON.stringify(classes));
    }

    // å¾ Google Drive è¼‰å…¥ classes.json
    async function loadClassesFromDrive(){
        if(!googleAuth.getIsSignedIn()) return;
        try {
            let data = await googleDrive.loadDriveFile("classes.json");
            if(data){
                // ç¢ºä¿ scoreButtons å­˜åœ¨
                if (!data.scoreButtons) {
                    data.scoreButtons = [-5, -1, 1, 5];  // ä½¿ç”¨é è¨­å€¼
                }
                classes = data;
                saveClassesLocal();
                if(!classes[currentClass]){
                    currentClass = Object.keys(classes).find(key => key !== 'scoreButtons') || "ä¸€ç­";
                }
                renderClassDropdown();
                renderStudents();
                markSynced();
            } else {
                console.log("æœªæ‰¾åˆ° classes.json => ç­‰ä½¿ç”¨è€…æ‰‹å‹•åŒæ­¥å»ºç«‹");
                markDirty();
            }
        } catch(err){
            console.error("loadClasseså¤±æ•—:",err);
            markDirty();
        }
    }

    // ç­ç´š
    function renderClassDropdown(){
        let sel = document.getElementById("classSelect");
        sel.innerHTML = "";
        for(let cName in classes){
            // è·³é scoreButtons
            if(cName === 'scoreButtons') continue;
            
            let opt = document.createElement("option");
            opt.value = cName;
            opt.textContent = cName;
            if(cName === currentClass) opt.selected = true;
            sel.appendChild(opt);
        }
    }
    function getStudents(){
        if(!classes[currentClass]) classes[currentClass]=[];
        return classes[currentClass];
    }
    function renderStudents(){
        let arr=getStudents();
        let container=document.getElementById("studentContainer");
        container.innerHTML="";
        arr.forEach((st,idx)=>{
            let card=document.createElement("div");
            card.classList.add("student-card");
            let imgSrc = st.customImage || imageMap[st.imageLabel] || "";
            
            // æ·»åŠ æ‹–æ‹‰å±¬æ€§
            card.draggable = true;
            card.dataset.index = idx;
            
            // æ·»åŠ æ‹–æ‹‰äº‹ä»¶ç›£è½å™¨
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleDrop);
            
            // æ ¹æ“šåˆ†æ•¸æ­£è² æ±ºå®šæŒ‰éˆ•é¡åˆ¥
            const getButtonClass = (score) => {
                return score >= 0 ? 'positive' : 'negative';
            };
            
            card.innerHTML=`
      <button class="delete-btn" onclick="deleteStudent(${idx})">Ã—</button>
      <img src="${imgSrc}" alt="${st.gender}" onclick="editStudent(${idx})">
      <p>${st.name}</p>
      <p id="score-${idx}">${st.score} åˆ†</p>
      <button class="btn-score ${getButtonClass(classes.scoreButtons[0])}" onclick="updateScore(${idx}, ${classes.scoreButtons[0]})">${classes.scoreButtons[0] >= 0 ? '+' : ''}${classes.scoreButtons[0]}</button>
      <button class="btn-score ${getButtonClass(classes.scoreButtons[1])}" onclick="updateScore(${idx}, ${classes.scoreButtons[1]})">${classes.scoreButtons[1] >= 0 ? '+' : ''}${classes.scoreButtons[1]}</button>
      <button class="btn-score ${getButtonClass(classes.scoreButtons[2])}" onclick="updateScore(${idx}, ${classes.scoreButtons[2]})">${classes.scoreButtons[2] >= 0 ? '+' : ''}${classes.scoreButtons[2]}</button>
      <button class="btn-score ${getButtonClass(classes.scoreButtons[3])}" onclick="updateScore(${idx}, ${classes.scoreButtons[3]})">${classes.scoreButtons[3] >= 0 ? '+' : ''}${classes.scoreButtons[3]}</button>
      <div class="quickAdjust">
        <select id="sign-${idx}"">
          <option value="+">+</option>
          <option value="-">-</option>
        </select>
        <input type="number" id="custom-${idx}" placeholder="è‡ªè¨‚åˆ†æ•¸" style="width:60px;">
        <button onclick="customAdjust(${idx})">ç¢ºå®š</button>
      </div>
    `;
            container.appendChild(card);
        });
    }

    // æ‹–æ‹‰ç›¸é—œå‡½æ•¸
    function handleDragStart(e) {
        this.classList.add('dragging');
        e.dataTransfer.setData('text/plain', this.dataset.index);
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.student-card').forEach(card => {
            card.classList.remove('drag-over');
        });
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
        const toIndex = parseInt(this.dataset.index);
        
        if (fromIndex === toIndex) return;
        
        // æ›´æ–°é™£åˆ—é †åº
        const arr = getStudents();
        const [movedStudent] = arr.splice(fromIndex, 1);
        arr.splice(toIndex, 0, movedStudent);
        
        // å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“
        saveClassesLocal();
        renderStudents();
        markDirty();
    }

    // é˜²æ­¢æ›´æ–°ä¸­ä¿®æ”¹
    window.editStudent=function(idx){
        if(checkIfUpdating()) return;
        showPopup(idx);
    };
    window.updateScore=function(idx,delta){
        if(checkIfUpdating()) return;
        let arr=getStudents();
        arr[idx].score+=delta;
        saveClassesLocal();
        document.getElementById(`score-${idx}`).textContent=arr[idx].score+" åˆ†";
        markDirty();
    };
    window.customAdjust=function(idx){
        if(checkIfUpdating()) return;
        let arr=getStudents();
        let signSel=document.getElementById(`sign-${idx}`);
        let customIn=document.getElementById(`custom-${idx}`);
        let sign=signSel.value;
        let val=parseInt(customIn.value)||0;
        if(sign==="-") val=-val;
        arr[idx].score+=val;
        saveClassesLocal();
        document.getElementById(`score-${idx}`).textContent=arr[idx].score+" åˆ†";
        customIn.value="";
        markDirty();
    };
    window.deleteStudent=function(idx){
        if(checkIfUpdating()) return;
        if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ"))return;
        let arr=getStudents();
        arr.splice(idx,1);
        saveClassesLocal();
        renderStudents();
        markDirty();
    };

    // è™•ç†è‡ªè¨‚åœ–ç‰‡ä¸Šå‚³
    async function handleCustomImageUpload(evt) {
        const file = evt.target.files[0];
        if (!file) return;

        // æª¢æŸ¥æª”æ¡ˆé¡å‹
        if (!file.type.startsWith('image/')) {
            alert('è«‹ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ');
            return;
        }

        // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆé™åˆ¶ç‚º 5MBï¼‰
        if (file.size > 5 * 1024 * 1024) {
            alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
            return;
        }

        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ Google
        if (!googleAuth.getIsSignedIn()) {
            alert('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿæ‰èƒ½ä¸Šå‚³åœ–ç‰‡');
            return;
        }

        try {
            // é¡¯ç¤ºä¸Šå‚³ä¸­çš„æç¤º
            const preview = document.getElementById('customImagePreview');
            preview.innerHTML = '<p>åœ–ç‰‡ä¸Šå‚³ä¸­...</p>';

            // ä¸Šå‚³åˆ° Google Drive
            const fileId = await googleDrive.uploadImageToDrive(file);
            customImageFileId = fileId;
            
            // å–å¾—åœ–ç‰‡çš„å…¬é–‹é€£çµ
            const imageUrl = await googleDrive.getImageUrlFromDrive(fileId);
            customImageData = imageUrl;
            
            // æ›´æ–°é è¦½
            preview.innerHTML = `
                <img src="${imageUrl}" alt="è‡ªè¨‚åœ–ç‰‡">
                <button onclick="clearCustomImage()" style="display:block; margin:5px auto; background:#ff4d4d;">ç§»é™¤è‡ªè¨‚åœ–ç‰‡</button>
            `;
            
            // å–æ¶ˆé¸æ“‡é è¨­åœ–ç‰‡
            document.querySelectorAll(".image-preview img").forEach(x => x.classList.remove("selected"));
            selectedImage = "";

            // æ›´æ–°å·²ä¸Šå‚³åœ–ç‰‡é›†åˆ
            uploadedImages.add(JSON.stringify({
                url: imageUrl,
                id: fileId
            }));
            
            // æ›´æ–°å·²ä¸Šå‚³åœ–ç‰‡å€åŸŸ
            updateUploadedImagesSection();
        } catch (err) {
            console.error('åœ–ç‰‡ä¸Šå‚³å¤±æ•—:', err);
            alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            preview.innerHTML = '';
        }
    }

    // æ–°å¢ï¼šæ¸…é™¤è‡ªè¨‚åœ–ç‰‡çš„å‡½æ•¸
    window.clearCustomImage = function() {
        customImageData = null;
        customImageFileId = null;
        document.getElementById("customImagePreview").innerHTML = "";
        document.getElementById("customImageUpload").value = "";
        
        // æ¸…é™¤å·²ä¸Šå‚³åœ–ç‰‡çš„é¸ä¸­ç‹€æ…‹
        document.querySelectorAll('.uploaded-images-grid img').forEach(img => {
            img.classList.remove('selected');
        });
        
        // é¸æ“‡ç¬¬ä¸€å€‹é è¨­åœ–ç‰‡
        let gender = document.getElementById("studentGender").value;
        let labels = genderImageLabels[gender];
        selectedImage = labels[0];
        updateImagePreview();
    };

    // æ–°å¢/ç·¨è¼¯ å­¸ç”Ÿ
    async function showPopup(idx=-1){
        editIndex = idx;
        document.getElementById("overlay").classList.add("show");
        document.getElementById("studentPopup").classList.add("show");
        
        let genderSelect = document.getElementById("studentGender");
        genderSelect.addEventListener("change", updateImagePreview);
        
        customImageData = null;
        customImageFileId = null;
        document.getElementById("customImagePreview").innerHTML = "";
        document.getElementById("customImageUpload").value = "";
        
        // æ”¹ç‚ºéåŒæ­¥æ”¶é›†åœ–ç‰‡
        collectUploadedImages().then(() => {
            updateUploadedImagesSection();
            
            if(idx === -1){
                document.getElementById("popupTitle").textContent = "æ–°å¢å­¸ç”Ÿ";
                document.getElementById("studentName").value = "";
                document.getElementById("studentScore").value = 0;
                genderSelect.value = "ç”·";
                selectedImage = "";
            } else {
                document.getElementById("popupTitle").textContent = "ç·¨è¼¯å­¸ç”Ÿ";
                let arr = getStudents();
                let st = arr[idx];
                document.getElementById("studentName").value = st.name;
                document.getElementById("studentScore").value = st.score;
                genderSelect.value = st.gender;
                selectedImage = st.imageLabel;
                
                // å¦‚æœæœ‰è‡ªè¨‚åœ–ç‰‡ï¼Œé¡¯ç¤ºå®ƒ
                if (st.customImage) {
                    customImageData = st.customImage;
                    customImageFileId = st.customImageFileId;
                    document.getElementById("customImagePreview").innerHTML = 
                        `<img src="${st.customImage}" alt="è‡ªè¨‚åœ–ç‰‡">
                         <button onclick="clearCustomImage()" style="display:block; margin:5px auto; background:#ff4d4d;">ç§»é™¤è‡ªè¨‚åœ–ç‰‡</button>`;
                }
            }
            updateImagePreview();
        });
    }
    function closePopup(){
        // ç§»é™¤æ€§åˆ¥é¸æ“‡çš„äº‹ä»¶ç›£è½å™¨
        let genderSelect = document.getElementById("studentGender");
        genderSelect.removeEventListener("change", updateImagePreview);
        
        document.getElementById("overlay").classList.remove("show");
        document.getElementById("studentPopup").classList.remove("show");
    }
    function updateImagePreview(){
        let gender = document.getElementById("studentGender").value;
        let imageSelection = document.getElementById("imageSelection");
        imageSelection.innerHTML = "";
        let labels = genderImageLabels[gender];
        
        // å¦‚æœåˆ‡æ›æ€§åˆ¥å¾Œï¼Œä¹‹å‰é¸ä¸­çš„åœ–ç‰‡ä¸å±¬æ–¼æ–°æ€§åˆ¥ï¼Œå‰‡é‡ç½®é¸æ“‡
        if(selectedImage && !labels.includes(selectedImage)){
            selectedImage = "";
        }
        
        labels.forEach((lbl, idx) => {
            let img = document.createElement("img");
            img.src = imageMap[lbl];
            img.onclick = () => {
                document.querySelectorAll(".image-preview img").forEach(x => x.classList.remove("selected"));
                img.classList.add("selected");
                selectedImage = lbl;
                // æ¸…é™¤è‡ªè¨‚åœ–ç‰‡
                customImageData = null;
                customImageFileId = null;
                document.getElementById("customImagePreview").innerHTML = "";
                document.getElementById("customImageUpload").value = "";
            };
            
            // é¸ä¸­åœ–ç‰‡çš„é‚è¼¯ï¼šå¦‚æœæ²’æœ‰è‡ªè¨‚åœ–ç‰‡æ™‚æ‰å¥—ç”¨
            if(!customImageData && ((idx === 0 && !selectedImage) || selectedImage === lbl)){
                img.classList.add("selected");
                selectedImage = lbl;
            }
            
            imageSelection.appendChild(img);
        });
    }
    function saveStudent(){
        if(checkIfUpdating()) return;
        let name=document.getElementById("studentName").value.trim();
        let score=parseInt(document.getElementById("studentScore").value)||0;
        let gender=document.getElementById("studentGender").value;
        
        // è™•ç†åœ–ç‰‡é¸æ“‡
        let imageData = null;
        let imageFileId = null;
        let imageLabel = "";
        
        if (customImageData) {
            imageData = customImageData;
            imageFileId = customImageFileId;
            imageLabel = "";  // ä½¿ç”¨è‡ªè¨‚åœ–ç‰‡æ™‚ï¼Œæ¸…ç©º imageLabel
        } else {
            imageLabel = selectedImage || genderImageLabels[gender][0];
        }
        
        if(!name){
            alert("è«‹è¼¸å…¥å­¸ç”Ÿå§“å");
            return;
        }
        
        let arr=getStudents();
        if(editIndex===-1){
            arr.push({ 
                name,
                score,
                gender,
                imageLabel,
                customImage: imageData,
                customImageFileId: imageFileId
            });
        }else{
            arr[editIndex]={
                name,
                score,
                gender,
                imageLabel,
                customImage: imageData,
                customImageFileId: imageFileId
            };
        }
        saveClassesLocal();
        closePopup();
        renderStudents();
        markDirty();
    }

    // CSV
    function exportCSV(){
        if(checkIfUpdating()) return;
        let arr=getStudents();
        let csv="å§“å,åˆ†æ•¸,æ€§åˆ¥,é è¨­åœ–ç‰‡,è‡ªè¨‚åœ–ç‰‡ID\n"+
            arr.map(s=>`${s.name},${s.score},${s.gender},${s.imageLabel || ''},${s.customImageFileId || ''}`).join("\n");
        let blob=new Blob([csv],{type:"text/csv"});
        let a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download=`${currentClass}-students.csv`;
        a.click();
    }

    async function importCSV(evt){
        let file=evt.target.files[0];
        if(!file)return;

        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ Google
        if (!googleAuth.getIsSignedIn()) {
            alert('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿæ‰èƒ½åŒ¯å…¥åŒ…å«è‡ªè¨‚åœ–ç‰‡çš„è³‡æ–™');
            return;
        }

        let reader=new FileReader();
        reader.onload=async (e)=>{
            let lines=e.target.result.split("\n").map(x=>x.trim()).filter(x=>x);
            let headers = lines.shift().split(',');
            let hasCustomImage = headers.includes('è‡ªè¨‚åœ–ç‰‡ID');

            let newArr = [];
            for(let line of lines) {
                let [name, score, gender, imageLabel, customImageFileId=''] = line.split(",");
                score = parseInt(score) || 0;
                
                // è™•ç†é è¨­åœ–ç‰‡
                if(!imageLabel){
                    let labs = genderImageLabels[gender] || ["ç”·1"];
                    imageLabel = labs[0];
                }

                // å»ºç«‹å­¸ç”Ÿè³‡æ–™ç‰©ä»¶
                let student = { 
                    name, 
                    score, 
                    gender, 
                    imageLabel
                };

                // å¦‚æœæœ‰è‡ªè¨‚åœ–ç‰‡IDï¼Œå˜—è©¦å–å¾—åœ–ç‰‡URL
                if(hasCustomImage && customImageFileId) {
                    try {
                        const imageUrl = await googleDrive.getImageUrlFromDrive(customImageFileId);
                        student.customImage = imageUrl;
                        student.customImageFileId = customImageFileId;
                    } catch(err) {
                        console.warn(`ç„¡æ³•å–å¾—åœ–ç‰‡ ${customImageFileId} çš„URL:`, err);
                        // å¦‚æœå–å¾—åœ–ç‰‡å¤±æ•—ï¼Œä½¿ç”¨é è¨­åœ–ç‰‡
                        student.customImage = null;
                        student.customImageFileId = null;
                    }
                }

                newArr.push(student);
            }
            
            classes[currentClass] = newArr;
            saveClassesLocal();
            renderStudents();
            markDirty();
        };
        reader.readAsText(file);
    }

    // ç­ç´šç®¡ç†
    function showClassPopup(){
        if(checkIfUpdating()) return;
        document.getElementById("classOverlay").classList.add("show");
        document.getElementById("classPopup").classList.add("show");
        renderClassList();
    }
    function closeClassPopup(){
        document.getElementById("classOverlay").classList.remove("show");
        document.getElementById("classPopup").classList.remove("show");
    }
    function renderClassList(){
        let listEl=document.getElementById("classList");
        listEl.innerHTML="";
        // éæ¿¾æ‰ç‰¹æ®Šå±¬æ€§ï¼šscoreButtons å’Œ rewards
        let cNames = Object.keys(classes).filter(key => !['scoreButtons', 'rewards'].includes(key));
        cNames.forEach(cName=>{
            let div=document.createElement("div");
            div.classList.add("class-item");
            let disableDelete=(cNames.length<=1)?true:false;
            let html=`
      <span class="class-name">${cName}</span>
      <div>
        <button class="btn-rename">ä¿®æ”¹</button>
        <button class="btn-delete-class" ${disableDelete?"disabled":""}>åˆªé™¤</button>
      </div>
    `;
            div.innerHTML=html;
            let renameBtn=div.querySelector(".btn-rename");
            let delBtn=div.querySelector(".btn-delete-class");
            renameBtn.addEventListener("click",()=> renameClassPrompt(cName));
            delBtn.addEventListener("click",()=>{
                if(disableDelete){
                    alert("åªå‰©æœ€å¾Œä¸€å€‹ç­ç´šï¼Œç„¡æ³•åˆªé™¤");
                    return;
                }
                deleteClass(cName);
            });
            listEl.appendChild(div);
        });
    }
    function addClassPrompt(){
        if(checkIfUpdating()) return;
        let newName=prompt("è«‹è¼¸å…¥æ–°ç­ç´šåç¨±ï¼š");
        if(!newName)return;
        newName=newName.trim();
        if(!newName)return;
        if(classes[newName]){
            alert("æ­¤ç­ç´šå·²å­˜åœ¨");
            return;
        }
        classes[newName]=[];
        saveClassesLocal();
        currentClass=newName;
        renderClassDropdown();
        renderStudents();
        renderClassList();
        markDirty();
    }
    function renameClassPrompt(oldName){
        if(checkIfUpdating()) return;
        let newName=prompt("æ–°çš„ç­ç´šåç¨±", oldName);
        if(!newName)return;
        newName=newName.trim();
        if(!newName|| newName===oldName)return;
        if(classes[newName]){
            alert("æ­¤ç­ç´šå·²å­˜åœ¨");
            return;
        }
        classes[newName]=classes[oldName];
        delete classes[oldName];
        if(currentClass===oldName) currentClass=newName;
        saveClassesLocal();
        renderClassDropdown();
        renderStudents();
        renderClassList();
        markDirty();
    }
    function deleteClass(cName){
        if(checkIfUpdating()) return;
        let cCount=Object.keys(classes).length;
        if(cCount<=1){
            alert("åªå‰©æœ€å¾Œä¸€å€‹ç­ç´šï¼Œç„¡æ³•åˆªé™¤");
            return;
        }
        if(!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${cName}ã€?`))return;
        delete classes[cName];
        currentClass=Object.keys(classes)[0];
        saveClassesLocal();
        renderClassDropdown();
        renderStudents();
        renderClassList();
        markDirty();
    }

    // ä¿®æ”¹æ”¶é›†å·²ä¸Šå‚³åœ–ç‰‡çš„å‡½æ•¸
    async function collectUploadedImages() {
        uploadedImages.clear();

        // 1. å…ˆåŠ å…¥ç•¶å‰é é¢ä¸Šçš„åœ–ç‰‡
        Object.values(classes).forEach(students => {
            students.forEach(student => {
                if (student.customImage && student.customImageFileId) {
                    uploadedImages.add(JSON.stringify({
                        url: student.customImage,
                        id: student.customImageFileId,
                        name: 'ä½¿ç”¨ä¸­çš„åœ–ç‰‡'
                    }));
                }
            });
        });

        try {
            // 2. å¾ Google Drive å–å¾—æ‰€æœ‰åœ–ç‰‡
            const driveImages = await googleDrive.getAllImages();
            driveImages.forEach(img => {
                uploadedImages.add(JSON.stringify({
                    url: img.url,
                    id: img.id,
                    name: img.name
                }));
            });
        } catch(err) {
            console.error('å–å¾— Google Drive åœ–ç‰‡å¤±æ•—:', err);
        }
    }

    // ä¿®æ”¹é¡¯ç¤ºå·²ä¸Šå‚³åœ–ç‰‡çš„å‡½æ•¸
    function updateUploadedImagesSection() {
        const customImageUpload = document.querySelector('.custom-image-upload');
        
        // ç§»é™¤èˆŠçš„å·²ä¸Šå‚³åœ–ç‰‡å€åŸŸ
        const oldSection = document.querySelector('.uploaded-images-section');
        if (oldSection) {
            oldSection.remove();
        }

        // å¦‚æœæœ‰å·²ä¸Šå‚³çš„åœ–ç‰‡ï¼Œå»ºç«‹æ–°çš„å€åŸŸ
        if (uploadedImages.size > 0) {
            const section = document.createElement('div');
            section.className = 'uploaded-images-section';
            section.innerHTML = `
                <h4>é¸æ“‡å·²ä¸Šå‚³çš„åœ–ç‰‡</h4>
                <div class="uploaded-images-grid"></div>
            `;

            const grid = section.querySelector('.uploaded-images-grid');
            [...uploadedImages].forEach(imageInfo => {
                const { url, id, name } = JSON.parse(imageInfo);
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-container';
                imgContainer.innerHTML = `
                    <img src="${url}" alt="${name}" title="${name}">
                    <button class="image-delete-btn" title="åˆªé™¤åœ–ç‰‡">Ã—</button>
                    <div class="image-name">${name}</div>
                `;
                
                const img = imgContainer.querySelector('img');
                if (customImageData === url) {
                    img.classList.add('selected');
                }
                
                // åœ–ç‰‡é»æ“Šäº‹ä»¶
                img.onclick = () => {
                    document.querySelectorAll('.uploaded-images-grid img').forEach(img => {
                        img.classList.remove('selected');
                    });
                    document.querySelectorAll('.image-preview img').forEach(img => {
                        img.classList.remove('selected');
                    });
                    img.classList.add('selected');
                    
                    customImageData = url;
                    customImageFileId = id;
                    selectedImage = "";
                    
                    document.getElementById('customImagePreview').innerHTML = `
                        <img src="${url}" alt="${name}">
                        <button onclick="clearCustomImage()" style="display:block; margin:5px auto; background:#ff4d4d;">ç§»é™¤è‡ªè¨‚åœ–ç‰‡</button>
                    `;
                };

                // åˆªé™¤æŒ‰éˆ•é»æ“Šäº‹ä»¶
                const deleteBtn = imgContainer.querySelector('.image-delete-btn');
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();  // é˜²æ­¢è§¸ç™¼åœ–ç‰‡çš„é»æ“Šäº‹ä»¶
                    
                    // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦æ­£åœ¨ä½¿ç”¨ä¸­
                    let isInUse = false;
                    Object.values(classes).forEach(students => {
                        students.forEach(student => {
                            if (student.customImageFileId === id) {
                                isInUse = true;
                            }
                        });
                    });

                    if (isInUse) {
                        alert('æ­¤åœ–ç‰‡æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œç„¡æ³•åˆªé™¤');
                        return;
                    }

                    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µåœ–ç‰‡å—ï¼Ÿ')) return;

                    try {
                        await googleDrive.deleteFile(id);
                        
                        // å¦‚æœåˆªé™¤çš„æ˜¯ç›®å‰é¸ä¸­çš„åœ–ç‰‡ï¼Œæ¸…é™¤é è¦½
                        if (customImageFileId === id) {
                            clearCustomImage();
                        }
                        
                        // å¾é›†åˆä¸­ç§»é™¤
                        uploadedImages.delete(imageInfo);
                        
                        // é‡æ–°æ¸²æŸ“åœ–ç‰‡å€åŸŸ
                        updateUploadedImagesSection();
                    } catch (err) {
                        alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    }
                };
                
                grid.appendChild(imgContainer);
            });

            customImageUpload.appendChild(section);
        }
    }

    // æ–°å¢è¨­å®šè¦–çª—çš„ HTML
    function addSettingsPopup() {
        const overlay = document.createElement("div");
        overlay.id = "settingsOverlay";
        overlay.className = "overlay";
        
        const popup = document.createElement("div");
        popup.id = "settingsPopup";
        popup.className = "popup";
        popup.innerHTML = `
            <h3>åˆ†æ•¸æŒ‰éˆ•è¨­å®š</h3>
            <p>è«‹è¨­å®šå››å€‹æŒ‰éˆ•çš„åˆ†æ•¸å€¼ï¼š</p>
            <div style="display:flex; flex-direction:column; gap:10px; margin:15px 0;">
                <div>
                    <label>ç¬¬ä¸€å€‹æŒ‰éˆ•ï¼š</label>
                    <input type="number" id="btn1" value="${classes.scoreButtons[0]}">
                </div>
                <div>
                    <label>ç¬¬äºŒå€‹æŒ‰éˆ•ï¼š</label>
                    <input type="number" id="btn2" value="${classes.scoreButtons[1]}">
                </div>
                <div>
                    <label>ç¬¬ä¸‰å€‹æŒ‰éˆ•ï¼š</label>
                    <input type="number" id="btn3" value="${classes.scoreButtons[2]}">
                </div>
                <div>
                    <label>ç¬¬å››å€‹æŒ‰éˆ•ï¼š</label>
                    <input type="number" id="btn4" value="${classes.scoreButtons[3]}">
                </div>
            </div>
            <button onclick="saveScoreButtonsSettings()" style="background:#4caf50;">å„²å­˜</button>
            <button onclick="closeScoreButtonsSettings()" style="background:#757575;">å–æ¶ˆ</button>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(popup);
    }

    // é¡¯ç¤ºè¨­å®šè¦–çª—
    function showScoreButtonsSettings() {
        if(checkIfUpdating()) return;
        
        // å¦‚æœè¨­å®šè¦–çª—ä¸å­˜åœ¨ï¼Œå…ˆå»ºç«‹
        if (!document.getElementById("settingsOverlay")) {
            addSettingsPopup();
        }
        
        document.getElementById("settingsOverlay").classList.add("show");
        document.getElementById("settingsPopup").classList.add("show");
    }

    // é—œé–‰è¨­å®šè¦–çª—
    function closeScoreButtonsSettings() {
        document.getElementById("settingsOverlay").classList.remove("show");
        document.getElementById("settingsPopup").classList.remove("show");
    }

    // å„²å­˜è¨­å®š
    function saveScoreButtonsSettings() {
        if(checkIfUpdating()) return;
        
        const btn1 = parseInt(document.getElementById("btn1").value) || 0;
        const btn2 = parseInt(document.getElementById("btn2").value) || 0;
        const btn3 = parseInt(document.getElementById("btn3").value) || 0;
        const btn4 = parseInt(document.getElementById("btn4").value) || 0;
        
        classes.scoreButtons = [btn1, btn2, btn3, btn4];
        saveClassesLocal();
        renderStudents();
        closeScoreButtonsSettings();
        markDirty();
    }

    // å°‡æ–°å‡½æ•¸åŠ å…¥ window ç‰©ä»¶
    window.showScoreButtonsSettings = showScoreButtonsSettings;
    window.closeScoreButtonsSettings = closeScoreButtonsSettings;
    window.saveScoreButtonsSettings = saveScoreButtonsSettings;

    // è¼ªè½‰ç›¤ç›¸é—œè®Šæ•¸
    let wheelCanvas = null;
    let wheelCtx = null;
    let wheelRotation = 0;
    let isSpinning = false;
    let selectedStudents = new Set();
    let wheelAnimation = null;
    let isRewardWheel = false; // æ–°å¢ï¼šæ˜¯å¦ç‚ºçæ‡²è¼ªè½‰ç›¤
    let rewards = classes.rewards || ["çå‹µ", "æ‡²ç½°"]; // å¾ classes ä¸­è®€å–çæ‡²é …ç›®

    // è¼ªè½‰ç›¤è¦–çª—
    function showWheelPopup() {
        if(checkIfUpdating()) return;
        
        document.getElementById("wheelOverlay").classList.add("show");
        const wheelPopup = document.getElementById("wheelPopup");
        wheelPopup.classList.add("show");
        wheelPopup.classList.add("enlarged");
        
        // åˆå§‹åŒ–ç•«å¸ƒ
        wheelCanvas = document.getElementById("wheelCanvas");
        wheelCtx = wheelCanvas.getContext("2d");
        
        // è¨­ç½®ç•«å¸ƒå¤§å°
        wheelCanvas.width = 600;
        wheelCanvas.height = 600;
        
        // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
        document.getElementById("btnSpinWheel").addEventListener("click", startSpinning);
        document.getElementById("btnCloseWheel").addEventListener("click", closeWheelPopup);
        document.getElementById("btnResetWheel").addEventListener("click", resetSelectedStudents);
        document.getElementById("btnStudentWheel").addEventListener("click", () => switchWheelType(false));
        document.getElementById("btnRewardWheel").addEventListener("click", () => switchWheelType(true));
        document.getElementById("btnAddReward").addEventListener("click", addNewReward);
        
        // é»æ“Šè¼ªè½‰ç›¤æ™‚åœæ­¢è½‰å‹•
        wheelCanvas.addEventListener("click", () => {
            if (isSpinning) {
                isSpinning = false;
                if (wheelAnimation) {
                    cancelAnimationFrame(wheelAnimation);
                }
            }
        });
        
        // æ¸²æŸ“è¼ªè½‰ç›¤
        renderWheel();
        
        // æ›´æ–°å·²é¸åˆ—è¡¨
        updateSelectedList();
        
        // æ›´æ–°çæ‡²åˆ—è¡¨
        updateRewardList();
    }

    // ä¿®æ”¹ï¼šæ¸²æŸ“è¼ªè½‰ç›¤å‡½æ•¸
    function renderWheel() {
        const items = isRewardWheel ? rewards : getStudents();
        const noRepeat = document.getElementById("noRepeat")?.checked;
        const availableItems = noRepeat ? 
            (isRewardWheel ? items.filter(item => !selectedStudents.has(item)) : items.filter(s => !selectedStudents.has(s.name))) : 
            items;
        
        if (!wheelCanvas || !wheelCtx) {
            wheelCanvas = document.getElementById("wheelCanvas");
            wheelCtx = wheelCanvas.getContext("2d");
            if (!wheelCanvas || !wheelCtx) return;
        }

        if (availableItems.length === 0) {
            wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
            wheelCtx.fillStyle = "#f5f5f5";
            wheelCtx.beginPath();
            wheelCtx.arc(wheelCanvas.width/2, wheelCanvas.height/2, wheelCanvas.width/2 - 10, 0, Math.PI * 2);
            wheelCtx.fill();
            
            wheelCtx.fillStyle = "#666";
            wheelCtx.font = "24px Arial";
            wheelCtx.textAlign = "center";
            wheelCtx.textBaseline = "middle";
            wheelCtx.fillText("æ‰€æœ‰é …ç›®éƒ½å·²é¸é", wheelCanvas.width/2, wheelCanvas.height/2);
            return;
        }

        const centerX = wheelCanvas.width / 2;
        const centerY = wheelCanvas.height / 2;
        const radius = Math.min(centerX, centerY) - 10;
        const colors = ["#FF5733", "#33FF57", "#3357FF", "#F333FF", "#33FFF3", "#FF3333"];

        wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
        
        // ç¹ªè£½æ‰‡å½¢
        const angleStep = (Math.PI * 2) / availableItems.length;
        availableItems.forEach((item, index) => {
            const startAngle = index * angleStep + wheelRotation;
            const endAngle = (index + 1) * angleStep + wheelRotation;

            wheelCtx.beginPath();
            wheelCtx.moveTo(centerX, centerY);
            wheelCtx.arc(centerX, centerY, radius, startAngle, endAngle);
            wheelCtx.closePath();
            wheelCtx.fillStyle = colors[index % colors.length];
            wheelCtx.fill();
            wheelCtx.strokeStyle = "#fff";
            wheelCtx.lineWidth = 3;
            wheelCtx.stroke();

            // ç¹ªè£½æ–‡å­—
            wheelCtx.save();
            wheelCtx.translate(centerX, centerY);
            wheelCtx.rotate(startAngle + angleStep / 2);
            wheelCtx.textAlign = "right";
            wheelCtx.fillStyle = "#fff";
            wheelCtx.font = "18px Arial";
            wheelCtx.fillText(isRewardWheel ? item : item.name, radius - 30, 5);
            wheelCtx.restore();
        });
    }

    // ä¿®æ”¹ï¼šé—œé–‰è¼ªè½‰ç›¤
    function closeWheelPopup() {
        const wheelPopup = document.getElementById("wheelPopup");
        document.getElementById("wheelOverlay").classList.remove("show");
        wheelPopup.classList.remove("show");
        wheelPopup.classList.remove("enlarged");
        if (wheelAnimation) {
            cancelAnimationFrame(wheelAnimation);
        }
    }

    // åˆ‡æ›è¼ªè½‰ç›¤é¡å‹
    function switchWheelType(isReward) {
        isRewardWheel = isReward;
        document.getElementById("btnStudentWheel").classList.toggle("active", !isReward);
        document.getElementById("btnRewardWheel").classList.toggle("active", isReward);
        document.getElementById("wheelTitle").textContent = isReward ? "çæ‡²è¼ªè½‰ç›¤" : "å­¸ç”Ÿè¼ªè½‰ç›¤";
        document.getElementById("rewardControls").style.display = isReward ? "block" : "none";
        selectedStudents.clear();
        updateSelectedList();
        renderWheel();
    }

    // æ–°å¢çæ‡²é …ç›®
    function addNewReward() {
        const input = document.getElementById("newReward");
        const newReward = input.value.trim();
        
        if (newReward && !rewards.includes(newReward)) {
            rewards.unshift(newReward);
            classes.rewards = rewards; // ä¿å­˜åˆ° classes ç‰©ä»¶
            saveClassesLocal(); // ä¿å­˜åˆ° localStorage
            updateRewardList();
            renderWheel();
            input.value = "";
            markDirty(); // æ¨™è¨˜éœ€è¦åŒæ­¥
        }
    }

    // åˆªé™¤çæ‡²é …ç›®
    window.deleteReward = function(index) {
        if (rewards.length <= 2) {
            alert("è‡³å°‘éœ€è¦ä¿ç•™å…©å€‹çæ‡²é …ç›®ï¼");
            return;
        }
        rewards.splice(index, 1);
        classes.rewards = rewards; // ä¿å­˜åˆ° classes ç‰©ä»¶
        saveClassesLocal(); // ä¿å­˜åˆ° localStorage
        updateRewardList();
        renderWheel();
        markDirty(); // æ¨™è¨˜éœ€è¦åŒæ­¥
    };

    // æ›´æ–°çæ‡²åˆ—è¡¨
    function updateRewardList() {
        const rewardList = document.getElementById("rewardList");
        rewardList.innerHTML = "";
        
        rewards.forEach((reward, index) => {
            const div = document.createElement("div");
            div.className = "reward-item";
            div.innerHTML = `
                ${reward}
                <button onclick="deleteReward(${index})">Ã—</button>
            `;
            rewardList.appendChild(div);
        });
    }

    // æ›´æ–°å·²é¸åˆ—è¡¨
    function updateSelectedList() {
        const selectedList = document.getElementById("selectedList");
        selectedList.innerHTML = "";
        
        // å°‡ Set è½‰æ›ç‚ºé™£åˆ—ä¸¦åè½‰é †åºï¼Œé€™æ¨£æœ€æ–°çš„æœƒåœ¨æœ€å‰é¢
        const selectedArray = Array.from(selectedStudents).reverse();
        
        selectedArray.forEach((item, index) => {
            const li = document.createElement("li");
            if (isRewardWheel) {
                li.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${item}
                    </div>
                    <button onclick="removeSelectedStudent('${item}')">Ã—</button>
                `;
            } else {
                const student = getStudents().find(s => s.name === item);
                if (student) {
                    const imgSrc = student.customImage || imageMap[student.imageLabel] || "";
                    li.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="min-width: 25px; color: #666;">${selectedArray.length - index}.</span>
                            <img src="${imgSrc}" alt="${student.gender}" style="width: 30px; height: 30px; border-radius: 50%;">
                            ${item}
                        </div>
                        <button onclick="removeSelectedStudent('${item}')">Ã—</button>
                    `;
                }
            }
            selectedList.appendChild(li);
        });
    }

    // é–‹å§‹è½‰å‹•
    function startSpinning() {
        if (isSpinning) return;
        
        const items = isRewardWheel ? rewards : getStudents();
        const noRepeat = document.getElementById("noRepeat").checked;
        const availableItems = noRepeat ? 
            (isRewardWheel ? items.filter(item => !selectedStudents.has(item)) : items.filter(s => !selectedStudents.has(s.name))) : 
            items;
        
        if (availableItems.length === 0) {
            alert("æ‰€æœ‰é …ç›®éƒ½å·²é¸éï¼");
            return;
        }

        // éš±è—å…¶ä»–å…ƒç´ 
        document.querySelector('.wheel-type-switch').style.display = 'none';
        document.querySelector('.wheel-controls-container').style.display = 'none';
        document.querySelector('.selected-students').style.display = 'none';
        document.getElementById('rewardControls').style.display = 'none';
        document.getElementById('wheelTitle').style.display = 'none';

        // èª¿æ•´è¼ªè½‰ç›¤å®¹å™¨å¤§å°
        const wheelContainer = document.querySelector('.wheel-container');
        wheelContainer.style.width = '90vh';
        wheelContainer.style.height = '90vh';
        wheelCanvas.width = wheelContainer.clientWidth;
        wheelCanvas.height = wheelContainer.clientHeight;

        isSpinning = true;
        const spinDuration = 3000; // 3ç§’
        const startTime = Date.now();
        const startRotation = wheelRotation;
        const totalRotation = Math.PI * 8 + Math.random() * Math.PI * 2; // è‡³å°‘è½‰4åœˆ

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / spinDuration, 1);
            
            // ä½¿ç”¨ç·©å‹•å‡½æ•¸
            const easeOut = 1 - Math.pow(1 - progress, 3);
            wheelRotation = startRotation + totalRotation * easeOut;
            
            renderWheel();
            
            if (progress < 1) {
                wheelAnimation = requestAnimationFrame(animate);
            } else {
                isSpinning = false;
                // è¨ˆç®—é¸ä¸­çš„é …ç›®
                const angleStep = (Math.PI * 2) / availableItems.length;
                // èª¿æ•´è§’åº¦è¨ˆç®—ï¼Œè€ƒæ…®æŒ‡é‡åœ¨é ‚éƒ¨ï¼ˆ270åº¦ï¼‰çš„ä½ç½®
                const pointerAngle = Math.PI * 1.5; // 270åº¦
                let finalAngle = (-wheelRotation + pointerAngle) % (Math.PI * 2);
                if (finalAngle < 0) {
                    finalAngle += Math.PI * 2;
                }
                const selectedIndex = Math.floor(finalAngle / angleStep);
                const selectedItem = availableItems[selectedIndex];
                
                if (selectedItem) {
                    // åªæœ‰åœ¨å‹¾é¸ä¸é‡è¤‡æ™‚ï¼Œæ‰å°‡é …ç›®åŠ å…¥å·²é¸åå–®
                    if (noRepeat) {
                        selectedStudents.add(isRewardWheel ? selectedItem : selectedItem.name);
                        updateSelectedList();
                    }
                    
                    // å…ˆé¡¯ç¤ºé¸ä¸­çµæœ
                    alert(`é¸ä¸­ï¼š${isRewardWheel ? selectedItem : selectedItem.name}`);
                    
                    // æ¢å¾©å…¶ä»–å…ƒç´ çš„é¡¯ç¤º
                    document.querySelector('.wheel-type-switch').style.display = 'flex';
                    document.querySelector('.wheel-controls-container').style.display = 'flex';
                    document.querySelector('.selected-students').style.display = 'flex';
                    document.getElementById('rewardControls').style.display = isRewardWheel ? 'block' : 'none';
                    document.getElementById('wheelTitle').style.display = 'block';

                    // æ¢å¾©è¼ªè½‰ç›¤å®¹å™¨çš„åŸå§‹å¤§å°
                    const wheelContainer = document.querySelector('.wheel-container');
                    wheelContainer.style.width = '600px';
                    wheelContainer.style.height = '600px';
                    wheelCanvas.width = 600;
                    wheelCanvas.height = 600;

                    // ç¢ºä¿é‡æ–°æ¸²æŸ“è¼ªè½‰ç›¤
                    setTimeout(() => {
                        renderWheel();
                    }, 0);
                }
            }
        }

        animate();
    }

    // é‡ç½®å·²é¸åå–®
    function resetSelectedStudents() {
        selectedStudents.clear();
        updateSelectedList();
        renderWheel();
    }

    // ä½¿ç”¨èªªæ˜ç›¸é—œå‡½æ•¸
    function showHelpPopup() {
        if(checkIfUpdating()) return;
        document.getElementById("helpOverlay").classList.add("show");
        document.getElementById("helpPopup").classList.add("show");
    }

    function closeHelpPopup() {
        document.getElementById("helpOverlay").classList.remove("show");
        document.getElementById("helpPopup").classList.remove("show");
    }

    // å°‡æ–°å‡½æ•¸åŠ å…¥ window ç‰©ä»¶
    window.closeHelpPopup = closeHelpPopup;

    window.addEventListener("load", ()=>{
        // å¹«åŠ©è¦–çª—çš„æ¨™ç±¤åˆ‡æ›åŠŸèƒ½
        const tabBtns = document.querySelectorAll('.tab-btn');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active é¡åˆ¥
                tabBtns.forEach(b => b.classList.remove('active'));
                // ç‚ºç•¶å‰æŒ‰éˆ•æ·»åŠ  active é¡åˆ¥
                btn.classList.add('active');
                
                // éš±è—æ‰€æœ‰å…§å®¹
                const contents = document.querySelectorAll('.tab-content');
                contents.forEach(content => content.classList.remove('active'));
                
                // é¡¯ç¤ºå°æ‡‰çš„å…§å®¹
                const targetId = btn.dataset.tab === 'usage' ? 'usageContent' : 'versionContent';
                document.getElementById(targetId).classList.add('active');
            });
        });
    });

    // ç§»é™¤å·²é¸å­¸ç”Ÿ
    window.removeSelectedStudent = function(name) {
        selectedStudents.delete(name);
        updateSelectedList();
        renderWheel();
    };

    // å°‡è¼ªè½‰ç›¤ç›¸é—œå‡½æ•¸åŠ å…¥ window ç‰©ä»¶
    window.closeWheelPopup = closeWheelPopup;
    window.switchWheelType = switchWheelType;
    window.addNewReward = addNewReward;
</script>
</body>
</html>
