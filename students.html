<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>åœ‹å°å­¸å“¡åˆ†æ•¸ç®¡ç†</title>
    <!-- è¼‰å…¥ Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        h2 {
            margin: 20px 0 10px;
        }
        .top-controls {
            margin-bottom: 10px;
        }
        button {
            margin: 5px;
            padding: 8px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }
        /* å­¸ç”Ÿå¡ç‰‡åˆ—è¡¨ */
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding-bottom: 30px;
        }
        .student-card {
            width: 200px;
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            border-radius: 10px;
            background: white;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }
        .student-card img {
            width: 80px;
            height: 80px;
            cursor: pointer;
        }
        .btn-edit { background: #ffa500; color: white; }
        .btn-delete { background: #ff4d4d; color: white; }
        .btn-score { background: #4caf50; color: white; }
        .quickAdjust { margin-top: 5px; }
        .quickAdjust select, .quickAdjust input { margin-right: 5px; }
        /* é®ç½© & popup */
        .overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        .popup {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 10px; text-align: center; width: 320px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3); z-index: 20; opacity: 0; transition: opacity 0.3s;
        }
        .popup.show { display: block; opacity: 1; }
        .overlay.show { display: block; }
        .popup input, .popup select {
            width: 90%; margin-top: 10px; padding: 8px;
        }
        .image-preview {
            display: flex; justify-content: center; gap: 10px; margin-top: 10px;
        }
        .image-preview img {
            width: 50px; height: 50px; cursor: pointer; border: 2px solid transparent;
        }
        .image-preview img.selected { border: 2px solid blue; }
    </style>
</head>
<body>
<h2>åœ‹å°å­¸å“¡åˆ†æ•¸ç®¡ç†</h2>

<!-- Google ç™»å…¥ / ç™»å‡º -->
<button id="login-btn" onclick="signIn()">ç™»å…¥ Google</button>
<button id="logout-btn" onclick="signOut()" style="display: none;">ç™»å‡º</button>

<div class="top-controls">
    <button onclick="showPopup()">æ–°å¢å­¸ç”Ÿ</button>
    <button onclick="exportCSV()">åŒ¯å‡º CSV</button>
    <button onclick="saveToDrive()">å„²å­˜è‡³ Google Drive</button>
    <!-- åŒ¯å…¥ CSV -->
    <input type="file" id="importCSV" accept=".csv" onchange="importCSV(event)" />
</div>

<!-- é®ç½© -->
<div class="overlay" id="overlay" onclick="closePopup()"></div>

<!-- Popup è¦–çª— -->
<div class="popup" id="studentPopup">
    <h3 id="popupTitle">æ–°å¢å­¸ç”Ÿ</h3>
    <input type="text" id="studentName" placeholder="è¼¸å…¥å§“å" />
    <input type="number" id="studentScore" placeholder="è¼¸å…¥åˆ†æ•¸" min="0" />
    <select id="studentGender" onchange="updateImagePreview()">
        <option value="ç”·">ç”·ç”Ÿ</option>
        <option value="å¥³">å¥³ç”Ÿ</option>
    </select>
    <div class="image-preview" id="imageSelection"></div>
    <br />
    <button onclick="saveStudent()">å„²å­˜</button>
    <button onclick="closePopup()">å–æ¶ˆ</button>
</div>

<!-- å­¸ç”Ÿå¡ç‰‡å®¹å™¨ -->
<div class="container" id="studentContainer"></div>

<script>
    /** ===================
     *  1. Google OAuth èˆ‡ Drive åŒæ­¥è¨­å®š
     * =================== */
        // âœ… ä¿®æ”¹ç‚ºä½ çš„ Client ID
    const CLIENT_ID = "310618779783-ephi24bku6psi9c7c1babi0v1n7fu8u9.apps.googleusercontent.com";
    const API_KEY = "";  // è‹¥éœ€è¦å¯åŠ å…¥ï¼Œå¦å‰‡å¯ç•™ç©º
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    // ç‹€æ…‹
    let isGoogleSignedIn = false;

    // åˆå§‹åŒ–ï¼šè¼‰å…¥ Google API
    document.addEventListener("DOMContentLoaded", function() {
        gapi.load("client:auth2", initClient);
        renderStudents(); // å…ˆæ¸²æŸ“æœ¬åœ°è³‡æ–™
    });

    function initClient() {
        gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES
        }).then(() => {
            const authInstance = gapi.auth2.getAuthInstance();
            // ç›£è½ç™»å…¥ç‹€æ…‹
            authInstance.isSignedIn.listen(updateSigninStatus);
            // é è¨­åˆ¤æ–·æ˜¯å¦å·²ç™»å…¥
            updateSigninStatus(authInstance.isSignedIn.get());
        }).catch(err => {
            console.error("Google OAuth åˆå§‹åŒ–å¤±æ•—ï¼š", err);
        });
    }

    function updateSigninStatus(isSignedIn) {
        isGoogleSignedIn = isSignedIn;
        document.getElementById("login-btn").style.display = isSignedIn ? "none" : "block";
        document.getElementById("logout-btn").style.display = isSignedIn ? "block" : "none";

        if (isSignedIn) {
            console.log("âœ… Googleç™»å…¥æˆåŠŸ");
            loadStudentsFromDrive(); // å¾é›²ç«¯è¼‰å…¥
        } else {
            console.log("ğŸš« Googleæœªç™»å…¥ï¼Œä½¿ç”¨æœ¬åœ° LocalStorage");
            // å¦‚æœæœªç™»å…¥ï¼Œå°±ç”¨ localStorage è³‡æ–™
            students = JSON.parse(localStorage.getItem("students")) || [];
            renderStudents();
        }
    }

    function signIn() {
        gapi.auth2.getAuthInstance().signIn().then(() => {
            console.log("ğŸ‰ æˆåŠŸç™»å…¥ Google");
        }).catch(err => {
            console.error("âŒ Googleç™»å…¥å¤±æ•—", err);
        });
    }

    function signOut() {
        gapi.auth2.getAuthInstance().signOut().then(() => {
            console.log("ğŸŸ¡ å·²ç™»å‡º Google");
            document.getElementById("studentContainer").innerHTML = "";
        });
    }

    // è®€å–/å»ºç«‹ students.json
    function loadStudentsFromDrive() {
        gapi.client.drive.files.list({
            q: "name='students.json'",
            spaces: "drive",
            fields: "files(id, name)"
        }).then(response => {
            const files = response.result.files;
            if (files && files.length > 0) {
                const fileId = files[0].id;
                gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                }).then(res => {
                    // æŠŠè®€åˆ°çš„ JSON å­˜åˆ° students é™£åˆ—
                    students = JSON.parse(res.body) || [];
                    console.log("å¾ Google Drive è¼‰å…¥ï¼š", students);
                    saveToLocalStorage();
                    renderStudents();
                });
            } else {
                console.log("æœªæ‰¾åˆ° students.jsonï¼Œå‰µå»ºæ–°æ–‡ä»¶...");
                saveToDrive(); // å»ºç«‹ç©ºæª”æ¡ˆ
            }
        }).catch(err => {
            console.error("è®€å– Drive æª”æ¡ˆå¤±æ•—ï¼š", err);
        });
    }

    // å„²å­˜åˆ° Google Drive
    function saveToDrive() {
        if (!isGoogleSignedIn) {
            alert("è«‹å…ˆç™»å…¥ Google");
            return;
        }
        gapi.client.drive.files.list({
            q: "name='students.json'",
            spaces: "drive",
            fields: "files(id, name)"
        }).then(response => {
            const files = response.result.files;
            let fileId = files && files.length > 0 ? files[0].id : null;

            const fileMetadata = {
                name: 'students.json',
                mimeType: 'application/json'
            };
            const fileContent = new Blob([JSON.stringify(students)], { type: 'application/json' });
            const form = new FormData();
            form.append("metadata", new Blob([JSON.stringify(fileMetadata)], { type: "application/json" }));
            form.append("file", fileContent);

            // å¦‚æœå·²å­˜åœ¨å°± PATCHï¼Œå¦å‰‡ POST
            const url = fileId
                ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`
                : "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart";

            fetch(url, {
                method: fileId ? "PATCH" : "POST",
                headers: {
                    "Authorization": "Bearer " + gapi.auth.getToken().access_token
                },
                body: form
            })
                .then(res => res.json())
                .then(data => {
                    console.log("å·²å„²å­˜è‡³ Google Driveï¼š", data);
                })
                .catch(err => {
                    console.error("å„²å­˜åˆ° Drive å¤±æ•—ï¼š", err);
                });
        }).catch(err => {
            console.error("æŸ¥è©¢ Drive æª”æ¡ˆå¤±æ•—ï¼š", err);
        });
    }

    /** ===================
     *  2. å­¸ç”Ÿè³‡æ–™ç®¡ç† (UI + LocalStorage + CSV)
     * =================== */
    let students = JSON.parse(localStorage.getItem("students")) || [];
    let editIndex = -1;  // ç›®å‰æ˜¯å¦åœ¨ç·¨è¼¯æŸå€‹å­¸ç”Ÿ
    let selectedImage = ""; // ç›®å‰ popup ä¸­é¸æ“‡çš„ã€Œç”·1ã€ã€Œå¥³2ã€ç­‰

    // ä¾›é è¦½ç”¨
    let imageMap = {
        "ç”·1": "https://img.icons8.com/?size=100&id=oqlkrpDy3clZ&format=png&color=000000",
        "ç”·2": "https://img.icons8.com/?size=100&id=C3wj6TWvegSk&format=png&color=000000",
        "ç”·3": "https://img.icons8.com/?size=100&id=2lwL3N2H9Tbm&format=png&color=000000",
        "å¥³1": "https://img.icons8.com/?size=100&id=eNAHQgRxtqVv&format=png&color=000000",
        "å¥³2": "https://img.icons8.com/?size=100&id=DH9FJ32siusV&format=png&color=000000",
        "å¥³3": "https://img.icons8.com/?size=100&id=gvFfuFtdrY7s&format=png&color=000000"
    };
    let genderImageLabels = {
        "ç”·": ["ç”·1", "ç”·2", "ç”·3"],
        "å¥³": ["å¥³1", "å¥³2", "å¥³3"]
    };

    // ç›£è½ ESC -> é—œé–‰ Popup
    window.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
            closePopup();
        }
    });

    // é¡¯ç¤ºå­¸ç”Ÿåˆ—è¡¨
    function renderStudents() {
        let container = document.getElementById("studentContainer");
        container.innerHTML = "";
        students.forEach((student, index) => {
            let card = document.createElement("div");
            card.classList.add("student-card");
            let imgSrc = imageMap[student.imageLabel] || "";
            card.innerHTML = `
          <img src="${imgSrc}" alt="${student.gender}" onclick="editStudent(${index})">
          <p>${student.name}</p>
          <p id="score-${index}">${student.score} åˆ†</p>
          <button class="btn-score" onclick="updateScore(${index}, -5)">-5</button>
          <button class="btn-score" onclick="updateScore(${index}, -1)">-1</button>
          <button class="btn-score" onclick="updateScore(${index}, 1)">+1</button>
          <button class="btn-score" onclick="updateScore(${index}, 5)">+5</button>

          <!-- å¿«é€ŸåŠ æ¸›ä»»æ„æ•¸ -->
          <div class="quickAdjust">
            <select id="sign-${index}">
              <option value="+">+</option>
              <option value="-">-</option>
            </select>
            <input type="number" id="custom-${index}" placeholder="è‡ªè¨‚åˆ†æ•¸" style="width:60px;">
            <button onclick="customAdjust(${index})">ç¢ºå®š</button>
          </div>

          <br>
          <button class="btn-edit" onclick="editStudent(${index})">ç·¨è¼¯</button>
          <button class="btn-delete" onclick="deleteStudent(${index})">åˆªé™¤</button>
        `;
            container.appendChild(card);
        });
    }

    // é¡¯ç¤ºå½ˆå‡ºè¦–çª— (æ–°å¢ / ç·¨è¼¯)
    function showPopup(editIdx = -1) {
        editIndex = editIdx;
        document.getElementById("popupTitle").innerText =
            editIdx === -1 ? "æ–°å¢å­¸ç”Ÿ" : "ç·¨è¼¯å­¸ç”Ÿ";

        if (editIdx === -1) {
            // æ–°å¢
            document.getElementById("studentName").value = "";
            document.getElementById("studentScore").value = 0;
            document.getElementById("studentGender").value = "ç”·";
        } else {
            // ç·¨è¼¯
            document.getElementById("studentName").value = students[editIdx].name;
            document.getElementById("studentScore").value = students[editIdx].score;
            document.getElementById("studentGender").value = students[editIdx].gender;
        }

        // æ›´æ–°åœ–ç‰‡é è¦½å€
        updateImagePreview();

        // è‹¥åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œå°±é é¸ä¹‹å‰çš„ imageLabel
        if (editIdx !== -1) {
            selectedImage = students[editIdx].imageLabel; // ex: "ç”·2"
            setTimeout(() => {
                let previewImgs = document.querySelectorAll("#imageSelection img");
                previewImgs.forEach((imgEl) => {
                    let label = imgEl.getAttribute("data-label");
                    if (label === selectedImage) {
                        imgEl.classList.add("selected");
                    }
                });
            }, 0);
        }

        // é¡¯ç¤º popup
        document.getElementById("overlay").classList.add("show");
        document.getElementById("studentPopup").classList.add("show");
    }

    function closePopup() {
        document.getElementById("overlay").classList.remove("show");
        document.getElementById("studentPopup").classList.remove("show");
    }

    function editStudent(index) {
        showPopup(index);
    }

    // æ›´æ–°åœ–ç‰‡é è¦½ (æ ¹æ“šæ€§åˆ¥)
    function updateImagePreview() {
        let gender = document.getElementById("studentGender").value;
        let imageSelection = document.getElementById("imageSelection");
        imageSelection.innerHTML = "";
        selectedImage = "";

        let labels = genderImageLabels[gender];
        labels.forEach((label, idx) => {
            let img = document.createElement("img");
            img.src = imageMap[label];
            img.setAttribute("data-label", label);
            img.onclick = () => {
                document.querySelectorAll(".image-preview img")
                    .forEach(x => x.classList.remove("selected"));
                img.classList.add("selected");
                selectedImage = label;
            };
            // è‹¥æ˜¯æ–°å¢æ¨¡å¼ï¼Œé è¨­ç¬¬ä¸€å¼µ
            if (idx === 0 && editIndex === -1) {
                img.classList.add("selected");
                selectedImage = label;
            }
            imageSelection.appendChild(img);
        });
    }

    // å„²å­˜å­¸ç”Ÿ
    function saveStudent() {
        let name = document.getElementById("studentName").value.trim();
        let score = parseInt(document.getElementById("studentScore").value);
        let gender = document.getElementById("studentGender").value;

        if (name === "" || isNaN(score)) {
            alert("è«‹è¼¸å…¥æ­£ç¢ºçš„è³‡æ–™");
            return;
        }
        if (!selectedImage) {
            // æ²’é¸åœ–ç‰‡ -> é è¨­ç¬¬ä¸€å¼µ
            let labels = genderImageLabels[gender];
            selectedImage = labels[0];
        }

        if (editIndex === -1) {
            // æ–°å¢
            students.push({ name, score, gender, imageLabel: selectedImage });
        } else {
            // ç·¨è¼¯
            students[editIndex] = { name, score, gender, imageLabel: selectedImage };
        }
        saveToLocalStorage();
        closePopup();
        renderStudents();
        if (isGoogleSignedIn) saveToDrive(); // é †ä¾¿åŒæ­¥ Drive
    }

    // åˆªé™¤å­¸ç”Ÿ
    function deleteStudent(index) {
        if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ")) {
            students.splice(index, 1);
            saveToLocalStorage();
            renderStudents();
            if (isGoogleSignedIn) saveToDrive();
        }
    }

    // åˆ†æ•¸èª¿æ•´ (å›ºå®š)
    function updateScore(index, delta) {
        students[index].score += delta;
        saveToLocalStorage();
        document.getElementById(`score-${index}`).textContent = students[index].score + " åˆ†";
        if (isGoogleSignedIn) saveToDrive();
    }

    // åˆ†æ•¸èª¿æ•´ (è‡ªè¨‚)
    function customAdjust(index) {
        let signSelect = document.getElementById(`sign-${index}`);
        let customInput = document.getElementById(`custom-${index}`);
        let sign = signSelect.value; // "+" or "-"
        let val = parseInt(customInput.value) || 0;
        if (sign === "-") val = -val;

        students[index].score += val;
        saveToLocalStorage();
        document.getElementById(`score-${index}`).textContent = students[index].score + " åˆ†";
        customInput.value = "";
        if (isGoogleSignedIn) saveToDrive();
    }

    // åŒ¯å‡º CSV
    function exportCSV() {
        let csvContent = "å§“å,åˆ†æ•¸,æ€§åˆ¥,åœ–ç‰‡\n" +
            students.map(s => `${s.name},${s.score},${s.gender},${s.imageLabel}`).join("\n");
        let blob = new Blob([csvContent], { type: "text/csv" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "students.csv";
        a.click();
    }

    // åŒ¯å…¥ CSV
    function importCSV(event) {
        let file = event.target.files[0];
        if (!file) return;

        let reader = new FileReader();
        reader.onload = (e) => {
            let lines = e.target.result.split("\n").map(line => line.trim()).filter(line => line);
            lines.shift(); // å»æ‰æ¨™é ­
            let newStudents = [];
            lines.forEach(line => {
                let [name, score, gender, imageLabel] = line.split(",");
                score = parseInt(score) || 0;
                if (!imageLabel) {
                    let labels = genderImageLabels[gender] || ["ç”·1"];
                    imageLabel = labels[0];
                }
                newStudents.push({ name, score, gender, imageLabel });
            });
            students = newStudents;
            saveToLocalStorage();
            renderStudents();
            if (isGoogleSignedIn) saveToDrive();
        };
        reader.readAsText(file);
    }

    // å„²å­˜åˆ° localStorage
    function saveToLocalStorage() {
        localStorage.setItem("students", JSON.stringify(students));
    }
</script>
</body>
</html>
