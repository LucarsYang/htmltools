# 規格書：學生管理頁（students.html）

## 1. 介面概述
- **左側側邊欄**：包含登入/登出按鈕、班級切換、功能選單與同步狀態。側邊欄可折疊，收合後僅顯示圖示。
- **主內容區**：顯示頁面標題、操作提示，以及以卡片形式呈現的學生列表。
- **學生卡片**：每張卡片顯示頭像、姓名、分數，提供四組快捷加減分、自訂分數調整、扣分項目套用，以及檢視分數異動紀錄的按鈕。
- **彈窗**：提供登入、學生新增/編輯、班級管理、同步提示等互動視窗，皆使用遮罩 + 燈箱設計。

## 2. 功能需求
### 2.1 基本資料管理
1. **班級切換**：從側邊欄選單切換班級，列表同步更新。
2. **新增/編輯學生**：
   - 姓名、性別、初始分數必填。
   - 可選擇預設頭像或上傳自訂圖片（Google Drive）。
   - 自訂圖片需設定公開權限，並可重複使用或刪除（若未被使用）。
3. **刪除學生**：卡片右上角刪除鈕顯示確認對話框後移除資料。
4. **卡片拖曳排序**：支援重新排序並即時存檔。

### 2.2 分數管理
1. **快捷加減分**：四組自訂按鈕（預設為 -5、-1、+1、+5），可透過設定視窗調整。
2. **自訂分數**：輸入數值與正負號，點擊「確定」更新分數。
3. **CSV 匯入/匯出**：
   - 匯出格式：`姓名,分數,性別,預設圖片,自訂圖片ID`。
   - 匯入時若包含自訂圖片 ID，需登入 Google 帳號以取得公開縮圖。
4. **扣分項目套用**：
   - 每位學生卡片提供扣分項目下拉選單，從預先建立的項目套用分數變動。
   - 套用後會寫入學生的扣分歷程與分數異動紀錄，並即時更新畫面與儲存。
5. **分數異動紀錄**：
   - 點擊「查看分數異動紀錄」開啟燈箱，列出該生所有加減分事件（含手動調整、扣分項目）。
   - 提供類型（全部／僅扣分）、扣分項目、起訖日期等篩選器，可重新整理或清除條件。

### 2.3 扣分項目管理
1. **開啟方式**：透過側邊欄的「扣分項目管理」按鈕開啟燈箱，顯示目前可用的扣分項目清單。
2. **項目維護**：支援新增、編輯與刪除，名稱需為必填文字，分數需為 0 或負數並即時驗證。
3. **資料同步**：儲存後立即更新學生卡片上的扣分選單並寫入班級資料。

### 2.4 班級管理
1. **新增班級**：輸入名稱後建立新班級並自動切換。
2. **重新命名班級**：輸入新名稱並更新資料。
3. **刪除班級**：至少保留一個班級，刪除前顯示確認對話框。

### 2.5 Google Drive 同步
1. **登入與離線模式**：首次載入提供登入 / 離線選擇，登入後顯示 Google 帳戶操作。
2. **自動同步機制**：
   - 資料變動時標示「有異動」，並啟動 30 秒自動同步倒數。
   - 同步時顯示遮罩與狀態更新，完成後標示「已同步」。
3. **雲端資料檢測**：閒置 60 秒後檢查雲端資料，若發現差異提示使用者是否覆蓋本地資料。
4. **登入時效**：登入後背景會定期刷新 Google 存取權杖，確保至少 9 小時內不會因權杖過期被迫重新登入。

### 2.6 互動工具整合
1. **考試倒數計時器**：呼叫 `initExamTimer()` 以顯示倒數模組。
2. **輪轉盤**：載入 `wheel.js`，可在學生/獎懲模式間切換並維護不重複抽籤。

## 3. 資料結構
- 使用 localStorage 鍵 `classes` 儲存資料，結構如下：
```json
{
  "501": [
    {
      "name": "王小明",
      "score": 80,
      "gender": "男",
      "imageLabel": "男1",
      "customImage": null,
      "customImageFileId": null,
      "deductionHistory": [
        {
          "id": "h-1",
          "itemId": 3,
          "itemName": "遲到",
          "points": -2,
          "scoreAfter": 78,
          "appliedAt": "2024-01-01T08:00:00.000Z",
          "eventId": "se-10"
        }
      ]
    }
  ],
  "scoreButtons": [-5, -1, 1, 5],
  "rewards": ["獎勵", "懲罰"],
  "deductionItems": [
    { "id": 3, "name": "遲到", "points": -2 }
  ],
  "scoreEvents": [
    {
      "id": "se-10",
      "className": "501",
      "studentName": "王小明",
      "studentIndex": 0,
      "previousScore": 80,
      "delta": -2,
      "newScore": 78,
      "type": "deduction-item",
      "metadata": {
        "itemId": 3,
        "itemName": "遲到",
        "historyId": "h-1"
      },
      "performedAt": "2024-01-01T08:00:00.000Z"
    }
  ]
}
```
- `deductionHistory`：記錄個別學生的扣分紀錄，含對應的扣分項目、分數與事件 ID。
- `deductionItems`：全班共用的扣分項目清單，分數需為 0 或負值。
- `scoreEvents`：所有加減分事件的完整紀錄，供分數異動紀錄燈箱篩選與顯示使用。
- 匯入匯出時不可修改現有欄位順序，以免破壞舊資料。

## 4. 非功能性需求
1. **單檔使用**：開啟 `students.html` 即可使用，不需後端服務。
2. **響應式設計**：在桌面與平板/手機尺寸均須良好顯示。
3. **一致的視覺風格**：與倒數計時器、輪轉盤燈箱視覺一致，使用柔和陰影與圓角。
4. **可存取性**：主要互動元素具備 aria 標記，重要資訊使用 `aria-live` 宣告。

## 5. 測試建議
- 模擬 Google 登入成功 / 失敗流程。
- 驗證拖曳排序、快捷加減分、自訂加減分的資料是否正確寫入。
- 測試 CSV 匯入/匯出與自訂圖片維護流程。
- 確認扣分項目管理的新增、編輯、刪除能同步更新學生卡片的扣分選單。
- 測試分數異動紀錄燈箱的篩選條件（類型、項目、日期）與排序是否正確。
- 確認離線模式與登入後雲端同步狀態切換無誤。
