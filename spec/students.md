# 規格書：學生管理頁（students.html）

## 1. 介面概述
- **左側側邊欄**：頂部顯示同步狀態卡片，下方依序為「功能」、「設定」、「資料」三個群組。功能群組整合登入/登出控制、班級下拉選單與考試倒數計時器、輪轉盤等工具。側邊欄可折疊，收合後保留圖示導覽。
- **主內容區**：呈現頁面標題、提示文字與學生列表容器。
- **學生卡片**：顯示頭像、姓名、分數、四組快捷加減分按鈕、自訂分數調整區、扣分項目套用與「查看分數異動紀錄」按鈕。
- **分數異動紀錄浮層**：在全螢幕燈箱中列出指定學生的所有分數異動，可套用類型、扣分項目與日期區間濾鏡。
- **彈窗**：包含登入流程、學生新增/編輯、班級管理、同步提示等對話框，皆搭配遮罩顯示。

## 2. 功能需求
### 2.1 基本資料管理
1. **班級切換**：從側邊欄下拉選單切換班級，學生列表立即更新。
2. **新增/編輯學生**：
   - 姓名、性別、初始分數必填。
   - 可選預設頭像或上傳自訂圖片（透過 Google Drive）。
   - 自訂圖片需維持公開權限，可重複使用與刪除（未被使用時）。
3. **刪除學生**：卡片右上角刪除鈕顯示確認對話後移除資料。
4. **卡片拖曳排序**：支援重新排序並立即儲存。

### 2.2 分數管理
1. **快捷加減分**：四組自訂按鈕（預設為 -5、-1、+1、+5），可在設定視窗調整。
2. **自訂分數**：輸入數值與正負號後按「確定」更新分數。
3. **扣分項目**：可從設定維護扣分項目，在學生卡片選取後快速套用。
4. **分數異動紀錄**：
   - 每張卡片提供「查看分數異動紀錄」按鈕，開啟浮層列出所有加減分事件。
   - 預設顯示全部紀錄，可切換為僅顯示扣分，並進一步依扣分項目篩選。
   - 支援起訖日期篩選並提供總筆數摘要，紀錄依時間由新到舊排序。

### 2.3 班級管理
1. **新增班級**：輸入名稱後建立並自動切換。
2. **重新命名班級**：輸入新名稱更新資料。
3. **刪除班級**：至少保留一個班級，刪除前顯示確認對話框。

### 2.4 登入與同步
1. **登入要求**：頁面載入時顯示登入對話框，使用者必須登入 Google 帳號後才能使用所有功能。
2. **自動同步**：
   - 資料異動時標示「有異動」，啟動 30 秒自動同步倒數。
   - 同步期間顯示遮罩與狀態更新，完成後回復為「已同步」。
3. **雲端更新檢測**：閒置 60 秒後檢查雲端檔案，若偵測差異提示是否覆蓋本地資料。

### 2.5 互動工具整合
1. **考試倒數計時器**：呼叫 `initExamTimer()` 顯示倒數模組。
2. **輪轉盤**：載入 `wheel.js`，預設為獎懲輪轉盤模式，可切換學生輪轉盤並維持不重複抽籤。

### 2.6 資料記錄
1. **分數事件記錄**：所有會影響分數的操作（快捷按鈕、自訂調整、扣分項目、手動編輯等）皆寫入 `scoreEvents` 集合，包含前一次分數、異動值、最新分數、類型與時間戳記。
2. **扣分歷史整合**：舊版扣分紀錄會被轉換為分數事件並保留對應 `historyId` 與扣分項目資訊，以便在浮層中过濾與追蹤。
3. **資料同步**：當學生重新命名、排序或刪除時，相關的 `scoreEvents` 與 `deductionHistory` 會同步更新索引與姓名，確保紀錄對應正確。

## 3. 資料結構
- 使用 localStorage 鍵 `classes` 儲存資料，結構範例：
```json
{
  "501": [
    {
      "name": "王小明",
      "score": 80,
      "gender": "男",
      "imageLabel": "男1",
      "customImage": null,
      "customImageFileId": null,
      "deductionHistory": [
        {
          "id": "h-1",
          "itemName": "遲到",
          "points": -2,
          "scoreAfter": 78,
          "appliedAt": "2024-01-05T01:23:00.000Z",
          "eventId": "se-123"
        }
      ]
    }
  ],
  "scoreButtons": [-5, -1, 1, 5],
  "rewards": ["獎勵", "懲罰"],
  "deductionItems": [
    { "id": 1, "name": "遲到", "points": -2 }
  ],
  "scoreEvents": [
    {
      "id": "se-123",
      "className": "501",
      "studentName": "王小明",
      "studentIndex": 0,
      "previousScore": 80,
      "delta": -2,
      "newScore": 78,
      "type": "deduction-item",
      "metadata": {
        "itemId": 1,
        "itemName": "遲到",
        "historyId": "h-1"
      },
      "performedAt": "2024-01-05T01:23:00.000Z"
    }
  ]
}
```
- `scoreEvents` 為分析與異動紀錄的主要來源，匯入匯出時需保留欄位順序與鍵值。

## 4. 非功能性需求
1. **登入限制**：系統需在登入完成後才顯示主介面並允許操作。
2. **響應式設計**：在桌面與平板/手機尺寸均須良好顯示。
3. **一致視覺風格**：與倒數計時器、輪轉盤燈箱風格一致，使用柔和陰影與圓角。
4. **可存取性**：主要互動元素具備 aria 標記，重要資訊使用 `aria-live` 宣告。

## 5. 測試建議
- 模擬登入成功 / 失敗流程，確認未登入狀態下無法操作主功能。
- 驗證拖曳排序、快捷加減分、自訂調整與扣分項目套用後，`scoreEvents` 與學生分數是否同步更新。
- 測試分數異動紀錄浮層的類型、扣分項目與日期篩選是否正確運作。
- 驗證 CSV 匯入/匯出、自訂圖片維護及雲端同步流程。
- 確認自動同步倒數、同步狀態提示與雲端變更偵測皆能正確回饋。
